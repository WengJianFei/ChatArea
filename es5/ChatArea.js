!function(){function e(e,t,i){return(t=s(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function t(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */t=function(){return i};var e,i={},r=Object.prototype,n=r.hasOwnProperty,a=Object.defineProperty||function(e,t,i){e[t]=i.value},o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",c=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function d(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(e){d=function(e,t,i){return e[t]=i}}function u(e,t,i,r){var n=t&&t.prototype instanceof x?t:x,o=Object.create(n.prototype),s=new P(r||[]);return a(o,"_invoke",{value:A(e,i,s)}),o}function p(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}i.wrap=u;var f="suspendedStart",m="suspendedYield",v="executing",g="completed",y={};function x(){}function b(){}function E(){}var k={};d(k,s,(function(){return this}));var C=Object.getPrototypeOf,N=C&&C(C(O([])));N&&N!==r&&n.call(N,s)&&(k=N);var w=E.prototype=x.prototype=Object.create(k);function T(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function L(e,t){function i(r,a,o,s){var c=p(e[r],e,a);if("throw"!==c.type){var l=c.arg,d=l.value;return d&&"object"==h(d)&&n.call(d,"__await")?t.resolve(d.__await).then((function(e){i("next",e,o,s)}),(function(e){i("throw",e,o,s)})):t.resolve(d).then((function(e){l.value=e,o(l)}),(function(e){return i("throw",e,o,s)}))}s(c.arg)}var r;a(this,"_invoke",{value:function(e,n){function a(){return new t((function(t,r){i(e,n,t,r)}))}return r=r?r.then(a,a):a()}})}function A(t,i,r){var n=f;return function(a,o){if(n===v)throw Error("Generator is already running");if(n===g){if("throw"===a)throw o;return{value:e,done:!0}}for(r.method=a,r.arg=o;;){var s=r.delegate;if(s){var c=S(s,r);if(c){if(c===y)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===f)throw n=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=v;var l=p(t,i,r);if("normal"===l.type){if(n=r.done?g:m,l.arg===y)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(n=g,r.method="throw",r.arg=l.arg)}}}function S(t,i){var r=i.method,n=t.iterator[r];if(n===e)return i.delegate=null,"throw"===r&&t.iterator.return&&(i.method="return",i.arg=e,S(t,i),"throw"===i.method)||"return"!==r&&(i.method="throw",i.arg=new TypeError("The iterator does not provide a '"+r+"' method")),y;var a=p(n,t.iterator,i.arg);if("throw"===a.type)return i.method="throw",i.arg=a.arg,i.delegate=null,y;var o=a.arg;return o?o.done?(i[t.resultName]=o.value,i.next=t.nextLoc,"return"!==i.method&&(i.method="next",i.arg=e),i.delegate=null,y):o:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,y)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function M(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function O(t){if(t||""===t){var i=t[s];if(i)return i.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function i(){for(;++r<t.length;)if(n.call(t,r))return i.value=t[r],i.done=!1,i;return i.value=e,i.done=!0,i};return a.next=a}}throw new TypeError(h(t)+" is not iterable")}return b.prototype=E,a(w,"constructor",{value:E,configurable:!0}),a(E,"constructor",{value:b,configurable:!0}),b.displayName=d(E,l,"GeneratorFunction"),i.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},i.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,E):(e.__proto__=E,d(e,l,"GeneratorFunction")),e.prototype=Object.create(w),e},i.awrap=function(e){return{__await:e}},T(L.prototype),d(L.prototype,c,(function(){return this})),i.AsyncIterator=L,i.async=function(e,t,r,n,a){void 0===a&&(a=Promise);var o=new L(u(e,t,r,n),a);return i.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},T(w),d(w,l,"Generator"),d(w,s,(function(){return this})),d(w,"toString",(function(){return"[object Generator]"})),i.keys=function(e){var t=Object(e),i=[];for(var r in t)i.push(r);return i.reverse(),function e(){for(;i.length;){var r=i.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},i.values=O,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(M),!t)for(var i in this)"t"===i.charAt(0)&&n.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var i=this;function r(r,n){return s.type="throw",s.arg=t,i.next=r,n&&(i.method="next",i.arg=e),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),l=n.call(o,"finallyLoc");if(c&&l){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var r=this.tryEntries[i];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),M(i),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;M(i)}return n}}throw Error("illegal catch attempt")},delegateYield:function(t,i,r){return this.delegate={iterator:O(t),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=e),y}},i}function i(e,t,i,r,n,a,o){try{var s=e[a](o),c=s.value}catch(l){return void i(l)}s.done?t(c):Promise.resolve(c).then(r,n)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var o=e.apply(t,r);function s(e){i(o,n,a,s,c,"next",e)}function c(e){i(o,n,a,s,c,"throw",e)}s(void 0)}))}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,s(r.key),r)}}function o(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e){var t=function(e,t){if("object"!=h(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=h(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==h(t)?t:t+""}function c(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return l(e,t)}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,n=function(){};return{s:n,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==i.return||i.return()}finally{if(s)throw a}}}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function h(e){return h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h(e)}System.register([],(function(i,a){"use strict";return{execute:function(){var a=Object.defineProperty,s=function(e,t,i){return function(e,t,i){t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i}(e,"symbol"!=h(t)?t+"":t,i),i};!function(){var e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){var t,i=c(document.querySelectorAll('link[rel="modulepreload"]'));try{for(i.s();!(t=i.n()).done;){r(t.value)}}catch(n){i.e(n)}finally{i.f()}new MutationObserver((function(e){var t,i=c(e);try{for(i.s();!(t=i.n()).done;){var a=t.value;if("childList"===a.type){var o,s=c(a.addedNodes);try{for(s.s();!(o=s.n()).done;){var l=o.value;"LINK"===l.tagName&&"modulepreload"===l.rel&&r(l)}}catch(n){s.e(n)}finally{s.f()}}}}catch(n){i.e(n)}finally{i.f()}})).observe(document,{childList:!0,subtree:!0})}function r(e){if(!e.ep){e.ep=!0;var t=function(e){var t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}}();var l=function(){return o((function e(t){n(this,e),s(this,"richText"),s(this,"vnode"),s(this,"cursorIndex"),s(this,"cursorLeft"),s(this,"needCallSpace",!1),s(this,"pointEndIME"),s(this,"IME_KEY","​_"),this.richText=t,this.textInnerHtmlInit(),this.richText.focus()}),[{key:"textInnerHtmlInit",value:function(){var e=arguments.length>1?arguments[1]:void 0;if(arguments.length>0&&void 0!==arguments[0]&&arguments[0]||this.getNodeEmpty(this.richText)){this.richText.innerHTML="";var t=this.getGridElm();this.richText.appendChild(t);var i=t.children[0].children[0];e&&(i.innerHTML=e,i.setAttribute("data-set-empty","false"));var r=i.childNodes[0];this.restCursorPos(r,"\ufeff"===r.textContent?1:r.textContent.length)}}},{key:"onceCall",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";return new Promise((function(n){var a=t.createAtUserSpan(e);n(t.replaceRegContent(a,!0,i,r)||"")}))}},{key:"searchCall",value:function(e,t){var i=this;return new Promise((function(r){var n=i.createAtUserSpan(e);i.replaceRegContent(n,t),r()}))}},{key:"onceExternalCall",value:function(e){var t=this;return new Promise((function(i){var r=t.createAtUserSpan(e);i(t.replaceRegContent(r,!1,!0)||"")}))}},{key:"upDataNodeOrIndex",value:function(){var e,t,i,r=window.getSelection(),n=r.focusNode,a=r.focusOffset,o=r.anchorOffset,s=(null==n?void 0:n.parentNode)||void 0;!s||!s.getAttribute||"richInput"!==s.getAttribute("data-set-richType")||(null==(i=null==(t=null==(e=null==n?void 0:n.parentNode)?void 0:e.parentNode)?void 0:t.parentNode)?void 0:i.parentNode)!==this.richText||(this.vnode=n,this.cursorIndex=a,this.cursorLeft=o<a?o:a)}},{key:"showAt",value:function(){if(this.upDataNodeOrIndex(),!this.vnode||this.vnode.nodeType!==Node.TEXT_NODE)return!1;var e=(this.vnode.textContent||"").slice(0,this.cursorIndex),t=/@([^@\s]*)$/.exec(e);return t&&2===t.length&&"@"===e[e.length-1]}},{key:"getRangeRect",value:function(){var e=0,t=0,i=window.getSelection().getRangeAt(0).getClientRects()[0];return i&&(e=i.x,t=i.y),{x:e,y:t}}},{key:"createAtUserSpan",value:function(e){var t=document.createElement("span");return t.dataset.userId=String(e.id),t.className="at-user",t.contentEditable="false",t.textContent="@".concat(e.name).concat(this.needCallSpace?" ":""),this.createNewDom(t)}},{key:"createNewDom",value:function(e){var t=document.createElement("span");return t.className="chat-tag",t.setAttribute("contenteditable","false"),t.setAttribute("data-set-richType","chatTag"),e.className+=" chat-stat",t.appendChild(e),t}},{key:"restCursorPos",value:function(e,t){null==t?t="\ufeff"===e.textContent?1:0:t>e.textContent.length&&(t=e.textContent.length);var i=new Range;i.setStart(e,t),i.setEnd(e,t);var r=window.getSelection();r&&(this.vnode=e,this.cursorIndex=t,this.cursorLeft=t,r.removeAllRanges(),r.addRange(i))}},{key:"setCursorPos",value:function(e,t){var i=window.getSelection();if(!(i.rangeCount<=0)){var r=i.getRangeAt(0);r.setStart(e,t),r.collapse(!0),this.vnode=e,this.cursorIndex=t,this.cursorLeft=t}}},{key:"replaceRegContent",value:function(e){var t,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",a=this.vnode.textContent;0===(t="boolean"==typeof i?a.slice(0,i?this.cursorIndex-1:this.cursorIndex):a.slice(0,i-1)).length?(this.vnode.parentElement.setAttribute("data-set-empty",!0),this.vnode.textContent="\ufeff"):this.vnode.textContent=t;var o=n||a.slice(this.cursorIndex),s=this.vnode.parentNode.parentNode,c=s.nextSibling;c?s.parentNode.insertBefore(e,c):s.parentNode.appendChild(e);var l=e.previousSibling.childNodes[0],h=l.childNodes[1];h&&l.removeChild(h);var d=this.getGridElm(!0),u=d.childNodes[0];return!r&&o&&"\ufeff"!==o&&(u.setAttribute("data-set-empty","false"),u.innerHTML=o),r&&u.childNodes[1]&&u.removeChild(u.childNodes[1]),e.nextSibling?(u.childNodes[1]&&u.removeChild(u.childNodes[1]),s.parentNode.insertBefore(d,e.nextSibling)):s.parentNode.appendChild(d),this.restCursorPos(u.childNodes[0]),o}},{key:"switchRange",value:function(e){var t,i,r,n,a=window.getSelection(),o=a.focusNode,s=a.focusOffset;if(o.nodeType===Node.TEXT_NODE){var c=o.textContent.length,l=o.parentNode.parentNode;switch(e){case"ArrowLeft":if(s>0&&"\ufeff"!==o.textContent){n=s-1,r=o;break}var h=null==(t=null==l?void 0:l.previousSibling)?void 0:t.previousSibling;if(h)n=(r=h.childNodes[0].childNodes[0]).textContent.length;else{var d=l.parentNode.previousSibling;d&&(n=(r=d.lastChild.childNodes[0].childNodes[0]).textContent.length)}break;case"ArrowRight":if(s<c&&"\ufeff"!==o.textContent){n=s+1,r=o;break}var u=null==(i=null==l?void 0:l.nextSibling)?void 0:i.nextSibling;if(u)n="\ufeff"===(r=u.childNodes[0].childNodes[0]).textContent?1:0;else{var p=l.parentNode.nextSibling;p&&(n="\ufeff"===(r=p.childNodes[0].childNodes[0].childNodes[0]).textContent?1:0)}}}(n||0===n)&&this.restCursorPos(r,n)}},{key:"getGridElm",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=document.createElement("span");if(t.setAttribute("data-set-richType","richMark"),t.innerHTML='<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="true">\ufeff<br></span>',e)return t;var i=document.createElement("p");return i.className="chat-grid-wrap",i.setAttribute("data-set-richType","richBox"),i.appendChild(t),i}},{key:"updateGrid",value:function(){var e,t,i,r,n=window.getSelection(),a=n.focusNode,o=a.parentNode;switch(o.getAttribute("data-set-richType")){case"richAllBox":if(!(e=a.childNodes[n.focusOffset])||"chatTag"===e.getAttribute("data-set-richType")){var s=this.getGridElm(!0),c=s.children[0];e?(c.removeChild(c.childNodes[1]),a.insertBefore(s,e)):a.appendChild(s),this.restCursorPos(c.childNodes[0]);break}if("BR"===e.tagName){var l=this.getGridElm(!0),h=l.children[0];a.insertBefore(l,e),a.removeChild(e),this.restCursorPos(h.childNodes[0],h.childNodes[0].textContent.length)}break;case"richMark":var d=o.parentNode,u=Array.prototype.indexOf.call(d.childNodes,o);if(-1===u)break;if(0===u){var p=n.focusNode;p.setAttribute("data-set-empty","true"),p.innerHTML="\ufeff<br>",e=p.childNodes[0],this.restCursorPos(e,e.textContent.length);break}var f,m=o.previousSibling;"chatTag"===m.getAttribute("data-set-richType")?(f=m.previousSibling,d.removeChild(m),d.removeChild(o)):(f=o.previousSibling,d.removeChild(o)),"\ufeff"===(e=f.childNodes[0].childNodes[0]).textContent&&e.parentNode.appendChild(document.createElement("br")),this.restCursorPos(e,e.textContent.length);break;case"richInput":if(i=(r=o.parentNode).parentNode,this.getNodeEmpty(o)){o.setAttribute("data-set-empty","true"),i.childNodes[i.childNodes.length-1]===r&&(o.innerHTML="\ufeff<br>"),e=o.childNodes[0],this.restCursorPos(e,e.textContent.length);break}if("true"===String(o.getAttribute("data-set-empty"))){o.setAttribute("data-set-empty","false");var v=[],g=[];Array.prototype.forEach.call(o.childNodes,(function(e){e.nodeType===Node.TEXT_NODE&&-1!==e.textContent.indexOf("\ufeff")?g.push(e):"BR"===e.tagName&&v.push(e)})),v.forEach((function(e){o.removeChild(e)})),g.forEach((function(e){var t=e.textContent.indexOf("\ufeff"),i=new Range;i.setStart(e,e.textContent.indexOf("\ufeff")),i.setEnd(e,t+1),i.deleteContents()})),e=o.childNodes[0],this.restCursorPos(e,e.textContent.length)}if((t=o.parentNode.nextSibling)&&t.nodeType===Node.TEXT_NODE){var y=t.textContent,x=this.getGridElm(!0);x.childNodes[0].textContent=y,x.childNodes[0].setAttribute("data-set-empty","false"),t.parentNode.insertBefore(x,t),t.parentNode.removeChild(t),t=x}t&&"richMark"===t.getAttribute("data-set-richType")&&this.markMerge(o.parentNode,t)}}},{key:"getNodeEmpty",value:function(e){var t=new RegExp("^(​|<br>|\ufeff)+$");return!e.innerHTML||t.test(e.innerHTML)}},{key:"setWrap",value:function(){var e=window.getSelection(),t=e.focusNode,i=e.focusOffset;if(t.nodeType!==Node.TEXT_NODE){if(!t.getAttribute||"richInput"!==t.getAttribute("data-set-richType"))return;t=t.childNodes[0]}var r=t.textContent.slice(i),n=t.parentNode.parentNode,a=n.parentNode,o=Array.prototype.indexOf.call(a.childNodes,n),s=Array.prototype.slice.call(a.childNodes,o+1),c=this.getGridElm(),l=c.children[0].children[0].childNodes[0],h=1;(r||s.length>0)&&l.parentNode.removeChild(l.parentNode.childNodes[1]),r&&"\ufeff"!==r&&(t.textContent=t.textContent.slice(0,i),l.textContent=(l.textContent+r).replace(/\ufeff/i,(function(){return h--,""})),l.parentElement.setAttribute("data-set-empty","false")),s.forEach((function(e){a.removeChild(e),c.appendChild(e)}));var d=a.lastChild.childNodes[0],u=c.lastChild.childNodes[0];if(d.childNodes.length<=1){var p=d.childNodes[0];(!p.textContent||"\ufeff"===p.textContent)&&(d.innerHTML="\ufeff<br>",d.setAttribute("data-set-empty","true"))}if("richMark"!==u.parentElement.getAttribute("data-set-richType"))c.appendChild(this.getGridElm(!0));else if(u.childNodes.length<=1){var f=u.childNodes[0];(!f.textContent||"\ufeff"===f.textContent)&&(u.innerHTML="\ufeff<br>",u.setAttribute("data-set-empty","true"),l=c.children[0].children[0].childNodes[0])}a.nextSibling?this.richText.insertBefore(c,a.nextSibling):this.richText.appendChild(c),this.restCursorPos(l,"\ufeff"===l.textContent?1:h),this.viewIntoPoint()}},{key:"selectRegionMerge",value:function(){var e=window.getSelection();if(!(e.isCollapsed||e.rangeCount<=0)){var t=e.getRangeAt(0);if(t.startContainer.nodeType===Node.TEXT_NODE&&t.startContainer===t.endContainer){var i=t.startContainer;if(i.length===t.endOffset-t.startOffset){var r=i.parentNode,n=r.parentNode===r.parentNode.parentNode.lastChild;r.setAttribute("data-set-empty","true"),r.innerHTML="\ufeff".concat(n?"<br>":""),this.restCursorPos(r.childNodes[0])}else t.deleteContents()}else if(t.commonAncestorContainer&&"richBox"===t.commonAncestorContainer.getAttribute("data-set-richType")){var a=t.startContainer.nodeType===Node.TEXT_NODE?t.startContainer.parentNode.parentNode:t.startContainer,o=t.endContainer.nodeType===Node.TEXT_NODE?t.endContainer.parentNode.parentNode:t.endContainer;t.deleteContents(),a.getAttribute("data-set-richType")===o.getAttribute("data-set-richType")&&this.markMerge(a,o)}else if(t.commonAncestorContainer===t.startContainer&&t.startContainer===t.endContainer)this.textInnerHtmlInit(!0);else{var s=function(e){if(e.nodeType===Node.TEXT_NODE)return e.parentNode.parentNode.parentNode;switch(e.getAttribute("data-set-richType")){case"richInput":return e.parentNode.parentNode;case"richMark":return e.parentNode;case"richBox":return e;default:return null}},c=s(t.startContainer),l=s(t.endContainer);if(!c||!l)return;t.deleteContents(),this.gridMerge(c,l)}return!0}}},{key:"gridElmMerge",value:function(){var e=this,t=window.getSelection(),i=t.focusNode,r=t.focusOffset,n=t.isCollapsed;if(r>1||!n)return!1;var a=function t(i,r){return(i.parentNode===e.richText||i===i.parentNode.childNodes[0])&&(-1!==Array.prototype.indexOf.call(e.richText.childNodes,i)?i:!(r>=6)&&t(i.parentNode,r+1))}(i,0);if(!a||a===this.richText.childNodes[0]||1===r&&"false"===a.children[0].children[0].getAttribute("data-set-empty"))return!1;var o=a.previousSibling;return this.gridMerge(o,a),!0}},{key:"delMarkRule",value:function(){var e=window.getSelection(),t=e.focusNode,i=t.textContent,r=t.parentNode,n=r.parentNode,a=n.parentNode;if(!e.isCollapsed||"richInput"!==r.getAttribute("data-set-richType"))return!1;if(i&&1===i.length&&n!==a.childNodes[0]&&(0!==e.focusOffset||"\ufeff"===i)){if("\ufeff"===i){var o=n.previousSibling.previousSibling;a.removeChild(n.previousSibling),a.removeChild(n);var s=o.childNodes[0],c=s.childNodes[0];"\ufeff"===c.textContent&&o===a.lastChild&&s.appendChild(document.createElement("br")),this.restCursorPos(c,c.textContent.length)}else{r.innerHTML=n===a.lastChild?"\ufeff<br>":"\ufeff",r.setAttribute("data-set-empty","true");var l=r.childNodes[0];this.restCursorPos(l,1)}return!0}if(0===e.focusOffset){var h=r.parentNode,d=null==h?void 0:h.previousSibling;return!(!d||"chatTag"!==d.getAttribute("data-set-richType"))&&(this.delTag(d),!0)}}},{key:"setIMESelection",value:function(){var e=window.getSelection(),t=e.focusNode,i=t.parentNode.parentNode;"richMark"===((null==i?void 0:i.getAttribute("data-set-richType"))||"")&&(this.pointEndIME=e.focusOffset,t.textContent=t.textContent.slice(0,this.pointEndIME)+this.IME_KEY+t.textContent.slice(this.pointEndIME),this.restCursorPos(t,this.pointEndIME+this.IME_KEY.length))}},{key:"delMarkRuleIME",value:function(){var e=window.getSelection(),t=e.focusNode,i=t.parentNode,r=i.parentNode;if("richMark"===((null==r?void 0:r.getAttribute("data-set-richType"))||"")){this.pointEndIME=e.focusOffset;var n=new RegExp(this.IME_KEY.slice(0,-1),"g");if(t.textContent=t.textContent.replace(n,""),this.pointEndIME>this.IME_KEY.length-1&&"\ufeff"!==t.textContent){var a=this.pointEndIME-(this.IME_KEY.length-1);t.textContent=t.textContent.slice(0,a-1)+t.textContent.slice(a),this.setCursorPos(t,a-1)}else{if("false"===i.getAttribute("data-set-empty")&&(""===t.textContent||"\ufeff"===t.textContent)){i.innerHTML=r===r.parentElement.lastChild?"\ufeff<br>":"\ufeff",i.setAttribute("data-set-empty","true");var o=i.childNodes[0];return void this.setCursorPos(o,1)}var s=r.previousSibling;if(s&&s.getAttribute&&"chatTag"===s.getAttribute("data-set-richType"))return void this.delTag(s);var c=r.parentElement,l=c.previousElementSibling;l&&this.gridMerge(l,c)}}}},{key:"wrapIME",value:function(){var e=window.getSelection().focusNode;if(e.getAttribute&&"richBox"===e.getAttribute("data-set-richType")){var t=e.previousSibling.lastChild.children[0].childNodes[0];t.textContent=t.textContent.slice(0,-this.IME_KEY.length);var i=e.children[0];"BR"===i.tagName&&e.removeChild(i)}else{var r=e.parentNode.parentNode,n=(null==r?void 0:r.getAttribute("data-set-richType"))||"";if("richMark"===n){var a=r.parentElement.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length)}else if("richBox"===n){var o=r.previousSibling.lastChild.children[0].childNodes[0];o.textContent=o.textContent.slice(0,-this.IME_KEY.length)}}}},{key:"resetIME",value:function(e){" "===e&&(e=" "),e||(e="");var t=window.getSelection(),i=t.focusNode,r=i.parentNode.parentNode;"richMark"===((null==r?void 0:r.getAttribute("data-set-richType"))||"")&&(i.textContent=i.textContent.slice(0,t.focusOffset-this.IME_KEY.length-e.length)+e+i.textContent.slice(t.focusOffset),i.textContent=i.textContent.replace(/\u200b/g,""),this.setCursorPos(i,this.pointEndIME+e.length))}},{key:"delTag",value:function(e){var t=e.previousSibling,i=e.nextSibling;e.parentNode.removeChild(e),this.markMerge(t,i)}},{key:"gridMerge",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];"richMark"!==e.lastChild.getAttribute("data-set-richType")&&e.appendChild(this.getGridElm(!0)),"richMark"!==t.childNodes[0].getAttribute("data-set-richType")&&t.insertBefore(this.getGridElm(!0),t.childNodes[0]);var r=e.lastChild.childNodes[0],n=r.childNodes[0],a=n.textContent.length;Array.prototype.forEach.call(t.childNodes,(function(t){e.appendChild(t.cloneNode(!0))})),t.childNodes.length>1&&r.childNodes[1]&&r.removeChild(r.childNodes[1]);var o=r.parentNode.nextSibling;if(o){var s=o.children[0].childNodes[0];s&&"\ufeff"!==s.textContent&&(r.childNodes[1]&&r.removeChild(r.childNodes[1]),n.textContent=(n.textContent+s.textContent).replace(/\ufeff/i,(function(){return a--,""})),n.parentElement.setAttribute("data-set-empty","false")),e.removeChild(o)}if(""===n.textContent&&(n.textContent="\ufeff",n.parentNode.setAttribute("data-set-empty","true"),a=1),i){var c=e.childNodes[e.childNodes.length-1].childNodes[0].childNodes[0];this.restCursorPos(c,c.textContent.length)}else this.richText.removeChild(t),this.restCursorPos(n,a);this.viewIntoPoint()}},{key:"markMerge",value:function(e,t){var i=e.children[0].childNodes[0],r=i.textContent.length;if(t){var n=t.children[0].childNodes[0];n&&"\ufeff"!==n.textContent&&(i.textContent=(i.textContent+n.textContent).replace(/\ufeff/i,(function(){return r--,""})),i.parentElement.setAttribute("data-set-empty","false")),t.parentNode.removeChild(t)}""===i.textContent&&(i.textContent="\ufeff",i.parentNode.setAttribute("data-set-empty","true"),r=1);var a=e.parentNode;"\ufeff"===i.textContent&&e===a.lastChild&&(i.parentNode.appendChild(document.createElement("br")),i.parentNode.setAttribute("data-set-empty","true"),r=1),this.restCursorPos(i,r)}},{key:"setCallSpace",value:function(e){this.needCallSpace=e}},{key:"getWrapNode",value:function(e){if(e.nodeType===Node.TEXT_NODE)return e.parentNode.parentNode.parentNode;switch(e.getAttribute("data-set-richType")){case"richInput":return e.parentNode.parentNode;case"richMark":return e.parentNode;case"richBox":return e}}},{key:"getMarkNode",value:function(e){if(e.nodeType===Node.TEXT_NODE)return e.parentNode.parentNode;switch(e.getAttribute("data-set-richType")){case"richInput":return e.parentNode;case"richMark":return e}}},{key:"getRichTextNodeIndex",value:function(e){var t=this.getMarkNode(e),i=t.parentNode;return{gridIndex:Array.prototype.indexOf.call(this.richText.childNodes,i),markIndex:Array.prototype.indexOf.call(i.childNodes,t)}}},{key:"setWrapNodeByMark",value:function(e){var t=document.createElement("p");return t.className="chat-grid-wrap",t.setAttribute("data-set-richType","richBox"),Array.prototype.forEach.call(e,(function(e){t.appendChild(e)})),t}},{key:"setRangeLastText",value:function(){var e=this.richText.childNodes[this.richText.childNodes.length-1],t=e.childNodes[e.childNodes.length-1].children[0].childNodes[0];this.restCursorPos(t,"\ufeff"===t.textContent?1:t.textContent.length),this.viewIntoPoint()}},{key:"viewIntoPoint",value:function(){var e=window.getSelection();if(e.rangeCount>0){var t=e.getRangeAt(0).getBoundingClientRect(),i=this.richText.parentElement;i.scrollTop=t.top+i.scrollTop-i.clientHeight/2}}}])}(),d=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;return new Promise((function(t){setTimeout(t,e)}))},u=function(e,t,i,r){var n=Object.assign(Object.assign({},{precision:"first",continuous:!1,space:"ignore",lastPrecision:"start",insensitive:!0}),r||{});return n.insensitive&&(e=e.toLowerCase(),i=i.toLowerCase()),"ignore"===n.space&&(i=i.replace(/\s/g,"")),p(e,t,i,n)||[]},p=function(e,t,i,r){for(var n,a=[],o=function(){if("ignore"===r.space&&" "===e[s])return a.push(s),0;if(e[s]===i[0])return i=i.slice(1),a.push(s),0;var n=t.split(" "),o=0;return n.forEach((function(e){var t=f(e,i);t>o&&(o=t)})),o&&(i=i.slice(o),a.push(s)),i?void 0:1},s=0;s<e.length&&(0===(n=o())||1!==n);s++);if(i)return null;if(r.continuous){var c=a;if(a.some((function(e,t){return t>0&&e!==c[t-1]+1})))return null}return"ignore"===r.space&&(a=a.filter((function(t){return" "!==e[t]}))),a.length?a:null},f=function(e,t){for(var i=0,r=0;r<e.length;r++)e[r]===t[i]&&i++;return i};var m=function(e){return Object.prototype.toString.call(e).slice(8,-1)},v=function(e,t){var i=m(e).toLowerCase();switch(m(t)){case"String":return i===t.toLowerCase();case"Array":return t.some((function(e){return i===e.toLowerCase()}));default:return!0}},g=function(){return o((function e(i){var a=this,o=i.elm,c=i.userList,h=i.placeholder,u=i.copyType,p=i.uploadImage,f=i.needCallEvery,m=i.callEveryLabel,v=i.userProps,g=i.needCallSpace,y=i.wrapKeyFun,x=i.sendKeyFun,b=i.needDialog;if(n(this,e),s(this,"richText"),s(this,"needCallEvery",!0),s(this,"callEveryLabel","所有人"),s(this,"needDialog",!0),s(this,"placeholderElm"),s(this,"userProps",{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"}),s(this,"chat"),s(this,"targetUserList",[]),s(this,"userList",[]),s(this,"copyType",["text"]),s(this,"itemShowList",[]),s(this,"checkboxRows",[]),s(this,"base64Images",{}),s(this,"uploadImage"),s(this,"deviceInfo",function(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),n=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||n&&/(?:Tablet)/.test(e),o=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:o,isAndroid:r,isPc:!o&&!r&&!i}}()),s(this,"isComposition",!1),s(this,"historyOptionList",[]),s(this,"isExternalCallPopup",!1),s(this,"isIMEModel",!1),s(this,"wrapKeyFun",(function(e){return e.ctrlKey&&["Enter"].includes(e.key)})),s(this,"sendKeyFun",(function(e){return!e.ctrlKey&&["Enter"].includes(e.key)})),s(this,"startOpenIndex",0),s(this,"toolUserList"),s(this,"dialogElm"),s(this,"dialogCheckElm"),s(this,"dialogMainElm"),s(this,"checkboxElm"),s(this,"searchResultElm"),s(this,"checkGroupElm"),s(this,"searchElm"),s(this,"tagsElm"),s(this,"dialogActiveItemElm"),s(this,"searchEmptyLabel","没有匹配到任何结果"),s(this,"checkAllLabel","全选"),s(this,"dialogH5Elm"),s(this,"dialogH5MainElm"),s(this,"dialogH5CheckElm"),s(this,"dialogH5ShowElm"),s(this,"dialogH5SearchElm"),s(this,"winClick",(function(){a.getElmBlock(a.dialogElm)&&a.exitDialog(),a.searchResultElm&&a.domElmShow(a.searchResultElm)})),s(this,"winKeydown",function(){var e=r(t().mark((function e(i){var r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i.ctrlKey&&"KeyZ"===i.code&&i.preventDefault(),!a.getElmBlock(a.dialogElm)||0===a.itemShowList.length||a.isComposition){e.next=20;break}if("ArrowDown"!==i.code){e.next=4;break}return a.moveActiveItem("down"),e.abrupt("return");case 4:if("ArrowUp"!==i.code){e.next=7;break}return a.moveActiveItem("up"),e.abrupt("return");case 7:if("Enter"!==i.code&&"NumpadEnter"!==i.code||!a.dialogActiveItemElm){e.next=20;break}return i.preventDefault(),r=a.dialogActiveItemElm.getAttribute("data-set-id")||"",e.next=12,d(100);case 12:if(!(a.toolUserList&&a.toolUserList.length>0)){e.next=17;break}return e.next=15,a.chat.searchCall(a.userList.find((function(e){return e.id===r})),a.startOpenIndex);case 15:e.next=19;break;case 17:return e.next=19,a.onceSetTag("isALL"===r?{id:"isALL",name:a.callEveryLabel}:a.userList.find((function(e){return e.id===r})));case 19:a.exitDialog();case 20:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),!(o instanceof HTMLElement))throw new Error("参数值elm：参数类型错误, 参数类型应为HTMLElement！");["absolute","relative","fixed"].includes(o.style.position)||(o.style.position="relative"),o.className+=" chat-area-".concat(this.deviceInfo.isPc?"pc":"h5"),this.richText=document.createElement("div"),this.richText.setAttribute("class","chat-rich-text"),this.richText.setAttribute("data-set-richType","richAllBox"),this.richText.setAttribute("contenteditable","true"),o.appendChild(this.richText),this.placeholderElm=document.createElement("div"),this.placeholderElm.className="chat-placeholder-wrap",this.domElmShow(this.placeholderElm,!0),o.appendChild(this.placeholderElm),this.chat=new l(this.richText),m&&(this.callEveryLabel=m),void 0!==b&&(this.needDialog="false"!==String(b)),this.needDialog&&(this.deviceInfo.isPc?this.hasPc():this.hasH5()),this.registerEvent(),this.updateConfig({userList:c,placeholder:h,copyType:u,uploadImage:p,needCallEvery:f,needCallSpace:g,userProps:v,wrapKeyFun:y,sendKeyFun:x}),this.historyOptionList=[{html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex}]}),[{key:"registerEvent",value:function(){var e=this;this.richText.addEventListener("click",(function(t){e.chat.upDataNodeOrIndex()})),this.richText.addEventListener("keyup",(function(t){if(e.needDialog)if(t.stopPropagation(),e.deviceInfo.isPc)(50===t.keyCode||"Digit2"===t.code||"@"===t.key)&&e.userList.length>0&&e.chat.showAt()&&(e.startOpenIndex=e.chat.cursorIndex,e.showPCDialog());else{var i=!1;switch("Unidentified"===t.key?"android":"ios"){case"android":i=229===t.keyCode;break;case"ios":i=50===t.keyCode||"Digit2"===t.code||"@"===t.key}i&&e.userList.length>0&&e.chat.showAt()&&(e.showH5Dialog(),e.isExternalCallPopup=!1)}})),this.richText.addEventListener("keydown",function(){var i=r(t().mark((function i(r){return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.deviceInfo.isPc||"Unidentified"!==r.key||229!==r.keyCode){t.next=3;break}return r.preventDefault(),e.isIMEModel=!0,e.chat.setIMESelection(),t.abrupt("return");case 3:if(!e.isIMEModel){t.next=5;break}return t.abrupt("return");case 5:if(!e.getElmBlock(e.dialogElm)){t.next=8;break}return["ArrowUp","ArrowDown","Enter","NumpadEnter"].includes(r.code)?r.preventDefault():["ArrowLeft","ArrowRight"].includes(r.code)&&e.exitDialog(),t.abrupt("return");case 8:if("Backspace"!==r.code&&"Backspace"!==r.key){t.next=16;break}if(t.t0=e.chat.selectRegionMerge()||e.chat.gridElmMerge()||e.chat.delMarkRule(),!t.t0){t.next=14;break}return r.preventDefault(),t.next=14,e.richTextInput();case 14:t.next=31;break;case 16:if(!e.wrapKeyFun(r)&&(e.deviceInfo.isPc||"Enter"!==r.key)){t.next=23;break}return r.preventDefault(),e.chat.setWrap(),t.next=21,e.richTextInput();case 21:t.next=31;break;case 23:if(!e.sendKeyFun(r)){t.next=30;break}return r.preventDefault(),t.next=27,d(100);case 27:e.enterSend(),t.next=31;break;case 30:["ArrowLeft","ArrowRight"].includes(r.code)?(r.preventDefault(),e.chat.switchRange(r.code)):r.ctrlKey&&"KeyA"===r.code?e.isEmpty()&&r.preventDefault():r.ctrlKey&&"KeyZ"===r.code&&(r.preventDefault(),e.undo());case 31:-1===["Backspace","Shift","Tab","CapsLock","Control","Meta","Alt","ContextMenu","Enter","NumpadEnter","Escape","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Home","End","PageUp","PageDown","Insert","Delete","NumLock"].indexOf(r.key)&&!r.ctrlKey&&!r.altKey&&!r.metaKey&&e.chat.selectRegionMerge();case 32:case"end":return t.stop()}}),i)})));return function(e){return i.apply(this,arguments)}}()),this.richText.addEventListener("input",function(){var i=r(t().mark((function i(r){var n,a,o,s,c;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.isIMEModel){t.next=13;break}if(e.isIMEModel=!1,"deleteContentBackward"!==r.inputType){t.next=8;break}return t.next=5,d(50);case 5:e.chat.delMarkRuleIME(),t.next=9;break;case 8:"insertParagraph"===r.inputType?e.chat.wrapIME():e.chat.resetIME(r.data);case 9:return e.chat.upDataNodeOrIndex(),e.chat.updateGrid(),e.showPlaceholder(),t.abrupt("return");case 13:return t.next=15,e.richTextInput();case 15:if(!e.getElmBlock(e.dialogElm)||e.isComposition){t.next=27;break}if(n=e.chat.vnode.textContent,a=e.chat.cursorIndex,!(!n||/^([\u200b\ufeff])+$/.test(n)||a<e.startOpenIndex)){t.next=20;break}return e.exitDialog(),t.abrupt("return");case 20:if(o=n.slice(e.startOpenIndex,a+1),s=String(o||"").replace(/'/g,"")){t.next=24;break}return e.resizeUserTool(),e.showPCDialog(),t.abrupt("return");case 24:e.toolUserList||(e.toolUserList=e.userList),(c=e.searchUserList(s,e.toolUserList)).length>0?(e.updateUserList(c,!0),e.showPCDialog()):e.exitDialog();case 27:case"end":return t.stop()}}),i)})));return function(e){return i.apply(this,arguments)}}()),this.richText.addEventListener("copy",(function(t){t.preventDefault(),e.copyRange(t)})),this.richText.addEventListener("cut",(function(t){t.preventDefault(),e.copyRange(t),e.removeRange()})),this.richText.addEventListener("paste",(function(i){i.preventDefault();var n=i.clipboardData.getData("text/plain");if("string"==typeof n&&""!==n){if(-1===e.copyType.indexOf("text"))return;var a=document.createElement("div");a.innerHTML=i.clipboardData.getData("application/my-custom-format")||"",e.chat.selectRegionMerge(),a.children[0]&&"richBox"===a.children[0].getAttribute("data-set-richType")?e.insertInsideHtml(a.innerHTML):(a.innerHTML=n,e.insertText(a.innerText)),a=null}else{if(-1===e.copyType.indexOf("image"))return;var o=(i.clipboardData||i.originalEvent.clipboardData).items||[];Array.prototype.forEach.call(o,function(){var i=r(t().mark((function i(r){var n,a,o;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(-1!==r.type.indexOf("image")){t.next=2;break}return t.abrupt("return");case 2:if(n=r.getAsFile(),!e.uploadImage){t.next=10;break}return t.next=6,e.uploadImage(n);case 6:a=t.sent,e.insertHtml('<img class="chat-img" src="'.concat(a,'" alt="" />')),t.next=12;break;case 10:(o=new FileReader).onload=function(t){e.insertHtml('<img class="chat-img" src="'.concat(t.target.result,'" alt="" />'))},o.readAsDataURL(n);case 12:case"end":return t.stop()}}),i)})));return function(e){return i.apply(this,arguments)}}())}})),this.richText.addEventListener("blur",function(){var i=r(t().mark((function i(r){return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.chat.upDataNodeOrIndex();case 1:case"end":return t.stop()}}),i)})));return function(e){return i.apply(this,arguments)}}()),this.richText.addEventListener("focus",(function(t){e.chat.upDataNodeOrIndex()})),this.richText.addEventListener("dragstart",(function(e){e.stopPropagation(),e.preventDefault()})),this.richText.addEventListener("dragover",(function(e){e.stopPropagation(),e.preventDefault()})),this.richText.addEventListener("drop",(function(e){e.stopPropagation(),e.preventDefault()})),this.richText.addEventListener("compositionstart",(function(){e.isComposition=!0})),this.richText.addEventListener("compositionend",(function(){e.isComposition=!1}))}},{key:"richTextInput",value:(p=r(t().mark((function e(){var i,r,n,a,o,s=arguments;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=!(s.length>0&&void 0!==s[0])||s[0],this.chat.upDataNodeOrIndex(),this.deviceInfo.isPc&&this.chat.selectRegionMerge(),e.next=5,d(50);case 5:if(this.isComposition||this.chat.updateGrid(),(r=(this.richText.children[0]||{childNodes:[]}).childNodes[0])&&r.getAttribute&&"richMark"===r.getAttribute("data-set-richType")){e.next=10;break}return this.chat.textInnerHtmlInit(!0),this.showPlaceholder(),e.abrupt("return");case 10:this.showPlaceholder(),i&&!this.isComposition&&(n=this.chat.getRichTextNodeIndex(this.chat.vnode),a=n.gridIndex,o=n.markIndex,this.historyOptionList.push({html:this.richText.innerHTML,gridIndex:a,markIndex:o,cursorIndex:this.chat.cursorIndex}),this.historyOptionList.length>50&&this.historyOptionList.shift());case 11:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"copyRange",value:function(e){var t=window.getSelection();if(t.isCollapsed||t.rangeCount<=0)return e.clipboardData.setData("application/my-custom-format",""),void e.clipboardData.setData("text/plain","");var i=t.toString()||"",r=document.createElement("div");r.innerHTML=i;var n=r.innerText.replace(/\n\n/g,"\n");r=null,e.clipboardData.setData("text/plain",n);var a=t.anchorNode,o=t.focusNode;if(a!==o||a.nodeType!==Node.TEXT_NODE)if(a!==this.richText||o!==this.richText){var s=this.chat.getWrapNode(a),c=this.chat.getWrapNode(o),l=this.chat.getMarkNode(a),h=this.chat.getMarkNode(o),d=Array.prototype.indexOf.call(s.childNodes,l),u=Array.prototype.indexOf.call(c.childNodes,h);if(s===c&&s.parentNode===this.richText){var p=d>u,f=Array.prototype.filter.call(s.childNodes,(function(e,t){return p?t<d&&t>u:t>d&&t<u})).map((function(e){return e.cloneNode(!0)})),m=p?a.textContent.slice(0,t.anchorOffset):a.textContent.slice(t.anchorOffset),v=p?o.textContent.slice(t.focusOffset):o.textContent.slice(0,t.focusOffset),g=this.chat.getGridElm(!0),y=this.chat.getGridElm(!0);m&&(g.childNodes[0].innerHTML=m,g.childNodes[0].setAttribute("data-set-empty","false")),v&&(y.childNodes[0].innerHTML=v,y.childNodes[0].setAttribute("data-set-empty","false")),p?(f.unshift(y),f.push(g)):(f.unshift(g),f.push(y));var x=document.createElement("div"),b=this.chat.setWrapNodeByMark(f);return x.appendChild(b),e.clipboardData.setData("application/my-custom-format",x.innerHTML),void(x=null)}if(s.parentNode===this.richText&&c.parentNode===this.richText){var E=Array.prototype.indexOf.call(this.richText.childNodes,s),k=Array.prototype.indexOf.call(this.richText.childNodes,c),C=E>k,N=Array.prototype.filter.call(this.richText.childNodes,(function(e,t){return C?t<E&&t>k:t>E&&t<k})).map((function(e){return e.cloneNode(!0)})),w=C?a.textContent.slice(0,t.anchorOffset):a.textContent.slice(t.anchorOffset),T=C?o.textContent.slice(t.focusOffset):o.textContent.slice(0,t.focusOffset),L=this.chat.getGridElm(!0),A=this.chat.getGridElm(!0);w&&(L.childNodes[0].innerHTML=w,L.childNodes[0].setAttribute("data-set-empty","false")),T&&(A.childNodes[0].innerHTML=T,A.childNodes[0].setAttribute("data-set-empty","false"));var S=Array.prototype.filter.call(s.childNodes,(function(e,t){return C?t<d:t>d})).map((function(e){return e.cloneNode(!0)})),I=Array.prototype.filter.call(c.childNodes,(function(e,t){return C?t>u:t<u})).map((function(e){return e.cloneNode(!0)}));if(C){S.push(L),I.unshift(A);var M=this.chat.setWrapNodeByMark(S),P=this.chat.setWrapNodeByMark(I);N.push(M),N.unshift(P)}else{S.unshift(L),I.push(A);var O=this.chat.setWrapNodeByMark(S),H=this.chat.setWrapNodeByMark(I);N.unshift(O),N.push(H)}var D=document.createElement("div");return Array.prototype.forEach.call(N,(function(e){D.appendChild(e)})),e.clipboardData.setData("application/my-custom-format",D.innerHTML),void(D=null)}}else e.clipboardData.setData("application/my-custom-format",this.richText.innerHTML);else{var R=a.textContent.slice(t.anchorOffset,t.focusOffset);e.clipboardData.setData("application/my-custom-format",R)}}},{key:"removeRange",value:(h=r(t().mark((function e(){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return window.getSelection().getRangeAt(0).deleteContents(),e.next=3,d(50);case 3:this.chat.updateGrid(),this.showPlaceholder();case 5:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"updateUserList",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=arguments.length>1?arguments[1]:void 0;e&&(this.userList=this.getRuleUserList(e)),t||(this.base64Images={}),this.needDialog&&(this.deviceInfo.isPc?this.updatePCUser():this.updateH5User())}},{key:"getRuleUserList",value:function(e){var t=this;if(!v(e,"Array"))throw new Error("参数值userList：类型值应为Array！");this.targetUserList=JSON.parse(JSON.stringify(e||[]));var i=Object.create(null);return i[this.userProps.id]="isALL",i[this.userProps.name]=this.callEveryLabel,this.targetUserList.unshift(i),(null==e?void 0:e.map((function(e,i){var r=e[t.userProps.id];if(!r&&0!==r)throw new Error("参数值userList：下标第".concat(i,"项").concat(t.userProps.id,"值异常！"));return e.name=String(e[t.userProps.name]||""),e.pinyin=String(e[t.userProps.pinyin]||""),e.id=String(r),e.avatar=String(e[t.userProps.avatar]||""),e})))||[]}},{key:"getElmBlock",value:function(e){return e&&"block"===e.style.display}},{key:"domElmShow",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e&&(e.className=e.className.replace(/ chat-view-show| chat-view-hidden/g,""),t?(e.style.display="block",e.className+=" chat-view-show"):e.style.display="none")}},{key:"getUserHtmlTemplate",value:function(e,t){var i=this,r=document.createElement("span");if(r.setAttribute("class","call-user-dialog-item-sculpture ".concat(t.avatar?"is-avatar":"")),t.avatar){var n=new Image;n.alt="";var a=this.base64Images[t.id];a?n.src=a:(n.src=String(t.avatar),n.setAttribute("crossOrigin","Anonymous"),n.onload=function(){var e=document.createElement("canvas");e.width=48,e.height=48;var r=e.getContext("2d");r&&(r.drawImage(n,0,0,e.width,e.height),i.base64Images[t.id]=e.toDataURL("image/png",1))}),r.appendChild(n)}else r.innerHTML='<span style="transform: scale(0.75)">'.concat(t.name.slice(-2),"</span>");e.appendChild(r);var o=document.createElement("span");o.setAttribute("class","call-user-dialog-item-name"),o.innerHTML=t.name,e.appendChild(o)}},{key:"hasPc",value:function(){this.initCheckbox(),this.initCallUser(),window.addEventListener("click",this.winClick),window.addEventListener("keydown",this.winKeydown)}},{key:"initCheckbox",value:function(){var e=this;this.checkboxElm=document.createElement("div"),this.checkboxElm.setAttribute("class","checkbox-dialog"),this.domElmShow(this.checkboxElm),this.checkboxElm.innerHTML='\n      <div class="checkbox-dialog-container">\n        <div class="checkbox-dialog-container-header">\n            <span>选择要@的人</span>\n            <span class="checkbox-dialog-container-header-close">⛌</span>\n        </div>\n        <div class="checkbox-dialog-container-body">\n            <div class="checkbox-dialog-left-box">\n                <div class="checkbox-dialog-search">\n                    <input class="checkbox-dialog-search-input" placeholder="搜索人员名称" type="text">\n\n                    <div data-set-remark="搜索下拉" class="checkbox-dialog-search-group"></div>\n                </div>\n\n                <div data-set-remark="反显选取的人员" class="checkbox-dialog-tags"></div>\n\n                <div class="checkbox-dialog-option">\n                    <button class="checkbox-dialog-option-btn btn-submit">确定</button>\n                    <button class="checkbox-dialog-option-btn btn-close">取消</button>\n                </div>\n            </div>\n            \n            <div class="checkbox-dialog-right-box">\n                <div class="checkbox-dialog-right-box-title">研讨成员列表</div>\n\n                <div data-set-remark="多选人员列表" class="checkbox-dialog-check-group"></div>\n            </div>\n        </div>\n      </div>\n    ',document.body.appendChild(this.checkboxElm),this.checkGroupElm=this.checkboxElm.querySelector(".checkbox-dialog-check-group"),this.searchResultElm=this.checkboxElm.querySelector(".checkbox-dialog-search-group"),this.searchElm=this.checkboxElm.querySelector(".checkbox-dialog-search-input"),this.tagsElm=this.checkboxElm.querySelector(".checkbox-dialog-tags");var i=function(){e.domElmShow(e.checkboxElm),e.isExternalCallPopup=!1},n=this.checkboxElm.querySelector(".checkbox-dialog-container-header-close"),a=this.checkboxElm.querySelector(".btn-close");n.onclick=i,a.onclick=i,this.checkboxElm.querySelector(".btn-submit").onclick=r(t().mark((function r(){return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.batchSetTag(e.checkboxRows);case 2:return i(),e.chat.viewIntoPoint(),t.next=6,e.richTextInput();case 6:case"end":return t.stop()}}),r)}))),this.domElmShow(this.searchResultElm),this.searchResultElm.onclick=function(e){e.stopPropagation()},this.searchElm.onclick=function(e){e.stopPropagation()},this.searchElm.oninput=function(t){e.searchResultElm.innerHTML="";var i=String(t.target.value||"").replace(/'/g,"");if(i){var r=e.searchUserList(i),n=document.createDocumentFragment();if(r.forEach((function(t){var i=document.createElement("div");i.setAttribute("class","checkbox-dialog-check-item"),i.setAttribute("data-set-value",t.id);var r=document.createElement("div");r.setAttribute("class","checkbox-dialog-check-item-label"),e.getUserHtmlTemplate(r,t),i.appendChild(r),i.onclick=function(){e.domElmShow(e.searchResultElm);var t=i.getAttribute("data-set-value")||"";if(e.searchElm.value="",!e.checkboxRows.some((function(e){return e.id===t}))){var r=e.userList.find((function(e){return e.id===t}));r&&e.checkboxRows.push(r),Array.prototype.some.call(e.checkGroupElm.children,(function(i,r){return 0===r&&e.checkboxRows.length===e.userList.length?(i.className+=" checkbox-dialog-check-item-check",!1):i.getAttribute("data-set-value")===t?(i.className+=" checkbox-dialog-check-item-check",!0):void 0})),e.updateTags()}},n.appendChild(i)})),!r.length){var a=document.createElement("div");a.setAttribute("class","checkbox-dialog-search-empty"),a.innerText=e.searchEmptyLabel,n.appendChild(a)}e.searchResultElm.appendChild(n),e.domElmShow(e.searchResultElm,!0)}else e.domElmShow(e.searchResultElm)}}},{key:"searchUserList",value:function(e,t){return(t||this.userList).filter((function(t){return u(t.name,t.pinyin||"",e).length>0}))}},{key:"updateTags",value:function(){var e=this,t=this.checkboxRows.map((function(e){return e.id})),i=[],r=[];Array.prototype.forEach.call(this.tagsElm.children,(function(e){var n=e.getAttribute("data-set-value");-1===t.indexOf(n)?r.push(e):i.push(n)})),r.forEach((function(t){e.tagsElm.removeChild(t)}));var n=this.checkboxRows.filter((function(e){return-1===i.indexOf(e.id)}));if(n.length){var a=document.createDocumentFragment();n.forEach((function(t){var i=document.createElement("div");i.setAttribute("class","checkbox-dialog-tag-item"),i.setAttribute("data-set-value",t.id),i.innerHTML="\n        <span>".concat(t.name,"</span>\n      ");var r=document.createElement("span");r.setAttribute("class","checkbox-dialog-tag-item-close"),r.innerHTML="⛌",r.onclick=function(){var t=i.getAttribute("data-set-value");e.checkboxRows=e.checkboxRows.filter((function(e){return e.id!==t})),e.tagsElm.removeChild(i),Array.prototype.some.call(e.checkGroupElm.children,(function(e,i){return 0===i?(e.className=e.className.replace(/ checkbox-dialog-check-item-check/g,""),!1):e.getAttribute("data-set-value")===t?(e.className=e.className.replace(/ checkbox-dialog-check-item-check/g,""),!0):void 0}))},i.appendChild(r),a.appendChild(i)})),this.tagsElm.appendChild(a)}}},{key:"initCallUser",value:function(){var e=this;this.dialogElm=document.createElement("div"),this.dialogElm.setAttribute("class","call-user-dialog"),this.domElmShow(this.dialogElm);var t=document.createElement("div");t.setAttribute("class","call-user-dialog-header"),t.innerHTML='\n        <span class="call-user-dialog-header-title">群成员</span>\n    ',this.dialogCheckElm=document.createElement("span"),this.dialogCheckElm.setAttribute("class","call-user-dialog-header-check"),this.domElmShow(this.dialogCheckElm,this.userList.length>0),this.dialogCheckElm.innerText="多选",this.dialogCheckElm.onclick=function(){e.showPCCheckDialog(),e.isExternalCallPopup=!1},t.appendChild(this.dialogCheckElm),this.dialogElm.appendChild(t),this.dialogMainElm=document.createElement("div"),this.dialogMainElm.setAttribute("class","call-user-dialog-main"),this.dialogElm.appendChild(this.dialogMainElm),this.updateUserList();var i=document.createElement("div");i.setAttribute("class","call-user-dialog-footer"),this.dialogElm.appendChild(i),document.body.appendChild(this.dialogElm)}},{key:"resizeUserTool",value:function(){this.toolUserList&&(this.userList=this.toolUserList),this.toolUserList=void 0,this.updateUserList(this.userList,!0)}},{key:"updatePCUser",value:function(){var e=this;this.dialogMainElm.innerHTML="",this.dialogActiveItemElm=void 0;var t=this.userList&&this.userList.length>0,i=document.createDocumentFragment();if(this.domElmShow(this.dialogCheckElm),!this.toolUserList&&t&&(this.domElmShow(this.dialogCheckElm,!0),this.needCallEvery)){var r=document.createElement("div");r.setAttribute("class","call-user-dialog-item"),r.setAttribute("data-set-id","isALL"),this.userSelectStyleAndEvent(r,{id:"isALL",name:this.callEveryLabel}),r.innerHTML='\n          <span class="call-user-dialog-item-sculpture">\n            <span style="transform: scale(0.75)">@</span>\n          </span>\n          <span class="call-user-dialog-item-name">'.concat(this.callEveryLabel,"(").concat(this.userList.length,")</span>\n      "),i.appendChild(r)}this.userList.forEach((function(t){var r=document.createElement("div");r.setAttribute("class","call-user-dialog-item"),r.setAttribute("data-set-id",t.id),e.userSelectStyleAndEvent(r,t),e.getUserHtmlTemplate(r,t),i.appendChild(r)})),this.dialogMainElm.appendChild(i),this.callUserDialogMap(),this.checkGroupElm.innerHTML='\n                    <div class="checkbox-dialog-check-item" data-set-value="ALL">\n                        <input type="checkbox" value>\n                        <span class="checkbox-dialog-check-item-inner"></span>\n                        <div class="checkbox-dialog-check-item-label">'.concat(this.checkAllLabel,"</div>\n                    </div>");var n=document.createDocumentFragment();this.userList.forEach((function(t){var i=document.createElement("div");i.setAttribute("class","checkbox-dialog-check-item"),i.setAttribute("data-set-value",t.id),i.innerHTML='\n          <input type="checkbox" value>\n          <span class="checkbox-dialog-check-item-inner"></span>\n      ',e.getUserHtmlTemplate(i,t),n.appendChild(i)})),this.checkGroupElm.appendChild(n),this.checkGroupElm&&this.checkGroupElm.children.length&&Array.prototype.forEach.call(this.checkGroupElm.children,(function(t){t.onclick=function(){var i=t.getAttribute("data-set-value")||"",r=e.userList.find((function(e){return e.id===i}));-1!==t.className.indexOf("checkbox-dialog-check-item-check")?(t.className=t.className.replace(/ checkbox-dialog-check-item-check/g,""),"ALL"!==i&&(e.checkboxRows=e.checkboxRows.filter((function(e){return e.id!==i})))):(t.className+=" checkbox-dialog-check-item-check","ALL"!==i&&r&&e.checkboxRows.push(r)),"ALL"===i?(Array.prototype.forEach.call(e.checkGroupElm.children,(function(e){e.className=t.className})),e.checkboxRows=-1!==t.className.indexOf("checkbox-dialog-check-item-check")?e.userList.map((function(e){return e})):[]):e.checkboxRows.length===e.userList.length?e.checkGroupElm.children[0].className+=" checkbox-dialog-check-item-check":e.checkGroupElm.children[0].className=e.checkGroupElm.children[0].className.replace(/ checkbox-dialog-check-item-check/g,""),e.updateTags()}}))}},{key:"userSelectStyleAndEvent",value:function(e,i){var n=this;e.addEventListener("click",function(){var a=r(t().mark((function r(a){return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a.stopPropagation(),n.upDateActiveItem(e),!(n.toolUserList&&n.toolUserList.length>0)){t.next=7;break}return t.next=5,n.chat.searchCall(i,n.startOpenIndex);case 5:t.next=9;break;case 7:return t.next=9,n.onceSetTag(i);case 9:return t.next=11,n.richTextInput();case 11:n.exitDialog();case 12:case"end":return t.stop()}}),r)})));return function(e){return a.apply(this,arguments)}}())}},{key:"callUserDialogMap",value:function(){var e=this;this.itemShowList=[],Array.prototype.forEach.call(this.dialogMainElm.children||[],(function(t,i){e.itemShowList.push({index:i,elm:t})}))}},{key:"showPCDialog",value:function(){this.domElmShow(this.dialogElm,!0);var e="0",t="100%";this.upDateActiveItem(this.dialogMainElm.firstElementChild,!0);var i=this.chat.getRangeRect(),r=this.dialogElm,n=r.clientWidth,a=r.clientHeight;i.x>window.innerWidth-n&&(i.x=i.x-n-16,e="100%"),i.y<a&&(i.y=a+i.y,t="0"),this.dialogElm.style.transformOrigin="".concat(e," ").concat(t),this.dialogElm.style.left=i.x+6+"px",this.dialogElm.style.bottom="calc(100% - ".concat(i.y,"px)"),this.dialogElm.style.opacity="1"}},{key:"showPCCheckDialog",value:function(){this.winClick(),this.checkboxRows=[],this.domElmShow(this.checkboxElm,!0),this.tagsElm.scrollTop=0,this.checkGroupElm.scrollTop=0,this.searchElm.value="",Array.prototype.forEach.call(this.checkGroupElm.children,(function(e){e.className="checkbox-dialog-check-item"})),this.updateTags(),this.isExternalCallPopup=!0}},{key:"showPCPointDialog",value:(c=r(t().mark((function e(){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.insertText("@"),this.startOpenIndex=this.chat.cursorIndex,window.removeEventListener("click",this.winClick),this.showPCDialog(),e.next=6,d(50);case 6:window.addEventListener("click",this.winClick);case 7:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"moveActiveItem",value:function(e){if(this.dialogActiveItemElm&&0!==this.itemShowList.length){var t=0,i=this.dialogActiveItemElm.getAttribute("data-set-id");this.itemShowList.some((function(e){var r=e.elm.getAttribute("data-set-id");return t=e.index,i===r}));var r=this.itemShowList.map((function(e){return e.index}));if("down"===e&&t!==this.itemShowList[this.itemShowList.length-1].index){var n=this.itemShowList[r.indexOf(t)+1];n&&this.upDateActiveItem(n.elm,!0)}else if("up"===e&&t!==this.itemShowList[0].index){var a=this.itemShowList[r.indexOf(t)-1];a&&this.upDateActiveItem(a.elm,!0)}}}},{key:"upDateActiveItem",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.dialogActiveItemElm&&(this.dialogActiveItemElm.className=this.dialogActiveItemElm.className.replace(/ call-user-dialog-item-active/g,"")),this.dialogActiveItemElm=e,e&&(e.className+=" call-user-dialog-item-active",t&&e.scrollIntoView({block:"center"}))}},{key:"exitDialog",value:function(){this.toolUserList&&this.resizeUserTool(),this.upDateActiveItem(),this.domElmShow(this.dialogElm)}},{key:"hasH5",value:function(){var e=this;this.dialogH5Elm=document.createElement("div"),this.dialogH5Elm.setAttribute("class","call-user-popup"),this.dialogH5Elm.innerHTML='\n      <div class="call-user-popup-main">\n        <div class="call-user-popup-header">\n            <span class="popup-show">收起</span>\n            <span class="popup-title">选择提醒的人</span>\n            <span class="popup-check">确定</span>\n        </div>\n        \n        <div class="call-user-popup-search">\n            <svg class="icon-search"\n                 style="vertical-align: middle;fill: currentColor;overflow: hidden;"\n                 viewBox="0 0 1024 1024" version="1.1"\n                 xmlns="http://www.w3.org/2000/svg"\n                 p-id="4209">\n                <path d="M684.8 223.530667a326.272 326.272 0 0 1 24.96 433.621333c2.645333 2.133333 5.290667 4.48 7.850667 7.04L870.4 817.066667c24.789333 24.746667 32.896 56.832 18.133333 71.594666-14.762667 14.805333-46.848 6.656-71.637333-18.090666l-152.789333-152.832a106.282667 106.282667 0 0 1-7.210667-7.936 326.101333 326.101333 0 0 1-433.109333-25.173334c-127.445333-127.445333-127.573333-333.952-0.256-461.269333 127.36-127.36 333.866667-127.232 461.269333 0.213333zM275.328 275.114667a252.885333 252.885333 0 0 0 0.256 357.632 252.885333 252.885333 0 0 0 357.632 0.256 252.885333 252.885333 0 0 0-0.256-357.632 252.885333 252.885333 0 0 0-357.632-0.256z"\n                      fill="#9B9B9B"\n                      p-id="4210"></path>\n            </svg>\n            <input class="call-user-popup-search-input"\n                   placeholder="搜索人员名称"\n                   type="text">\n        </div>\n        \n        <div class="call-user-popup-body">\n        </div>\n      </div>\n    ';var i=function(){var i=r(t().mark((function i(){return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.dialogH5Elm.className=e.dialogH5Elm.className.replace(/ chat-view-show/g," chat-view-hidden"),e.dialogH5SearchElm.value="",t.next=4,d(260);case 4:e.domElmShow(e.dialogH5Elm),e.chat.restCursorPos(e.chat.vnode,e.chat.cursorIndex),e.isExternalCallPopup=!1,e.chat.viewIntoPoint();case 8:case"end":return t.stop()}}),i)})));return function(){return i.apply(this,arguments)}}();this.dialogH5Elm.onclick=i,this.dialogH5Elm.querySelector(".call-user-popup-main").onclick=function(e){e.stopPropagation()},this.dialogH5ShowElm=this.dialogH5Elm.querySelector(".popup-show"),this.dialogH5ShowElm.onclick=i,this.dialogH5CheckElm=this.dialogH5Elm.querySelector(".popup-check"),this.dialogH5CheckElm.onclick=r(t().mark((function r(){var n,a,o;return t().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==(n=e.dialogH5Elm.querySelectorAll(".user-popup-check-item-check")||[]).length){t.next=5;break}return t.next=4,i();case 4:case 10:return t.abrupt("return");case 5:if(!Array.prototype.some.call(n,(function(e){return"isALL"===e.getAttribute("data-set-id")}))){t.next=11;break}return t.next=8,e.onceSetTag({id:"isALL",name:e.callEveryLabel});case 8:return t.next=10,i();case 11:return a=Array.prototype.map.call(n,(function(e){return e.getAttribute("data-set-id")})),o=e.userList.filter((function(e){return a.includes(e.id)})),t.next=14,e.batchSetTag(o);case 14:return t.next=16,i();case 16:return t.next=18,e.richTextInput();case 18:case"end":return t.stop()}}),r)}))),this.dialogH5MainElm=this.dialogH5Elm.querySelector(".call-user-popup-body"),this.updateUserList(),this.dialogH5SearchElm=this.dialogH5Elm.querySelector(".call-user-popup-search-input"),this.dialogH5SearchElm.oninput=function(t){var i=String(t.target.value||"").replace(/'/g,"");Array.prototype.forEach.call(e.dialogH5MainElm.children,(function(e){if(i){var t=e.getAttribute("data-set-name")||"",r=e.getAttribute("data-set-pinyin")||"";e.style.display=u(t,r,i).length>0?"":"none"}else e.style.display=""}))},this.domElmShow(this.dialogH5Elm),document.body.appendChild(this.dialogH5Elm)}},{key:"updateH5User",value:function(){var e=this;this.dialogH5MainElm.innerHTML="",this.domElmShow(this.dialogH5CheckElm,this.userList.length>0);var t=this.userList&&this.userList.length>0,i=document.createDocumentFragment(),r=document.createElement("span");if(r.innerHTML='\n        <input type="checkbox" value>\n        <span class="user-popup-check-item-inner"></span>\n    ',t){var n=document.createElement("div");this.needCallEvery&&(n.setAttribute("class","call-user-popup-item"),n.setAttribute("data-set-id","isALL"),n.innerHTML='\n          <span class="call-user-dialog-item-sculpture">\n            <span style="transform: scale(0.75)">@</span>\n          </span>\n          <span class="call-user-dialog-item-name">'.concat(this.callEveryLabel,"(").concat(this.userList.length,")</span>\n      "),n.appendChild(r.cloneNode(!0)),n.onclick=function(){var t=-1===n.className.indexOf("user-popup-check-item-check");Array.prototype.forEach.call(e.dialogH5MainElm.children,(function(e){t?e.className+=" user-popup-check-item-check":e.className=e.className.replace(/ user-popup-check-item-check/g,"")}))},i.appendChild(n)),this.userList.forEach((function(t,a){var o=document.createElement("div");o.setAttribute("class","call-user-popup-item"),o.setAttribute("data-set-id",t.id),o.setAttribute("data-set-name",t.name),o.setAttribute("data-set-pinyin",t.pinyin||""),e.getUserHtmlTemplate(o,t),o.appendChild(r.cloneNode(!0)),i.appendChild(o),o.onclick=function(t){-1===o.className.indexOf("user-popup-check-item-check")?(o.className+=" user-popup-check-item-check",n.className+=Array.prototype.every.call(e.dialogH5MainElm.children,(function(e){return-1!==e.className.indexOf("user-popup-check-item-check")||"isALL"===e.getAttribute("data-set-id")}))?" user-popup-check-item-check":""):(o.className=o.className.replace(/ user-popup-check-item-check/g,""),n.className=n.className.replace(/ user-popup-check-item-check/g,""))}}))}this.dialogH5MainElm.appendChild(i)}},{key:"showH5Dialog",value:function(){this.richText&&this.richText.blur(),Array.prototype.forEach.call(this.dialogH5MainElm.children,(function(e){e.style.display="",e.className=e.className.replace(/ user-popup-check-item-check/g,"")})),this.domElmShow(this.dialogH5Elm,!0),this.dialogH5MainElm.scrollTop=0,this.isExternalCallPopup=!0}},{key:"updateConfig",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.copyType,i=e.userProps,r=e.userList,n=e.uploadImage,a=e.needCallEvery,o=e.placeholder,s=e.needCallSpace,c=e.wrapKeyFun,l=e.sendKeyFun;if(t){if(!v(t,"Array"))throw new Error("参数值copyType：类型值应为Array！");this.copyType=t.map((function(e){if(-1===["text","image"].indexOf(e))throw new Error('参数值copyType：无效的参数值"'.concat(e,'"！'));return e}))}if(i){if(!v(i,"Object"))throw new Error("参数值copyType：类型值应为Object！");this.userProps=Object.assign({},{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"},i)}if(n){if("function"!=typeof n)throw new Error("参数值uploadImage：参数类型错误，参数类型应为Function！");this.uploadImage=n}if(o&&(this.placeholderElm.innerText=o),(void 0!==a||r)&&(this.needCallEvery="false"!==String(a),this.updateUserList(r)),void 0!==s&&this.chat.setCallSpace(s),c){if("function"!=typeof c)throw new Error("参数值wrapKeyFun：参数类型错误，参数类型应为Function！");this.wrapKeyFun=c}if(l){if("function"!=typeof l)throw new Error("参数值sendKeyFun：参数类型错误，参数类型应为Function！");this.sendKeyFun=l}}},{key:"enterSend",value:function(){}},{key:"insertHtml",value:function(e){var t=document.createElement("span");t.innerHTML=e,t.className="chat-set-html";var i=this.chat.createNewDom(t);return this.chat.replaceRegContent(i),this.chat.viewIntoPoint(),this.richTextInput(),i}},{key:"insertInsideHtml",value:function(e){var t=this,i=document.createElement("div");if(i.innerHTML=e,i.children.length){var r=this.chat.vnode,n=this.chat.getWrapNode(r);if(1===i.children.length)this.chat.gridMerge(n,i.children[0],!0);else{this.chat.gridMerge(n,i.children[0],!0);var a=Array.prototype.slice.call(i.children,1),o=n;Array.prototype.forEach.call(a,(function(e,i){if(o.parentElement?t.richText.insertBefore(e,o.nextElementSibling):t.richText.appendChild(e),o=e,i===a.length-1){var r=e.childNodes[e.childNodes.length-1].childNodes[0].childNodes[0];t.chat.restCursorPos(r,r.textContent.length)}}))}i=null,this.chat.viewIntoPoint(),this.richTextInput()}}},{key:"insertText",value:function(e){var t,i,r=this;if(e){var n=e.replace(/[\u200b\ufeff]/gi,"");if(n){var a,o=0,s=this.chat.vnode;s&&s.parentElement&&"richInput"===s.parentElement.getAttribute("data-set-richType")?(a=s.parentElement,o="\ufeff"===s.textContent?1:this.chat.cursorLeft):(a=null==(i=null==(t=this.richText)?void 0:t.lastChild)?void 0:i.lastChild,o=a.childNodes[0].textContent.length);var c,l=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=a.childNodes[0],n=i.textContent.split("");return n.splice(o,0,e),i.textContent=n.join("").replace(/\ufeff/i,(function(){return o--,""})),a.setAttribute("data-set-empty","false"),a.childNodes[1]&&a.removeChild(a.childNodes[1]),r.chat.restCursorPos(i,o+e.length),t&&r.chat.viewIntoPoint(),a.parentElement.parentElement},h=n.split("\n");if(h.length>1)h.forEach((function(e,t){c=0===t?l(e):function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2?arguments[2]:void 0,n=r.chat.getGridElm(),a=n.childNodes[0].childNodes[0],o=1;return e&&(a.innerHTML=e,a.setAttribute("data-set-empty","false"),o=e.length),i.nextSibling?r.richText.insertBefore(n,i.nextSibling):r.richText.appendChild(n),t&&(r.chat.restCursorPos(a.childNodes[0],o),r.chat.viewIntoPoint()),n}(e,t===h.length-1,c)}));else l(n,!0);this.richTextInput()}}}},{key:"getCallUserList",value:function(){var e=this.richText.querySelectorAll(".at-user");if(e&&e.length>0){var t=Array.prototype.map.call(e,(function(e){return e.dataset.userId}));return function(e,t,i){return e.forEach((function(e){if(i in e){var r=t.indexOf(String(e[i]));-1!==r&&(t[r]=e)}})),t.filter((function(e){return e[i]}))}(this.targetUserList,t,this.userProps.id)}return[]}},{key:"getCallUserTagList",value:function(){var t=this,i=this.richText.querySelectorAll(".at-user");return i&&i.length>0?Array.prototype.map.call(i,(function(i){return e(e({},t.userProps.id,i.dataset.userId),t.userProps.name,i.innerText.slice(1))})):[]}},{key:"clear",value:function(e){this.chat.textInnerHtmlInit(!0,e),this.historyOptionList=[{html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex}],this.richTextInput(!1)}},{key:"isEmpty",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if((this.richText.querySelectorAll(".chat-tag")||[]).length>0)return!1;var t=new RegExp("^(​|<br>|\ufeff)+$"),i=this.richText.querySelectorAll(".chat-grid-input")||[];return e?Array.prototype.every.call(i,(function(e){return!e.innerHTML||!e.innerText||!e.innerText.trim()||t.test(e.innerHTML)})):Array.prototype.every.call(i,(function(e){return!e.innerHTML||!e.innerText||t.test(e.innerHTML)}))}},{key:"showPlaceholder",value:function(){this.domElmShow(this.placeholderElm,this.isEmpty())}},{key:"getReduceNode",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=Object.assign({},{needUserId:!1,wrapClassName:void 0,rowClassName:void 0},t),r=this.richText.cloneNode(!0).querySelectorAll(".chat-grid-wrap")||[],n=document.createElement("div");return i.wrapClassName&&(n.className=i.wrapClassName),Array.prototype.forEach.call(r,(function(t,r){var a=t.querySelectorAll(".chat-stat")||[],o=document.createElement("p");i.rowClassName&&(o.className=i.rowClassName),Array.prototype.forEach.call(a,(function(t){e.chat.getNodeEmpty(t)||(i.needUserId||t.removeAttribute("data-user-id"),t.removeAttribute("data-set-richType"),t.removeAttribute("contenteditable"),t.removeAttribute("data-set-empty"),o.appendChild(t))})),o.innerHTML||(o.innerHTML="<br>"),n.appendChild(o)})),n}},{key:"getText",value:function(){return this.getReduceNode().innerText}},{key:"getHtml",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.getReduceNode(e).innerHTML}},{key:"dispose",value:function(){var e=this.richText.parentElement;for(var t in e&&(e.removeChild(this.richText),e.removeChild(this.placeholderElm)),this.needDialog&&(this.deviceInfo.isPc?(document.body.removeChild(this.dialogElm),document.body.removeChild(this.checkboxElm),window.removeEventListener("click",this.winClick),window.removeEventListener("keydown",this.winKeydown)):document.body.removeChild(this.dialogH5Elm)),this)delete this[t];Object.setPrototypeOf(this,Object)}},{key:"setUserTag",value:function(e){var t=this.chat.createAtUserSpan({id:e[this.userProps.id],name:e[this.userProps.name]});this.chat.replaceRegContent(t,!1),this.chat.viewIntoPoint(),this.richTextInput()}},{key:"onceSetTag",value:(a=r(t().mark((function e(i){return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.chat.onceCall({id:i[this.userProps.id],name:i[this.userProps.name]});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"batchSetTag",value:(i=r(t().mark((function e(i){var r,n,a;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(1!==i.length){e.next=9;break}if(!this.isExternalCallPopup){e.next=6;break}return e.next=4,this.chat.onceExternalCall(i[0]);case 4:e.next=8;break;case 6:return e.next=8,this.onceSetTag(i[0]);case 8:return e.abrupt("return");case 9:r="",n=0;case 11:if(!(n<=i.length-1)){e.next=36;break}if(a={id:i[n][this.userProps.id],name:i[n][this.userProps.name]},0!==n){e.next=26;break}if(!this.isExternalCallPopup){e.next=20;break}return e.next=17,this.chat.onceExternalCall(a);case 17:e.t0=e.sent,e.next=23;break;case 20:return e.next=22,this.chat.onceCall(a,!0);case 22:e.t0=e.sent;case 23:r=e.t0,e.next=33;break;case 26:if(n!==i.length-1){e.next=31;break}return e.next=29,this.chat.onceCall(a,!1,r);case 29:e.next=33;break;case 31:return e.next=33,this.chat.onceCall(a,!0);case 33:n++;case 34:e.next=11;break;case 36:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"disabled",value:function(){this.richText.setAttribute("contenteditable","false"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,"")+" chat-rich-text-disabled"}},{key:"enable",value:function(){this.richText.setAttribute("contenteditable","true"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,""),this.chat.setRangeLastText()}},{key:"undo",value:function(){if(this.historyOptionList&&!(this.historyOptionList.length<=1)){var e=this.historyOptionList[this.historyOptionList.length-2],t=e.html,i=e.gridIndex,r=e.markIndex,n=e.cursorIndex;this.richText.innerHTML=t,this.historyOptionList.pop(),this.richTextInput(!1);var a=this.richText.childNodes[i].childNodes[r].childNodes[0].childNodes[0];this.chat.restCursorPos(a,n),this.chat.viewIntoPoint()}}},{key:"revisePCPointDialogLabel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},{title:"群成员",checkLabel:"多选"},e);this.dialogElm.querySelector(".call-user-dialog-header-title").innerText=t.title,this.dialogCheckElm.innerText=t.checkLabel}},{key:"revisePCCheckDialogLabel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},{title:"选择要@的人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",userTagTitle:"研讨成员列表",checkAllLabel:"全选",confirmLabel:"确定",cancelLabel:"取消"},e);this.checkboxElm.querySelector(".checkbox-dialog-container-header").children[0].innerText=t.title,this.searchElm.setAttribute("placeholder",t.searchPlaceholder||""),this.searchEmptyLabel=t.searchEmptyLabel||"",this.checkboxElm.querySelector(".checkbox-dialog-right-box-title").innerText=t.userTagTitle,this.checkAllLabel=t.checkAllLabel||"",this.checkGroupElm.children[0].children[2].innerText=this.checkAllLabel,this.checkboxElm.querySelector(".btn-submit").innerText=t.confirmLabel,this.checkboxElm.querySelector(".btn-close").innerText=t.cancelLabel}},{key:"reviseH5DialogLabel",value:function(e){var t=Object.assign({},{title:"选择提醒的人",searchPlaceholder:"搜素人员名称",confirmLabel:"确定",cancelLabel:"收起"},e);this.dialogH5Elm.querySelector(".popup-title").innerText=t.title,this.dialogH5SearchElm.setAttribute("placeholder",t.searchPlaceholder||""),this.dialogH5CheckElm.innerText=t.confirmLabel,this.dialogH5ShowElm.innerText=t.cancelLabel}},{key:"reverseAnalysis",value:function(e,t){var i=this,r=document.createElement("div");r.innerHTML=e;var n=r.children;Array.prototype.forEach.call(n,(function(e){e.className="chat-grid-wrap",e.setAttribute("data-set-richType","richBox");var t=e.children,r={},n=[];for(var a in Array.prototype.forEach.call(t,(function(a,o){if(-1!==a.className.indexOf("chat-grid-input")){var s=a.innerText;return a.className="",a.setAttribute("data-set-richType","richMark"),void(a.innerHTML='<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="false">'.concat(s,"</span>"))}if("BR"===a.tagName){var c=i.chat.getGridElm(!0);return e.removeChild(a),void e.appendChild(c)}var l=a.cloneNode(!0);l.setAttribute("contenteditable","false");var h=document.createElement("span");h.className="chat-tag",h.setAttribute("contenteditable","false"),h.setAttribute("data-set-richType","chatTag"),h.appendChild(l),r[o]=h,o!==t.length-1?-1===t[o+1].className.indexOf("chat-grid-input")&&n.push(o):n.push(o),0===o&&n.push(-1)})),r){var o=Number(a);o===t.length-1?(e.removeChild(t[o]),e.appendChild(r[a])):(e.insertBefore(r[a],t[o+1]),e.removeChild(t[o]))}var s=[],c=e.children;n.forEach((function(e){e===c.length-1?s.push("isEnd"):s.push(c[e+1])})),s.forEach((function(t){var r=i.chat.getGridElm(!0);if("isEnd"===t)e.appendChild(r);else{var n=r.children[0];n.removeChild(n.childNodes[1]),e.insertBefore(r,t)}}))})),t?(this.enable(),this.insertInsideHtml(r.innerHTML)):(this.richText.innerHTML=r.innerHTML,this.enable(),this.chat.viewIntoPoint(),this.richTextInput())}}]);var i,a,c,h,p}();if(!window)throw new Error("非web环境！");window.console&&window.console.log&&console.log(" %c ".concat("ChatArea"," %c v4.4.2 "),"background: #269AFF; color: #FFFFFF; padding: 4px 0; border-radius: 4px 0px 0px 4px; font-style: italic;","background: #FFFFFF; color: #269AFF; padding: 2px 0; border-radius: 0px 4px 4px 0px; font-style: italic; border: 2px solid #269AFF;"),window.ChatArea=g;i("C",window.ChatArea)}}}))}();
