var F=Object.defineProperty;var P=(m,t,e)=>t in m?F(m,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[t]=e;var u=(m,t,e)=>(P(m,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class H{constructor(t){u(this,"richText");u(this,"vnode");u(this,"cursorIndex");u(this,"cursorLeft");u(this,"needCallSpace",!1);u(this,"pointEndIME");u(this,"IME_KEY","​_");this.richText=t,this.textInnerHtmlInit(),this.richText.focus()}textInnerHtmlInit(t=!1,e){if(t||this.getNodeEmpty(this.richText)){this.richText.innerHTML="";const i=this.getGridElm();this.richText.appendChild(i);const s=i.children[0].children[0];e&&(s.innerHTML=e,s.setAttribute("data-set-empty","false"));const r=s.childNodes[0];this.restCursorPos(r,r.textContent==="\uFEFF"?1:r.textContent.length)}}onceCall(t,e=!1,i=""){return new Promise(s=>{const r=this.createAtUserSpan(t),n=this.replaceRegContent(r,!0,e,i)||"";s(n)})}searchCall(t,e){return new Promise(i=>{const s=this.createAtUserSpan(t);this.replaceRegContent(s,e),i()})}onceExternalCall(t){return new Promise(e=>{const i=this.createAtUserSpan(t),s=this.replaceRegContent(i,!1,!0)||"";e(s)})}upDataNodeOrIndex(){var n,o,a;const{focusNode:t,focusOffset:e,anchorOffset:i}=window.getSelection(),s=(t==null?void 0:t.parentNode)||void 0;!s||!s.getAttribute||s.getAttribute("data-set-richType")!=="richInput"||((a=(o=(n=t==null?void 0:t.parentNode)==null?void 0:n.parentNode)==null?void 0:o.parentNode)==null?void 0:a.parentNode)!==this.richText||(this.vnode=t,this.cursorIndex=e,this.cursorLeft=i<e?i:e)}showAt(){if(this.upDataNodeOrIndex(),!this.vnode||this.vnode.nodeType!==Node.TEXT_NODE)return!1;const t=this.vnode.textContent||"",e=/@([^@\s]*)$/,i=t.slice(0,this.cursorIndex),s=e.exec(i);return s&&s.length===2&&i[i.length-1]==="@"}getRangeRect(){let t=0,e=0;const i=window.getSelection().getRangeAt(0).getClientRects()[0];return i&&(t=i.x,e=i.y),{x:t,y:e}}createAtUserSpan(t){const e=document.createElement("span");return e.dataset.userId=String(t.id),e.className="at-user",e.contentEditable="false",e.textContent=`@${t.name}${this.needCallSpace?" ":""}`,this.createNewDom(e)}createNewDom(t){const e=document.createElement("span");return e.className="chat-tag",e.setAttribute("contenteditable","false"),e.setAttribute("data-set-richType","chatTag"),t.className+=" chat-stat",e.appendChild(t),e}restCursorPos(t,e){e==null?e=t.textContent==="\uFEFF"?1:0:e>t.textContent.length&&(e=t.textContent.length);const i=new Range;i.setStart(t,e),i.setEnd(t,e);const s=window.getSelection();s&&(this.vnode=t,this.cursorIndex=e,this.cursorLeft=e,s.removeAllRanges(),s.addRange(i))}setCursorPos(t,e){const i=window.getSelection();if(i.rangeCount<=0)return;const s=i.getRangeAt(0);s.setStart(t,e),s.collapse(!0),this.vnode=t,this.cursorIndex=e,this.cursorLeft=e}replaceRegContent(t,e=!1,i=!1,s=""){const r=this.vnode.textContent;let n;typeof e=="boolean"?n=r.slice(0,e?this.cursorIndex-1:this.cursorIndex):n=r.slice(0,e-1),n.length===0?(this.vnode.parentElement.setAttribute("data-set-empty",!0),this.vnode.textContent="\uFEFF"):this.vnode.textContent=n;let o=s||r.slice(this.cursorIndex);const a=this.vnode.parentNode.parentNode,c=a.nextSibling;c?a.parentNode.insertBefore(t,c):a.parentNode.appendChild(t);const l=t.previousSibling.childNodes[0],p=l.childNodes[1];p&&l.removeChild(p);const g=this.getGridElm(!0),h=g.childNodes[0];return!i&&o&&o!=="\uFEFF"&&(h.setAttribute("data-set-empty","false"),h.innerHTML=o),i&&h.childNodes[1]&&h.removeChild(h.childNodes[1]),t.nextSibling?(h.childNodes[1]&&h.removeChild(h.childNodes[1]),a.parentNode.insertBefore(g,t.nextSibling)):a.parentNode.appendChild(g),this.restCursorPos(h.childNodes[0]),o}switchRange(t){var n,o;const{focusNode:e,focusOffset:i}=window.getSelection();let s,r;if(e.nodeType===Node.TEXT_NODE){const a=e.textContent.length,c=e.parentNode.parentNode;switch(t){case"ArrowLeft":if(i>0&&e.textContent!=="\uFEFF"){r=i-1,s=e;break}const d=(n=c==null?void 0:c.previousSibling)==null?void 0:n.previousSibling;if(d)s=d.childNodes[0].childNodes[0],r=s.textContent.length;else{const p=c.parentNode.previousSibling;p&&(s=p.lastChild.childNodes[0].childNodes[0],r=s.textContent.length)}break;case"ArrowRight":if(i<a&&e.textContent!=="\uFEFF"){r=i+1,s=e;break}const l=(o=c==null?void 0:c.nextSibling)==null?void 0:o.nextSibling;if(l)s=l.childNodes[0].childNodes[0],r=s.textContent==="\uFEFF"?1:0;else{const p=c.parentNode.nextSibling;p&&(s=p.childNodes[0].childNodes[0].childNodes[0],r=s.textContent==="\uFEFF"?1:0)}break}}(r||r===0)&&this.restCursorPos(s,r)}getGridElm(t=!1){const e=document.createElement("span");if(e.setAttribute("data-set-richType","richMark"),e.innerHTML='<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="true">\uFEFF<br></span>',t)return e;const i=document.createElement("p");return i.className="chat-grid-wrap",i.setAttribute("data-set-richType","richBox"),i.appendChild(e),i}updateGrid(){const t=window.getSelection(),e=t.focusNode,i=e.parentNode,s=i.getAttribute("data-set-richType");let r,n,o,a;switch(s){case"richAllBox":if(r=e.childNodes[t.focusOffset],!r||r.getAttribute("data-set-richType")==="chatTag"){const h=this.getGridElm(!0),f=h.children[0];r?(f.removeChild(f.childNodes[1]),e.insertBefore(h,r)):e.appendChild(h),this.restCursorPos(f.childNodes[0]);break}if(r.tagName==="BR"){const h=this.getGridElm(!0),f=h.children[0];e.insertBefore(h,r),e.removeChild(r),this.restCursorPos(f.childNodes[0],f.childNodes[0].textContent.length)}break;case"richMark":const c=i.parentNode,d=Array.prototype.indexOf.call(c.childNodes,i);if(d===-1)break;if(d===0){const h=t.focusNode;h.setAttribute("data-set-empty","true"),h.innerHTML="\uFEFF<br>",r=h.childNodes[0],this.restCursorPos(r,r.textContent.length);break}let l=i.previousSibling,p;l.getAttribute("data-set-richType")==="chatTag"?(p=l.previousSibling,c.removeChild(l),c.removeChild(i)):(p=i.previousSibling,c.removeChild(i)),r=p.childNodes[0].childNodes[0],r.textContent==="\uFEFF"&&r.parentNode.appendChild(document.createElement("br")),this.restCursorPos(r,r.textContent.length);break;case"richInput":if(a=i.parentNode,o=a.parentNode,this.getNodeEmpty(i)){i.setAttribute("data-set-empty","true"),o.childNodes[o.childNodes.length-1]===a&&(i.innerHTML="\uFEFF<br>"),r=i.childNodes[0],this.restCursorPos(r,r.textContent.length);break}if(String(i.getAttribute("data-set-empty"))==="true"){i.setAttribute("data-set-empty","false");const h=[],f=[];Array.prototype.forEach.call(i.childNodes,E=>{E.nodeType===Node.TEXT_NODE&&E.textContent.indexOf("\uFEFF")!==-1?f.push(E):E.tagName==="BR"&&h.push(E)}),h.forEach(E=>{i.removeChild(E)}),f.forEach(E=>{const y=E.textContent.indexOf("\uFEFF"),N=new Range;N.setStart(E,E.textContent.indexOf("\uFEFF")),N.setEnd(E,y+1),N.deleteContents()}),r=i.childNodes[0],this.restCursorPos(r,r.textContent.length)}if(n=i.parentNode.nextSibling,n&&n.nodeType===Node.TEXT_NODE){let h=n.textContent,f=this.getGridElm(!0);f.childNodes[0].textContent=h,f.childNodes[0].setAttribute("data-set-empty","false"),n.parentNode.insertBefore(f,n),n.parentNode.removeChild(n),n=f}n&&n.getAttribute("data-set-richType")==="richMark"&&this.markMerge(i.parentNode,n);break}}getNodeEmpty(t){const e=new RegExp("^(​|<br>|\uFEFF)+$");return!t.innerHTML||e.test(t.innerHTML)}setWrap(){const t=window.getSelection();let{focusNode:e,focusOffset:i}=t;if(e.nodeType!==Node.TEXT_NODE){if(!e.getAttribute||e.getAttribute("data-set-richType")!=="richInput")return;e=e.childNodes[0]}const s=e.textContent.slice(i),r=e.parentNode.parentNode,n=r.parentNode,o=Array.prototype.indexOf.call(n.childNodes,r),a=Array.prototype.slice.call(n.childNodes,o+1),c=this.getGridElm();let d=c.children[0].children[0].childNodes[0],l=1;(s||a.length>0)&&d.parentNode.removeChild(d.parentNode.childNodes[1]),s&&s!=="\uFEFF"&&(e.textContent=e.textContent.slice(0,i),d.textContent=(d.textContent+s).replace(/\ufeff/i,()=>(l--,"")),d.parentElement.setAttribute("data-set-empty","false")),a.forEach(h=>{n.removeChild(h),c.appendChild(h)});const p=n.lastChild.childNodes[0],g=c.lastChild.childNodes[0];if(p.childNodes.length<=1){const h=p.childNodes[0];(!h.textContent||h.textContent==="\uFEFF")&&(p.innerHTML="\uFEFF<br>",p.setAttribute("data-set-empty","true"))}if(g.parentElement.getAttribute("data-set-richType")!=="richMark")c.appendChild(this.getGridElm(!0));else if(g.childNodes.length<=1){const h=g.childNodes[0];(!h.textContent||h.textContent==="\uFEFF")&&(g.innerHTML="\uFEFF<br>",g.setAttribute("data-set-empty","true"),d=c.children[0].children[0].childNodes[0])}n.nextSibling?this.richText.insertBefore(c,n.nextSibling):this.richText.appendChild(c),this.restCursorPos(d,d.textContent==="\uFEFF"?1:l),this.viewIntoPoint()}selectRegionMerge(){const t=window.getSelection();if(t.isCollapsed||t.rangeCount<=0)return;const e=t.getRangeAt(0);if(e.startContainer.nodeType===Node.TEXT_NODE&&e.startContainer===e.endContainer){const i=e.startContainer;if(i.length===e.endOffset-e.startOffset){const s=i.parentNode,r=s.parentNode===s.parentNode.parentNode.lastChild;s.setAttribute("data-set-empty","true"),s.innerHTML=`\uFEFF${r?"<br>":""}`,this.restCursorPos(s.childNodes[0])}else e.deleteContents()}else if(e.commonAncestorContainer&&e.commonAncestorContainer.getAttribute("data-set-richType")==="richBox"){const i=e.startContainer.nodeType===Node.TEXT_NODE?e.startContainer.parentNode.parentNode:e.startContainer,s=e.endContainer.nodeType===Node.TEXT_NODE?e.endContainer.parentNode.parentNode:e.endContainer;e.deleteContents(),i.getAttribute("data-set-richType")===s.getAttribute("data-set-richType")&&this.markMerge(i,s)}else if(e.commonAncestorContainer===e.startContainer&&e.startContainer===e.endContainer)this.textInnerHtmlInit(!0);else{const i=n=>{if(n.nodeType===Node.TEXT_NODE)return n.parentNode.parentNode.parentNode;switch(n.getAttribute("data-set-richType")){case"richInput":return n.parentNode.parentNode;case"richMark":return n.parentNode;case"richBox":return n;default:return null}},s=i(e.startContainer),r=i(e.endContainer);if(!s||!r)return;e.deleteContents(),this.gridMerge(s,r)}return!0}gridElmMerge(){const t=window.getSelection(),{focusNode:e,focusOffset:i,isCollapsed:s}=t;if(i>1||!s)return!1;const r=(a,c)=>a.parentNode!==this.richText&&a!==a.parentNode.childNodes[0]?!1:Array.prototype.indexOf.call(this.richText.childNodes,a)!==-1?a:c>=6?!1:r(a.parentNode,c+1),n=r(e,0);if(!n||n===this.richText.childNodes[0]||i===1&&n.children[0].children[0].getAttribute("data-set-empty")==="false")return!1;const o=n.previousSibling;return this.gridMerge(o,n),!0}delMarkRule(){const t=window.getSelection(),e=t.focusNode,i=e.textContent,s=e.parentNode,r=s.parentNode,n=r.parentNode;if(!t.isCollapsed||s.getAttribute("data-set-richType")!=="richInput")return!1;if(i&&i.length===1&&r!==n.childNodes[0]&&(t.focusOffset!==0||i==="\uFEFF")){if(i==="\uFEFF"){const o=r.previousSibling.previousSibling;n.removeChild(r.previousSibling),n.removeChild(r);const a=o.childNodes[0],c=a.childNodes[0];c.textContent==="\uFEFF"&&o===n.lastChild&&a.appendChild(document.createElement("br")),this.restCursorPos(c,c.textContent.length)}else{s.innerHTML=r===n.lastChild?"\uFEFF<br>":"\uFEFF",s.setAttribute("data-set-empty","true");const o=s.childNodes[0];this.restCursorPos(o,1)}return!0}else if(t.focusOffset===0){const o=s.parentNode,a=o==null?void 0:o.previousSibling;return!a||a.getAttribute("data-set-richType")!=="chatTag"?!1:(this.delTag(a),!0)}}setIMESelection(){const t=window.getSelection(),e=t.focusNode,s=e.parentNode.parentNode;((s==null?void 0:s.getAttribute("data-set-richType"))||"")==="richMark"&&(this.pointEndIME=t.focusOffset,e.textContent=e.textContent.slice(0,this.pointEndIME)+this.IME_KEY+e.textContent.slice(this.pointEndIME),this.restCursorPos(e,this.pointEndIME+this.IME_KEY.length))}delMarkRuleIME(){const t=window.getSelection(),e=t.focusNode,i=e.parentNode,s=i.parentNode;if(((s==null?void 0:s.getAttribute("data-set-richType"))||"")==="richMark"){this.pointEndIME=t.focusOffset;const n=new RegExp(this.IME_KEY.slice(0,-1),"g");if(e.textContent=e.textContent.replace(n,""),this.pointEndIME>this.IME_KEY.length-1&&e.textContent!=="\uFEFF"){const o=this.pointEndIME-(this.IME_KEY.length-1);e.textContent=e.textContent.slice(0,o-1)+e.textContent.slice(o),this.setCursorPos(e,o-1)}else{if(i.getAttribute("data-set-empty")==="false"&&(e.textContent===""||e.textContent==="\uFEFF")){i.innerHTML=s===s.parentElement.lastChild?"\uFEFF<br>":"\uFEFF",i.setAttribute("data-set-empty","true");const l=i.childNodes[0];this.setCursorPos(l,1);return}const a=s.previousSibling;if(a&&a.getAttribute&&a.getAttribute("data-set-richType")==="chatTag"){this.delTag(a);return}const c=s.parentElement,d=c.previousElementSibling;d&&this.gridMerge(d,c)}}}wrapIME(){const e=window.getSelection().focusNode;if(e.getAttribute&&e.getAttribute("data-set-richType")==="richBox"){const a=e.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length);const c=e.children[0];c.tagName==="BR"&&e.removeChild(c);return}const s=e.parentNode.parentNode,r=(s==null?void 0:s.getAttribute("data-set-richType"))||"";if(r==="richMark"){const a=s.parentElement.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length)}else if(r==="richBox"){const a=s.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length)}}resetIME(t){t===" "&&(t=" "),t||(t="");const e=window.getSelection(),i=e.focusNode,r=i.parentNode.parentNode;((r==null?void 0:r.getAttribute("data-set-richType"))||"")==="richMark"&&(i.textContent=i.textContent.slice(0,e.focusOffset-this.IME_KEY.length-t.length)+t+i.textContent.slice(e.focusOffset),i.textContent=i.textContent.replace(/\u200b/g,""),this.setCursorPos(i,this.pointEndIME+t.length))}delTag(t){const e=t.previousSibling,i=t.nextSibling;t.parentNode.removeChild(t),this.markMerge(e,i)}gridMerge(t,e,i=!1){t.lastChild.getAttribute("data-set-richType")!=="richMark"&&t.appendChild(this.getGridElm(!0)),e.childNodes[0].getAttribute("data-set-richType")!=="richMark"&&e.insertBefore(this.getGridElm(!0),e.childNodes[0]);const s=t.lastChild.childNodes[0],r=s.childNodes[0];let n=r.textContent.length;Array.prototype.forEach.call(e.childNodes,a=>{t.appendChild(a.cloneNode(!0))}),e.childNodes.length>1&&s.childNodes[1]&&s.removeChild(s.childNodes[1]);const o=s.parentNode.nextSibling;if(o){const c=o.children[0].childNodes[0];c&&c.textContent!=="\uFEFF"&&(s.childNodes[1]&&s.removeChild(s.childNodes[1]),r.textContent=(r.textContent+c.textContent).replace(/\ufeff/i,()=>(n--,"")),r.parentElement.setAttribute("data-set-empty","false")),t.removeChild(o)}if(r.textContent===""&&(r.textContent="\uFEFF",r.parentNode.setAttribute("data-set-empty","true"),n=1),i){const c=t.childNodes[t.childNodes.length-1].childNodes[0].childNodes[0];this.restCursorPos(c,c.textContent.length)}else this.richText.removeChild(e),this.restCursorPos(r,n);this.viewIntoPoint()}markMerge(t,e){const s=t.children[0].childNodes[0];let r=s.textContent.length;if(e){const a=e.children[0].childNodes[0];a&&a.textContent!=="\uFEFF"&&(s.textContent=(s.textContent+a.textContent).replace(/\ufeff/i,()=>(r--,"")),s.parentElement.setAttribute("data-set-empty","false")),e.parentNode.removeChild(e)}s.textContent===""&&(s.textContent="\uFEFF",s.parentNode.setAttribute("data-set-empty","true"),r=1);const n=t.parentNode;s.textContent==="\uFEFF"&&t===n.lastChild&&(s.parentNode.appendChild(document.createElement("br")),s.parentNode.setAttribute("data-set-empty","true"),r=1),this.restCursorPos(s,r)}setCallSpace(t){this.needCallSpace=t}getWrapNode(t){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode.parentNode;switch(t.getAttribute("data-set-richType")){case"richInput":return t.parentNode.parentNode;case"richMark":return t.parentNode;case"richBox":return t}}getMarkNode(t){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode;switch(t.getAttribute("data-set-richType")){case"richInput":return t.parentNode;case"richMark":return t}}getRichTextNodeIndex(t){const e=this.getMarkNode(t),i=e.parentNode;return{gridIndex:Array.prototype.indexOf.call(this.richText.childNodes,i),markIndex:Array.prototype.indexOf.call(i.childNodes,e)}}setWrapNodeByMark(t){const e=document.createElement("p");return e.className="chat-grid-wrap",e.setAttribute("data-set-richType","richBox"),Array.prototype.forEach.call(t,i=>{e.appendChild(i)}),e}setRangeLastText(){const t=this.richText.childNodes[this.richText.childNodes.length-1],s=t.childNodes[t.childNodes.length-1].children[0].childNodes[0];this.restCursorPos(s,s.textContent==="\uFEFF"?1:s.textContent.length),this.viewIntoPoint()}viewIntoPoint(){const t=window.getSelection();if(t.rangeCount>0){const i=t.getRangeAt(0).getBoundingClientRect(),s=this.richText.parentElement;s.scrollTop=i.top+s.scrollTop-s.clientHeight/2}}}const v=(m=50)=>new Promise(t=>{setTimeout(t,m)}),M=(m,t,e,i)=>{const s=Object.assign(Object.assign({},{precision:"first",continuous:!1,space:"ignore",lastPrecision:"start",insensitive:!0}),i||{});return s.insensitive&&(m=m.toLowerCase(),e=e.toLowerCase()),s.space==="ignore"&&(e=e.replace(/\s/g,"")),O(m,t,e,s)||[]},O=(m,t,e,i)=>{let s=[];for(let r=0;r<m.length;r++){if(i.space==="ignore"&&m[r]===" "){s.push(r);continue}if(m[r]===e[0]){e=e.slice(1),s.push(r);continue}const n=t.split(" ");let o=0;if(n.forEach(a=>{const c=D(a,e);c>o&&(o=c)}),o&&(e=e.slice(o),s.push(r)),!e)break}if(e)return null;if(i.continuous){const r=s;if(s.some((o,a)=>a>0&&o!==r[a-1]+1))return null}return i.space==="ignore"&&(s=s.filter(r=>m[r]!==" ")),s.length?s:null},D=(m,t)=>{let e=0;for(let i=0;i<m.length;i++)m[i]===t[e]&&e++;return e};function R(){const m=navigator.userAgent,t=/(?:Windows Phone)/.test(m),e=/(?:SymbianOS)/.test(m)||t,i=/(?:Android)/.test(m),s=/(?:Firefox)/.test(m),r=/(?:iPad|PlayBook)/.test(m)||i&&!/(?:Mobile)/.test(m)||s&&/(?:Tablet)/.test(m),n=/(?:iPhone)/.test(m)&&!r;return{isTablet:r,isPhone:n,isAndroid:i,isPc:!n&&!i&&!e}}const U=function(m,t,e){return m.forEach(i=>{if(e in i){const s=t.indexOf(String(i[e]));s!==-1&&(t[s]=i)}}),t.filter(i=>i[e])},S=function(m){return Object.prototype.toString.call(m).slice(8,-1)},I=function(m,t){const e=S(m).toLowerCase();switch(S(t)){case"String":return e===t.toLowerCase();case"Array":return t.some(s=>e===s.toLowerCase());default:return!0}};class B{constructor({elm:t,userList:e,placeholder:i,copyType:s,uploadImage:r,needCallEvery:n,callEveryLabel:o,userProps:a,needCallSpace:c,wrapKeyFun:d,sendKeyFun:l,needDialog:p}){u(this,"richText");u(this,"needCallEvery",!0);u(this,"callEveryLabel","所有人");u(this,"needDialog",!0);u(this,"placeholderElm");u(this,"userProps",{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"});u(this,"chat");u(this,"targetUserList",[]);u(this,"userList",[]);u(this,"copyType",["text"]);u(this,"itemShowList",[]);u(this,"checkboxRows",[]);u(this,"base64Images",{});u(this,"uploadImage");u(this,"deviceInfo",R());u(this,"isComposition",!1);u(this,"historyOptionList",[]);u(this,"isExternalCallPopup",!1);u(this,"isIMEModel",!1);u(this,"chatEventModule",{enterSend:[],operate:[]});u(this,"wrapKeyFun",t=>t.ctrlKey&&["Enter"].includes(t.key));u(this,"sendKeyFun",t=>!t.ctrlKey&&["Enter"].includes(t.key));u(this,"startOpenIndex",0);u(this,"toolUserList");u(this,"dialogElm");u(this,"dialogCheckElm");u(this,"dialogMainElm");u(this,"checkboxElm");u(this,"searchResultElm");u(this,"checkGroupElm");u(this,"searchElm");u(this,"tagsElm");u(this,"dialogActiveItemElm");u(this,"searchEmptyLabel","没有匹配到任何结果");u(this,"checkAllLabel","全选");u(this,"dialogH5Elm");u(this,"dialogH5MainElm");u(this,"dialogH5CheckElm");u(this,"dialogH5ShowElm");u(this,"dialogH5SearchElm");u(this,"winClick",()=>{this.getElmBlock(this.dialogElm)&&this.exitDialog(),this.searchResultElm&&this.domElmShow(this.searchResultElm)});u(this,"winKeydown",async t=>{if(t.ctrlKey&&t.code==="KeyZ"&&t.preventDefault(),!(!this.getElmBlock(this.dialogElm)||this.itemShowList.length===0||this.isComposition)){if(t.code==="ArrowDown"){this.moveActiveItem("down");return}if(t.code==="ArrowUp"){this.moveActiveItem("up");return}if((t.code==="Enter"||t.code==="NumpadEnter")&&this.dialogActiveItemElm){t.preventDefault();const e=this.dialogActiveItemElm.getAttribute("data-set-id")||"";await v(100),this.toolUserList&&this.toolUserList.length>0?await this.chat.searchCall(this.userList.find(i=>i.id===e),this.startOpenIndex):await this.onceSetTag(e==="isALL"?{[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}:this.userList.find(i=>i.id===e)),this.exitDialog()}}});if(!(t instanceof HTMLElement))throw new Error("参数值elm：参数类型错误, 参数类型应为HTMLElement！");["absolute","relative","fixed"].includes(t.style.position)||(t.style.position="relative"),t.className+=` chat-area-${this.deviceInfo.isPc?"pc":"h5"}`,this.richText=document.createElement("div"),this.richText.setAttribute("class","chat-rich-text"),this.richText.setAttribute("data-set-richType","richAllBox"),this.richText.setAttribute("contenteditable","true"),t.appendChild(this.richText),this.placeholderElm=document.createElement("div"),this.placeholderElm.className="chat-placeholder-wrap",this.domElmShow(this.placeholderElm,!0),t.appendChild(this.placeholderElm),this.chat=new H(this.richText),o&&(this.callEveryLabel=o),p!==void 0&&(this.needDialog=String(p)!=="false"),this.needDialog&&(this.deviceInfo.isPc?this.hasPc():this.hasH5()),this.registerEvent(),this.updateConfig({userList:e,placeholder:i,copyType:s,uploadImage:r,needCallEvery:n,needCallSpace:c,userProps:a,wrapKeyFun:d,sendKeyFun:l}),this.historyOptionList=[{html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex}]}registerEvent(){this.richText.addEventListener("click",t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("keyup",t=>{if(!this.needDialog)return;if(t.stopPropagation(),this.deviceInfo.isPc){(t.keyCode===50||t.code==="Digit2"||t.key==="@")&&this.userList.length>0&&this.chat.showAt()&&(this.startOpenIndex=this.chat.cursorIndex,this.showPCDialog());return}const e=t.key==="Unidentified"?"android":"ios";let i=!1;switch(e){case"android":i=t.keyCode===229;break;case"ios":i=t.keyCode===50||t.code==="Digit2"||t.key==="@";break}i&&this.userList.length>0&&this.chat.showAt()&&(this.showH5Dialog(),this.isExternalCallPopup=!1)}),this.richText.addEventListener("keydown",async t=>{if(!this.deviceInfo.isPc&&t.key==="Unidentified"&&t.keyCode===229){t.preventDefault(),this.isIMEModel=!0,this.chat.setIMESelection();return}if(this.isIMEModel)return;if(this.getElmBlock(this.dialogElm)){["ArrowUp","ArrowDown","Enter","NumpadEnter"].includes(t.code)?t.preventDefault():["ArrowLeft","ArrowRight"].includes(t.code)&&this.exitDialog();return}t.code==="Backspace"||t.key==="Backspace"?(this.chat.selectRegionMerge()||this.chat.gridElmMerge()||this.chat.delMarkRule())&&(t.preventDefault(),await this.richTextInput()):this.wrapKeyFun(t)||!this.deviceInfo.isPc&&t.key==="Enter"?(t.preventDefault(),this.chat.setWrap(),await this.richTextInput()):this.sendKeyFun(t)?(t.preventDefault(),await v(100),this.enterSend()):["ArrowLeft","ArrowRight"].includes(t.code)?(t.preventDefault(),this.chat.switchRange(t.code)):t.ctrlKey&&t.code==="KeyA"?this.isEmpty()&&t.preventDefault():t.ctrlKey&&t.code==="KeyZ"&&(t.preventDefault(),this.undo()),["Backspace","Shift","Tab","CapsLock","Control","Meta","Alt","ContextMenu","Enter","NumpadEnter","Escape","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Home","End","PageUp","PageDown","Insert","Delete","NumLock"].indexOf(t.key)===-1&&!t.ctrlKey&&!t.altKey&&!t.metaKey&&this.chat.selectRegionMerge()}),this.richText.addEventListener("input",async t=>{if(this.isIMEModel){this.isIMEModel=!1,t.inputType==="deleteContentBackward"?(await v(50),this.chat.delMarkRuleIME()):t.inputType==="insertParagraph"?this.chat.wrapIME():this.chat.resetIME(t.data),this.chat.upDataNodeOrIndex(),this.chat.updateGrid(),this.showPlaceholder();return}if(await this.richTextInput(),this.getElmBlock(this.dialogElm)&&!this.isComposition){const e=this.chat.vnode.textContent,i=this.chat.cursorIndex;if(!e||/^([\u200b\ufeff])+$/.test(e)||i<this.startOpenIndex){this.exitDialog();return}const s=e.slice(this.startOpenIndex,i+1),r=String(s||"").replace(/'/g,"");if(!r){this.resizeUserTool(),this.showPCDialog();return}this.toolUserList||(this.toolUserList=this.userList);const n=this.searchUserList(r,this.toolUserList);n.length>0?(this.updateUserList(n,!0),this.showPCDialog()):this.exitDialog()}}),this.richText.addEventListener("copy",t=>{t.preventDefault(),this.copyRange(t)}),this.richText.addEventListener("cut",t=>{t.preventDefault(),this.copyRange(t),this.removeRange()}),this.richText.addEventListener("paste",t=>{t.preventDefault();const e=t.clipboardData.getData("text/plain");if(typeof e=="string"&&e!==""){if(this.copyType.indexOf("text")===-1)return;let i=document.createElement("div");i.innerHTML=t.clipboardData.getData("application/my-custom-format")||"",this.chat.selectRegionMerge(),i.children[0]&&i.children[0].getAttribute("data-set-richType")==="richBox"?this.insertInsideHtml(i.innerHTML):(i.innerHTML=e,this.insertText(i.innerText)),i=null}else{if(this.copyType.indexOf("image")===-1)return;const s=(t.clipboardData||t.originalEvent.clipboardData).items||[];Array.prototype.forEach.call(s,async r=>{if(r.type.indexOf("image")===-1)return;const n=r.getAsFile();if(this.uploadImage){const o=await this.uploadImage(n);this.insertHtml(`<img class="chat-img" src="${o}" alt="" />`)}else{const o=new FileReader;o.onload=a=>{this.insertHtml(`<img class="chat-img" src="${a.target.result}" alt="" />`)},o.readAsDataURL(n)}})}}),this.richText.addEventListener("blur",async t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("focus",t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("dragstart",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("dragover",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("drop",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("compositionstart",()=>{this.isComposition=!0}),this.richText.addEventListener("compositionend",()=>{this.isComposition=!1})}async richTextInput(t=!0){this.chat.upDataNodeOrIndex(),this.deviceInfo.isPc&&this.chat.selectRegionMerge(),await v(50),this.isComposition||this.chat.updateGrid();const i=(this.richText.children[0]||{childNodes:[]}).childNodes[0];if(!i||!i.getAttribute||i.getAttribute("data-set-richType")!=="richMark"){this.chat.textInnerHtmlInit(!0),this.showPlaceholder(),this.triggerChatEvent("operate");return}if(this.showPlaceholder(),this.triggerChatEvent("operate"),t&&!this.isComposition){const{gridIndex:s,markIndex:r}=this.chat.getRichTextNodeIndex(this.chat.vnode);this.historyOptionList.push({html:this.richText.innerHTML,gridIndex:s,markIndex:r,cursorIndex:this.chat.cursorIndex}),this.historyOptionList.length>50&&this.historyOptionList.shift()}}copyRange(t){const e=window.getSelection();if(e.isCollapsed||e.rangeCount<=0){t.clipboardData.setData("application/my-custom-format",""),t.clipboardData.setData("text/plain","");return}const i=e.toString()||"";let s=document.createElement("div");s.innerHTML=i;const r=s.innerText.replace(/\n\n/g,`
`);s=null,t.clipboardData.setData("text/plain",r);const n=e.anchorNode,o=e.focusNode;if(n===o&&n.nodeType===Node.TEXT_NODE){const h=n.textContent.slice(e.anchorOffset,e.focusOffset);t.clipboardData.setData("application/my-custom-format",h);return}if(n===this.richText&&o===this.richText){t.clipboardData.setData("application/my-custom-format",this.richText.innerHTML);return}const a=this.chat.getWrapNode(n),c=this.chat.getWrapNode(o),d=this.chat.getMarkNode(n),l=this.chat.getMarkNode(o),p=Array.prototype.indexOf.call(a.childNodes,d),g=Array.prototype.indexOf.call(c.childNodes,l);if(a===c&&a.parentNode===this.richText){const h=p>g,f=Array.prototype.filter.call(a.childNodes,(w,C)=>h?C<p&&C>g:C>p&&C<g).map(w=>w.cloneNode(!0)),E=h?n.textContent.slice(0,e.anchorOffset):n.textContent.slice(e.anchorOffset),y=h?o.textContent.slice(e.focusOffset):o.textContent.slice(0,e.focusOffset),N=this.chat.getGridElm(!0),k=this.chat.getGridElm(!0);E&&(N.childNodes[0].innerHTML=E,N.childNodes[0].setAttribute("data-set-empty","false")),y&&(k.childNodes[0].innerHTML=y,k.childNodes[0].setAttribute("data-set-empty","false")),h?(f.unshift(k),f.push(N)):(f.unshift(N),f.push(k));let T=document.createElement("div");const A=this.chat.setWrapNodeByMark(f);T.appendChild(A),t.clipboardData.setData("application/my-custom-format",T.innerHTML),T=null;return}if(a.parentNode===this.richText&&c.parentNode===this.richText){const h=Array.prototype.indexOf.call(this.richText.childNodes,a),f=Array.prototype.indexOf.call(this.richText.childNodes,c),E=h>f,y=Array.prototype.filter.call(this.richText.childNodes,(x,b)=>E?b<h&&b>f:b>h&&b<f).map(x=>x.cloneNode(!0)),N=E?n.textContent.slice(0,e.anchorOffset):n.textContent.slice(e.anchorOffset),k=E?o.textContent.slice(e.focusOffset):o.textContent.slice(0,e.focusOffset),T=this.chat.getGridElm(!0),A=this.chat.getGridElm(!0);N&&(T.childNodes[0].innerHTML=N,T.childNodes[0].setAttribute("data-set-empty","false")),k&&(A.childNodes[0].innerHTML=k,A.childNodes[0].setAttribute("data-set-empty","false"));const w=Array.prototype.filter.call(a.childNodes,(x,b)=>E?b<p:b>p).map(x=>x.cloneNode(!0)),C=Array.prototype.filter.call(c.childNodes,(x,b)=>E?b>g:b<g).map(x=>x.cloneNode(!0));if(E){w.push(T),C.unshift(A);const x=this.chat.setWrapNodeByMark(w),b=this.chat.setWrapNodeByMark(C);y.push(x),y.unshift(b)}else{w.unshift(T),C.push(A);const x=this.chat.setWrapNodeByMark(w),b=this.chat.setWrapNodeByMark(C);y.unshift(x),y.push(b)}let L=document.createElement("div");Array.prototype.forEach.call(y,x=>{L.appendChild(x)}),t.clipboardData.setData("application/my-custom-format",L.innerHTML),L=null;return}}async removeRange(){window.getSelection().getRangeAt(0).deleteContents(),await v(50),this.chat.updateGrid(),this.showPlaceholder()}updateUserList(t=void 0,e){t&&(this.userList=this.getRuleUserList(t)),e||(this.base64Images={}),this.needDialog&&(this.deviceInfo.isPc?this.updatePCUser():this.updateH5User())}getRuleUserList(t){if(!I(t,"Array"))throw new Error("参数值userList：类型值应为Array！");this.targetUserList=JSON.parse(JSON.stringify(t||[]));const e=Object.create(null);return e[this.userProps.id]="isALL",e[this.userProps.name]=this.callEveryLabel,this.targetUserList.unshift(e),(t==null?void 0:t.map((i,s)=>{const r=i[this.userProps.id];if(!r&&r!==0)throw new Error(`参数值userList：下标第${s}项${this.userProps.id}值异常！`);return i.name=String(i[this.userProps.name]||""),i.pinyin=String(i[this.userProps.pinyin]||""),i.id=String(r),i.avatar=String(i[this.userProps.avatar]||""),i}))||[]}getElmBlock(t){return t&&t.style.display==="block"}domElmShow(t,e=!1){t&&(t.className=t.className.replace(/ chat-view-show| chat-view-hidden/g,""),e?(t.style.display="block",t.className+=" chat-view-show"):t.style.display="none")}getUserHtmlTemplate(t,e){const i=document.createElement("span");if(i.setAttribute("class",`call-user-dialog-item-sculpture ${e.avatar?"is-avatar":""}`),e.avatar){const r=new Image;r.alt="";const n=this.base64Images[e.id];n?r.src=n:(r.src=String(e.avatar),r.setAttribute("crossOrigin","Anonymous"),r.onload=()=>{const o=document.createElement("canvas");o.width=48,o.height=48;const a=o.getContext("2d");a&&(a.drawImage(r,0,0,o.width,o.height),this.base64Images[e.id]=o.toDataURL("image/png",1))}),i.appendChild(r)}else i.innerHTML=`<span style="transform: scale(0.75)">${e.name.slice(-2)}</span>`;t.appendChild(i);const s=document.createElement("span");s.setAttribute("class","call-user-dialog-item-name"),s.innerHTML=e.name,t.appendChild(s)}hasPc(){this.initCheckbox(),this.initCallUser(),window.addEventListener("click",this.winClick),window.addEventListener("keydown",this.winKeydown)}initCheckbox(){this.checkboxElm=document.createElement("div"),this.checkboxElm.setAttribute("class","checkbox-dialog"),this.domElmShow(this.checkboxElm),this.checkboxElm.innerHTML=`
      <div class="checkbox-dialog-container">
        <div class="checkbox-dialog-container-header">
            <span>选择要@的人</span>
            <span class="checkbox-dialog-container-header-close">⛌</span>
        </div>
        <div class="checkbox-dialog-container-body">
            <div class="checkbox-dialog-left-box">
                <div class="checkbox-dialog-search">
                    <input class="checkbox-dialog-search-input" placeholder="搜索人员名称" type="text">

                    <div data-set-remark="搜索下拉" class="checkbox-dialog-search-group"></div>
                </div>

                <div data-set-remark="反显选取的人员" class="checkbox-dialog-tags"></div>

                <div class="checkbox-dialog-option">
                    <button class="checkbox-dialog-option-btn btn-submit">确定</button>
                    <button class="checkbox-dialog-option-btn btn-close">取消</button>
                </div>
            </div>
            
            <div class="checkbox-dialog-right-box">
                <div class="checkbox-dialog-right-box-title">研讨成员列表</div>

                <div data-set-remark="多选人员列表" class="checkbox-dialog-check-group"></div>
            </div>
        </div>
      </div>
    `,document.body.appendChild(this.checkboxElm),this.checkGroupElm=this.checkboxElm.querySelector(".checkbox-dialog-check-group"),this.searchResultElm=this.checkboxElm.querySelector(".checkbox-dialog-search-group"),this.searchElm=this.checkboxElm.querySelector(".checkbox-dialog-search-input"),this.tagsElm=this.checkboxElm.querySelector(".checkbox-dialog-tags");const t=()=>{this.domElmShow(this.checkboxElm),this.isExternalCallPopup=!1},e=this.checkboxElm.querySelector(".checkbox-dialog-container-header-close"),i=this.checkboxElm.querySelector(".btn-close");e.onclick=t,i.onclick=t;const s=this.checkboxElm.querySelector(".btn-submit");s.onclick=async()=>{await this.batchSetTag(this.checkboxRows),t(),this.chat.viewIntoPoint(),await this.richTextInput()},this.domElmShow(this.searchResultElm),this.searchResultElm.onclick=r=>{r.stopPropagation()},this.searchElm.onclick=r=>{r.stopPropagation()},this.searchElm.oninput=r=>{this.searchResultElm.innerHTML="";const n=String(r.target.value||"").replace(/'/g,"");if(!n){this.domElmShow(this.searchResultElm);return}const o=this.searchUserList(n),a=document.createDocumentFragment();if(o.forEach(c=>{const d=document.createElement("div");d.setAttribute("class","checkbox-dialog-check-item"),d.setAttribute("data-set-value",c.id);const l=document.createElement("div");l.setAttribute("class","checkbox-dialog-check-item-label"),this.getUserHtmlTemplate(l,c),d.appendChild(l),d.onclick=()=>{this.domElmShow(this.searchResultElm);const p=d.getAttribute("data-set-value")||"";if(this.searchElm.value="",this.checkboxRows.some(h=>h.id===p))return;const g=this.userList.find(h=>h.id===p);g&&this.checkboxRows.push(g),Array.prototype.some.call(this.checkGroupElm.children,(h,f)=>{if(f===0&&this.checkboxRows.length===this.userList.length)return h.className+=" checkbox-dialog-check-item-check",!1;if(h.getAttribute("data-set-value")===p)return h.className+=" checkbox-dialog-check-item-check",!0}),this.updateTags()},a.appendChild(d)}),!o.length){const c=document.createElement("div");c.setAttribute("class","checkbox-dialog-search-empty"),c.innerText=this.searchEmptyLabel,a.appendChild(c)}this.searchResultElm.appendChild(a),this.domElmShow(this.searchResultElm,!0)}}searchUserList(t,e){return(e||this.userList).filter(i=>M(i.name,i.pinyin||"",t).length>0)}updateTags(){const t=this.checkboxRows.map(n=>n.id),e=[],i=[];Array.prototype.forEach.call(this.tagsElm.children,n=>{const o=n.getAttribute("data-set-value");t.indexOf(o)===-1?i.push(n):e.push(o)}),i.forEach(n=>{this.tagsElm.removeChild(n)});const s=this.checkboxRows.filter(n=>e.indexOf(n.id)===-1);if(!s.length)return;const r=document.createDocumentFragment();s.forEach(n=>{const o=document.createElement("div");o.setAttribute("class","checkbox-dialog-tag-item"),o.setAttribute("data-set-value",n.id),o.innerHTML=`
        <span>${n.name}</span>
      `;const a=document.createElement("span");a.setAttribute("class","checkbox-dialog-tag-item-close"),a.innerHTML="⛌",a.onclick=()=>{const c=o.getAttribute("data-set-value");this.checkboxRows=this.checkboxRows.filter(d=>d.id!==c),this.tagsElm.removeChild(o),Array.prototype.some.call(this.checkGroupElm.children,(d,l)=>{if(l===0)return d.className=d.className.replace(/ checkbox-dialog-check-item-check/g,""),!1;if(d.getAttribute("data-set-value")===c)return d.className=d.className.replace(/ checkbox-dialog-check-item-check/g,""),!0})},o.appendChild(a),r.appendChild(o)}),this.tagsElm.appendChild(r)}initCallUser(){this.dialogElm=document.createElement("div"),this.dialogElm.setAttribute("class","call-user-dialog"),this.domElmShow(this.dialogElm);const t=document.createElement("div");t.setAttribute("class","call-user-dialog-header"),t.innerHTML=`
        <span class="call-user-dialog-header-title">群成员</span>
    `,this.dialogCheckElm=document.createElement("span"),this.dialogCheckElm.setAttribute("class","call-user-dialog-header-check"),this.domElmShow(this.dialogCheckElm,this.userList.length>0),this.dialogCheckElm.innerText="多选",this.dialogCheckElm.onclick=()=>{this.showPCCheckDialog(),this.isExternalCallPopup=!1},t.appendChild(this.dialogCheckElm),this.dialogElm.appendChild(t),this.dialogMainElm=document.createElement("div"),this.dialogMainElm.setAttribute("class","call-user-dialog-main"),this.dialogElm.appendChild(this.dialogMainElm),this.updateUserList();const e=document.createElement("div");e.setAttribute("class","call-user-dialog-footer"),this.dialogElm.appendChild(e),document.body.appendChild(this.dialogElm)}resizeUserTool(){this.toolUserList&&(this.userList=this.toolUserList),this.toolUserList=void 0,this.updateUserList(this.userList,!0)}updatePCUser(){this.dialogMainElm.innerHTML="",this.dialogActiveItemElm=void 0;const t=this.userList&&this.userList.length>0,e=document.createDocumentFragment();if(this.domElmShow(this.dialogCheckElm),!this.toolUserList&&t&&(this.domElmShow(this.dialogCheckElm,!0),this.needCallEvery)){const s=document.createElement("div");s.setAttribute("class","call-user-dialog-item"),s.setAttribute("data-set-id","isALL"),this.userSelectStyleAndEvent(s,{[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}),s.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">${this.callEveryLabel}(${this.userList.length})</span>
      `,e.appendChild(s)}this.userList.forEach(s=>{const r=document.createElement("div");r.setAttribute("class","call-user-dialog-item"),r.setAttribute("data-set-id",s.id),this.userSelectStyleAndEvent(r,s),this.getUserHtmlTemplate(r,s),e.appendChild(r)}),this.dialogMainElm.appendChild(e),this.callUserDialogMap(),this.checkGroupElm.innerHTML=`
                    <div class="checkbox-dialog-check-item" data-set-value="ALL">
                        <input type="checkbox" value>
                        <span class="checkbox-dialog-check-item-inner"></span>
                        <div class="checkbox-dialog-check-item-label">${this.checkAllLabel}</div>
                    </div>`;const i=document.createDocumentFragment();this.userList.forEach(s=>{const r=document.createElement("div");r.setAttribute("class","checkbox-dialog-check-item"),r.setAttribute("data-set-value",s.id),r.innerHTML=`
          <input type="checkbox" value>
          <span class="checkbox-dialog-check-item-inner"></span>
      `,this.getUserHtmlTemplate(r,s),i.appendChild(r)}),this.checkGroupElm.appendChild(i),this.checkGroupElm&&this.checkGroupElm.children.length&&Array.prototype.forEach.call(this.checkGroupElm.children,s=>{s.onclick=()=>{const r=s.getAttribute("data-set-value")||"",n=this.userList.find(o=>o.id===r);s.className.indexOf("checkbox-dialog-check-item-check")!==-1?(s.className=s.className.replace(/ checkbox-dialog-check-item-check/g,""),r!=="ALL"&&(this.checkboxRows=this.checkboxRows.filter(o=>o.id!==r))):(s.className+=" checkbox-dialog-check-item-check",r!=="ALL"&&n&&this.checkboxRows.push(n)),r==="ALL"?(Array.prototype.forEach.call(this.checkGroupElm.children,o=>{o.className=s.className}),this.checkboxRows=s.className.indexOf("checkbox-dialog-check-item-check")!==-1?this.userList.map(o=>o):[]):this.checkboxRows.length===this.userList.length?this.checkGroupElm.children[0].className+=" checkbox-dialog-check-item-check":this.checkGroupElm.children[0].className=this.checkGroupElm.children[0].className.replace(/ checkbox-dialog-check-item-check/g,""),this.updateTags()}})}userSelectStyleAndEvent(t,e){t.addEventListener("click",async i=>{i.stopPropagation(),this.upDateActiveItem(t),this.toolUserList&&this.toolUserList.length>0?await this.chat.searchCall(e,this.startOpenIndex):await this.onceSetTag(e),await this.richTextInput(),this.exitDialog()})}callUserDialogMap(){this.itemShowList=[],Array.prototype.forEach.call(this.dialogMainElm.children||[],(t,e)=>{this.itemShowList.push({index:e,elm:t})})}showPCDialog(){this.domElmShow(this.dialogElm,!0);let t="0",e="100%";this.upDateActiveItem(this.dialogMainElm.firstElementChild,!0);const i=this.chat.getRangeRect(),{clientWidth:s,clientHeight:r}=this.dialogElm;i.x>window.innerWidth-s&&(i.x=i.x-s-16,t="100%"),i.y<r&&(i.y=r+i.y,e="0"),this.dialogElm.style.transformOrigin=`${t} ${e}`,this.dialogElm.style.left=i.x+6+"px",this.dialogElm.style.bottom=`calc(100% - ${i.y}px)`,this.dialogElm.style.opacity="1"}showPCCheckDialog(){this.winClick(),this.checkboxRows=[],this.domElmShow(this.checkboxElm,!0),this.tagsElm.scrollTop=0,this.checkGroupElm.scrollTop=0,this.searchElm.value="",Array.prototype.forEach.call(this.checkGroupElm.children,t=>{t.className="checkbox-dialog-check-item"}),this.updateTags(),this.isExternalCallPopup=!0}async showPCPointDialog(){this.insertText("@"),this.startOpenIndex=this.chat.cursorIndex,window.removeEventListener("click",this.winClick),this.showPCDialog(),await v(50),window.addEventListener("click",this.winClick)}moveActiveItem(t){if(!this.dialogActiveItemElm||this.itemShowList.length===0)return;let e=0;const i=this.dialogActiveItemElm.getAttribute("data-set-id");this.itemShowList.some(r=>{const n=r.elm.getAttribute("data-set-id");return e=r.index,i===n});const s=this.itemShowList.map(r=>r.index);if(t==="down"&&e!==this.itemShowList[this.itemShowList.length-1].index){const r=this.itemShowList[s.indexOf(e)+1];r&&this.upDateActiveItem(r.elm,!0)}else if(t==="up"&&e!==this.itemShowList[0].index){const r=this.itemShowList[s.indexOf(e)-1];r&&this.upDateActiveItem(r.elm,!0)}}upDateActiveItem(t,e=!1){this.dialogActiveItemElm&&(this.dialogActiveItemElm.className=this.dialogActiveItemElm.className.replace(/ call-user-dialog-item-active/g,"")),this.dialogActiveItemElm=t,t&&(t.className+=" call-user-dialog-item-active",e&&t.scrollIntoView({block:"center"}))}exitDialog(){this.toolUserList&&this.resizeUserTool(),this.upDateActiveItem(),this.domElmShow(this.dialogElm)}hasH5(){this.dialogH5Elm=document.createElement("div"),this.dialogH5Elm.setAttribute("class","call-user-popup"),this.dialogH5Elm.innerHTML=`
      <div class="call-user-popup-main">
        <div class="call-user-popup-header">
            <span class="popup-show">收起</span>
            <span class="popup-title">选择提醒的人</span>
            <span class="popup-check">确定</span>
        </div>
        
        <div class="call-user-popup-search">
            <svg class="icon-search"
                 style="vertical-align: middle;fill: currentColor;overflow: hidden;"
                 viewBox="0 0 1024 1024" version="1.1"
                 xmlns="http://www.w3.org/2000/svg"
                 p-id="4209">
                <path d="M684.8 223.530667a326.272 326.272 0 0 1 24.96 433.621333c2.645333 2.133333 5.290667 4.48 7.850667 7.04L870.4 817.066667c24.789333 24.746667 32.896 56.832 18.133333 71.594666-14.762667 14.805333-46.848 6.656-71.637333-18.090666l-152.789333-152.832a106.282667 106.282667 0 0 1-7.210667-7.936 326.101333 326.101333 0 0 1-433.109333-25.173334c-127.445333-127.445333-127.573333-333.952-0.256-461.269333 127.36-127.36 333.866667-127.232 461.269333 0.213333zM275.328 275.114667a252.885333 252.885333 0 0 0 0.256 357.632 252.885333 252.885333 0 0 0 357.632 0.256 252.885333 252.885333 0 0 0-0.256-357.632 252.885333 252.885333 0 0 0-357.632-0.256z"
                      fill="#9B9B9B"
                      p-id="4210"></path>
            </svg>
            <input class="call-user-popup-search-input"
                   placeholder="搜索人员名称"
                   type="text">
        </div>
        
        <div class="call-user-popup-body">
        </div>
      </div>
    `;const t=async()=>{this.dialogH5Elm.className=this.dialogH5Elm.className.replace(/ chat-view-show/g," chat-view-hidden"),this.dialogH5SearchElm.value="",await v(260),this.domElmShow(this.dialogH5Elm),this.chat.restCursorPos(this.chat.vnode,this.chat.cursorIndex),this.isExternalCallPopup=!1,this.chat.viewIntoPoint()};this.dialogH5Elm.onclick=t,this.dialogH5Elm.querySelector(".call-user-popup-main").onclick=e=>{e.stopPropagation()},this.dialogH5ShowElm=this.dialogH5Elm.querySelector(".popup-show"),this.dialogH5ShowElm.onclick=t,this.dialogH5CheckElm=this.dialogH5Elm.querySelector(".popup-check"),this.dialogH5CheckElm.onclick=async()=>{const e=this.dialogH5Elm.querySelectorAll(".user-popup-check-item-check")||[];if(e.length===0){await t();return}if(Array.prototype.some.call(e,r=>r.getAttribute("data-set-id")==="isALL")){await this.onceSetTag({[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}),await t();return}const i=Array.prototype.map.call(e,r=>r.getAttribute("data-set-id")),s=this.userList.filter(r=>i.includes(r.id));await this.batchSetTag(s),await t(),await this.richTextInput()},this.dialogH5MainElm=this.dialogH5Elm.querySelector(".call-user-popup-body"),this.updateUserList(),this.dialogH5SearchElm=this.dialogH5Elm.querySelector(".call-user-popup-search-input"),this.dialogH5SearchElm.oninput=e=>{const i=String(e.target.value||"").replace(/'/g,"");Array.prototype.forEach.call(this.dialogH5MainElm.children,s=>{if(!i){s.style.display="";return}const r=s.getAttribute("data-set-name")||"",n=s.getAttribute("data-set-pinyin")||"";s.style.display=M(r,n,i).length>0?"":"none"})},this.domElmShow(this.dialogH5Elm),document.body.appendChild(this.dialogH5Elm)}updateH5User(){this.dialogH5MainElm.innerHTML="",this.domElmShow(this.dialogH5CheckElm,this.userList.length>0);const t=this.userList&&this.userList.length>0,e=document.createDocumentFragment(),i=document.createElement("span");if(i.innerHTML=`
        <input type="checkbox" value>
        <span class="user-popup-check-item-inner"></span>
    `,t){const s=document.createElement("div");this.needCallEvery&&(s.setAttribute("class","call-user-popup-item"),s.setAttribute("data-set-id","isALL"),s.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">${this.callEveryLabel}(${this.userList.length})</span>
      `,s.appendChild(i.cloneNode(!0)),s.onclick=()=>{const r=s.className.indexOf("user-popup-check-item-check")===-1;Array.prototype.forEach.call(this.dialogH5MainElm.children,n=>{r?n.className+=" user-popup-check-item-check":n.className=n.className.replace(/ user-popup-check-item-check/g,"")})},e.appendChild(s)),this.userList.forEach((r,n)=>{const o=document.createElement("div");o.setAttribute("class","call-user-popup-item"),o.setAttribute("data-set-id",r.id),o.setAttribute("data-set-name",r.name),o.setAttribute("data-set-pinyin",r.pinyin||""),this.getUserHtmlTemplate(o,r),o.appendChild(i.cloneNode(!0)),e.appendChild(o),o.onclick=a=>{o.className.indexOf("user-popup-check-item-check")===-1?(o.className+=" user-popup-check-item-check",s.className+=Array.prototype.every.call(this.dialogH5MainElm.children,d=>d.className.indexOf("user-popup-check-item-check")!==-1||d.getAttribute("data-set-id")==="isALL")?" user-popup-check-item-check":""):(o.className=o.className.replace(/ user-popup-check-item-check/g,""),s.className=s.className.replace(/ user-popup-check-item-check/g,""))}})}this.dialogH5MainElm.appendChild(e)}showH5Dialog(){this.richText&&this.richText.blur(),Array.prototype.forEach.call(this.dialogH5MainElm.children,t=>{t.style.display="",t.className=t.className.replace(/ user-popup-check-item-check/g,"")}),this.domElmShow(this.dialogH5Elm,!0),this.dialogH5MainElm.scrollTop=0,this.isExternalCallPopup=!0}updateConfig({copyType:t,userProps:e,userList:i,uploadImage:s,needCallEvery:r,placeholder:n,needCallSpace:o,wrapKeyFun:a,sendKeyFun:c}={}){if(t){if(!I(t,"Array"))throw new Error("参数值copyType：类型值应为Array！");this.copyType=t.map(d=>{if(["text","image"].indexOf(d)===-1)throw new Error(`参数值copyType：无效的参数值"${d}"！`);return d})}if(e){if(!I(e,"Object"))throw new Error("参数值copyType：类型值应为Object！");this.userProps=Object.assign({},{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"},e)}if(s){if(typeof s!="function")throw new Error("参数值uploadImage：参数类型错误，参数类型应为Function！");this.uploadImage=s}if(n&&(this.placeholderElm.innerText=n),(r!==void 0||i)&&(this.needCallEvery=String(r)!=="false",this.updateUserList(i)),o!==void 0&&this.chat.setCallSpace(o),a){if(typeof a!="function")throw new Error("参数值wrapKeyFun：参数类型错误，参数类型应为Function！");this.wrapKeyFun=a}if(c){if(typeof c!="function")throw new Error("参数值sendKeyFun：参数类型错误，参数类型应为Function！");this.sendKeyFun=c}}enterSend(){this.triggerChatEvent("enterSend")}insertHtml(t){const e=document.createElement("span");e.innerHTML=t,e.className="chat-set-html";const i=this.chat.createNewDom(e);return this.chat.replaceRegContent(i),this.chat.viewIntoPoint(),this.richTextInput(),i}insertInsideHtml(t){let e=document.createElement("div");if(e.innerHTML=t,!e.children.length)return;const i=this.chat.vnode,s=this.chat.getWrapNode(i);if(e.children.length===1)this.chat.gridMerge(s,e.children[0],!0);else{this.chat.gridMerge(s,e.children[0],!0);const r=Array.prototype.slice.call(e.children,1);let n=s;Array.prototype.forEach.call(r,(o,a)=>{if(n.parentElement?this.richText.insertBefore(o,n.nextElementSibling):this.richText.appendChild(o),n=o,a===r.length-1){const d=o.childNodes[o.childNodes.length-1].childNodes[0].childNodes[0];this.chat.restCursorPos(d,d.textContent.length)}})}e=null,this.chat.viewIntoPoint(),this.richTextInput()}insertText(t){var c,d;if(!t)return;const e=t.replace(/[\u200b\ufeff]/ig,"");if(!e)return;let i,s=0;const r=this.chat.vnode;r&&r.parentElement&&r.parentElement.getAttribute("data-set-richType")==="richInput"?(i=r.parentElement,s=r.textContent==="\uFEFF"?1:this.chat.cursorLeft):(i=(d=(c=this.richText)==null?void 0:c.lastChild)==null?void 0:d.lastChild,s=i.childNodes[0].textContent.length);const n=(l,p=!1)=>{const g=i.childNodes[0],h=g.textContent.split("");return h.splice(s,0,l),g.textContent=h.join("").replace(/\ufeff/i,()=>(s--,"")),i.setAttribute("data-set-empty","false"),i.childNodes[1]&&i.removeChild(i.childNodes[1]),this.chat.restCursorPos(g,s+l.length),p&&this.chat.viewIntoPoint(),i.parentElement.parentElement},o=(l,p=!1,g)=>{const h=this.chat.getGridElm(),f=h.childNodes[0].childNodes[0];let E=1;return l&&(f.innerHTML=l,f.setAttribute("data-set-empty","false"),E=l.length),g.nextSibling?this.richText.insertBefore(h,g.nextSibling):this.richText.appendChild(h),p&&(this.chat.restCursorPos(f.childNodes[0],E),this.chat.viewIntoPoint()),h},a=e.split(`
`);if(a.length>1){let l;a.forEach((p,g)=>{g===0?l=n(p):l=o(p,g===a.length-1,l)})}else n(e,!0);this.richTextInput()}getCallUserList(){const t=this.richText.querySelectorAll(".at-user");if(t&&t.length>0){const e=Array.prototype.map.call(t,i=>i.dataset.userId);return U(this.targetUserList,e,this.userProps.id)}else return[]}getCallUserTagList(){const t=this.richText.querySelectorAll(".at-user");return t&&t.length>0?Array.prototype.map.call(t,e=>({[this.userProps.id]:e.dataset.userId,[this.userProps.name]:e.innerText.slice(1)})):[]}clear(t){this.chat.textInnerHtmlInit(!0,t),this.historyOptionList=[{html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex}],this.richTextInput(!1)}isEmpty(t=!1){if((this.richText.querySelectorAll(".chat-tag")||[]).length>0)return!1;const i=new RegExp("^(​|<br>|\uFEFF)+$"),s=this.richText.querySelectorAll(".chat-grid-input")||[];return t?Array.prototype.every.call(s,r=>!r.innerHTML||!r.innerText||!r.innerText.trim()||i.test(r.innerHTML)):Array.prototype.every.call(s,r=>!r.innerHTML||!r.innerText||i.test(r.innerHTML))}showPlaceholder(){this.domElmShow(this.placeholderElm,this.isEmpty())}getReduceNode(t={}){const e=Object.assign({},{needUserId:!1,wrapClassName:void 0,rowClassName:void 0,imgToText:!1,identifyLink:!1},t),i=/(https?|http|ftp|file):\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]/g,r=this.richText.cloneNode(!0).querySelectorAll(".chat-grid-wrap")||[],n=document.createElement("div");return e.wrapClassName&&(n.className=e.wrapClassName),Array.prototype.forEach.call(r,(o,a)=>{const c=o.querySelectorAll(".chat-stat")||[],d=document.createElement("p");e.rowClassName&&(d.className=e.rowClassName),Array.prototype.forEach.call(c,l=>{this.chat.getNodeEmpty(l)||(l.removeAttribute("data-set-richType"),l.removeAttribute("contenteditable"),l.removeAttribute("data-set-empty"),e.needUserId||l.removeAttribute("data-user-id"),e.imgToText&&l.firstChild&&l.firstChild.tagName==="IMG"&&(l.className+=" img-to-text",l.innerHTML=`[${l.firstChild.getAttribute("data-img-text")||"元素data-img-text未定义"}]`),e.identifyLink&&l.className.indexOf("chat-grid-input")!==-1&&(l.innerHTML=l.innerHTML.replace(i,p=>`<a class="chat-grid-link" href="${p}" target="_blank">${p}</a>`)),d.appendChild(l))}),d.innerHTML||(d.innerHTML="<br>"),n.appendChild(d)}),n}getText(t={}){let e="";const i=this.getReduceNode(t);return Array.prototype.forEach.call(i.children,(s,r)=>{e=e+(r>0?`
`:"")+s.textContent}),e}getHtml(t={}){return this.getReduceNode(t).innerHTML}dispose(){const t=this.richText.parentElement;t&&(t.removeChild(this.richText),t.removeChild(this.placeholderElm)),this.needDialog&&(this.deviceInfo.isPc?(document.body.removeChild(this.dialogElm),document.body.removeChild(this.checkboxElm),window.removeEventListener("click",this.winClick),window.removeEventListener("keydown",this.winKeydown)):document.body.removeChild(this.dialogH5Elm));for(const e in this)delete this[e];Object.setPrototypeOf(this,Object)}setUserTag(t){const e=this.chat.createAtUserSpan({id:t[this.userProps.id],name:t[this.userProps.name]});this.chat.replaceRegContent(e,!1),this.chat.viewIntoPoint(),this.richTextInput()}async onceSetTag(t){await this.chat.onceCall({id:t[this.userProps.id],name:t[this.userProps.name]})}async batchSetTag(t){if(t.length===1){this.isExternalCallPopup?await this.chat.onceExternalCall(t[0]):await this.onceSetTag(t[0]);return}let e="";for(let i=0;i<=t.length-1;){const s={id:t[i][this.userProps.id],name:t[i][this.userProps.name]};i===0?e=this.isExternalCallPopup?await this.chat.onceExternalCall(s):await this.chat.onceCall(s,!0):i===t.length-1?await this.chat.onceCall(s,!1,e):await this.chat.onceCall(s,!0),i++}}disabled(){this.richText.setAttribute("contenteditable","false"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,"")+" chat-rich-text-disabled"}enable(){this.richText.setAttribute("contenteditable","true"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,""),this.chat.setRangeLastText()}undo(){if(!this.historyOptionList||this.historyOptionList.length<=1)return;const{html:t,gridIndex:e,markIndex:i,cursorIndex:s}=this.historyOptionList[this.historyOptionList.length-2];this.richText.innerHTML=t,this.historyOptionList.pop(),this.richTextInput(!1);const r=this.richText.childNodes[e].childNodes[i].childNodes[0].childNodes[0];this.chat.restCursorPos(r,s),this.chat.viewIntoPoint()}revisePCPointDialogLabel(t={}){const e=Object.assign({},{title:"群成员",checkLabel:"多选"},t);this.dialogElm.querySelector(".call-user-dialog-header-title").innerText=e.title,this.dialogCheckElm.innerText=e.checkLabel}revisePCCheckDialogLabel(t={}){const e=Object.assign({},{title:"选择要@的人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",userTagTitle:"研讨成员列表",checkAllLabel:"全选",confirmLabel:"确定",cancelLabel:"取消"},t);this.checkboxElm.querySelector(".checkbox-dialog-container-header").children[0].innerText=e.title,this.searchElm.setAttribute("placeholder",e.searchPlaceholder||""),this.searchEmptyLabel=e.searchEmptyLabel||"",this.checkboxElm.querySelector(".checkbox-dialog-right-box-title").innerText=e.userTagTitle,this.checkAllLabel=e.checkAllLabel||"",this.checkGroupElm.children[0].children[2].innerText=this.checkAllLabel,this.checkboxElm.querySelector(".btn-submit").innerText=e.confirmLabel,this.checkboxElm.querySelector(".btn-close").innerText=e.cancelLabel}reviseH5DialogLabel(t){const e=Object.assign({},{title:"选择提醒的人",searchPlaceholder:"搜素人员名称",confirmLabel:"确定",cancelLabel:"收起"},t);this.dialogH5Elm.querySelector(".popup-title").innerText=e.title,this.dialogH5SearchElm.setAttribute("placeholder",e.searchPlaceholder||""),this.dialogH5CheckElm.innerText=e.confirmLabel,this.dialogH5ShowElm.innerText=e.cancelLabel}reverseAnalysis(t,e){const i=document.createElement("div");i.innerHTML=t;const s=i.children;Array.prototype.forEach.call(s,r=>{r.className="chat-grid-wrap",r.setAttribute("data-set-richType","richBox");const n=r.children,o={},a=[];Array.prototype.forEach.call(n,(l,p)=>{if(l.className.indexOf("chat-grid-input")!==-1){const f=l.innerText;l.className="",l.setAttribute("data-set-richType","richMark"),l.innerHTML=`<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="false">${f}</span>`;return}if(l.tagName==="BR"){const f=this.chat.getGridElm(!0);r.removeChild(l),r.appendChild(f);return}const g=l.cloneNode(!0);g.setAttribute("contenteditable","false");const h=document.createElement("span");h.className="chat-tag",h.setAttribute("contenteditable","false"),h.setAttribute("data-set-richType","chatTag"),h.appendChild(g),o[p]=h,p!==n.length-1?n[p+1].className.indexOf("chat-grid-input")===-1&&a.push(p):a.push(p),p===0&&a.push(-1)});for(const l in o){const p=Number(l);p===n.length-1?(r.removeChild(n[p]),r.appendChild(o[l])):(r.insertBefore(o[l],n[p+1]),r.removeChild(n[p]))}const c=[],d=r.children;a.forEach(l=>{l===d.length-1?c.push("isEnd"):c.push(d[l+1])}),c.forEach(l=>{const p=this.chat.getGridElm(!0);if(l==="isEnd")r.appendChild(p);else{const g=p.children[0];g.removeChild(g.childNodes[1]),r.insertBefore(p,l)}})}),e?(this.enable(),this.insertInsideHtml(i.innerHTML)):(this.richText.innerHTML=i.innerHTML,this.enable(),this.chat.viewIntoPoint(),this.richTextInput())}addEventListener(t,e){this.chatEventModule[t].push(e)}removeEventListener(t,e){const i=this.chatEventModule[t],s=i.indexOf(e);s!==-1&&i.splice(s,1)}triggerChatEvent(t){this.chatEventModule[t].forEach(e=>e&&e())}}if(!window)throw new Error("非web环境！");window.console&&window.console.log&&console.log(" %c ".concat("ChatArea"," %c v4.5.2 "),"background: #269AFF; color: #FFFFFF; padding: 4px 0; border-radius: 4px 0px 0px 4px; font-style: italic;","background: #FFFFFF; color: #269AFF; padding: 2px 0; border-radius: 0px 4px 4px 0px; font-style: italic; border: 2px solid #269AFF;");window.ChatArea=B;
