var D=Object.defineProperty;var O=(g,t,e)=>t in g?D(g,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):g[t]=e;var u=(g,t,e)=>(O(g,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class H{constructor(t){u(this,"richText");u(this,"vnode");u(this,"cursorIndex");u(this,"cursorLeft");u(this,"needCallSpace",!1);u(this,"VOID_KEY","\uFEFF");u(this,"ZERO_WIDTH_KEY","​");u(this,"pointEndIME");u(this,"IME_KEY","​_");this.richText=t,this.textInnerHtmlInit(),this.richText.focus()}textInnerHtmlInit(t=!1,e){if(t||this.getNodeEmpty(this.richText)){this.richText.innerHTML="";const s=this.getGridElm();this.richText.appendChild(s);const i=s.children[0].children[0];e&&(i.innerHTML=e,i.setAttribute("data-set-empty","false"));const r=i.childNodes[0];this.restCursorPos(r,r.textContent===this.VOID_KEY?1:r.textContent.length)}}onceCall(t,e=!1,s=""){return new Promise(i=>{const r=this.createAtUserSpan(t),n=this.replaceRegContent(r,!0,e,s)||"";i(n)})}searchCall(t,e){return new Promise(s=>{const i=this.createAtUserSpan(t);this.replaceRegContent(i,e),s()})}onceExternalCall(t){return new Promise(e=>{const s=this.createAtUserSpan(t),i=this.replaceRegContent(s,!1,!0)||"";e(i)})}upDataNodeOrIndex(){var n,o,a;const{focusNode:t,focusOffset:e,anchorOffset:s}=window.getSelection(),i=(t==null?void 0:t.parentNode)||void 0;!i||!i.getAttribute||i.getAttribute("data-set-richType")!=="richInput"||((a=(o=(n=t==null?void 0:t.parentNode)==null?void 0:n.parentNode)==null?void 0:o.parentNode)==null?void 0:a.parentNode)!==this.richText||(this.vnode=t,this.cursorIndex=e,this.cursorLeft=s<e?s:e)}showAt(){if(this.upDataNodeOrIndex(),!this.vnode||this.vnode.nodeType!==Node.TEXT_NODE)return!1;const t=this.vnode.textContent||"",e=/@([^@\s]*)$/,s=t.slice(0,this.cursorIndex),i=e.exec(s);return i&&i.length===2&&s[s.length-1]==="@"}getRangeRect(){let t=0,e=0;const s=window.getSelection().getRangeAt(0).getClientRects()[0];return s&&(t=s.x,e=s.y),{x:t,y:e}}createAtUserSpan(t){const e=document.createElement("span");return e.dataset.userId=String(t.id),e.className="at-user",e.contentEditable="false",e.textContent=`@${t.name}${this.needCallSpace?" ":""}`,this.createNewDom(e)}createNewDom(t){const e=document.createElement("span");return e.className="chat-tag",e.setAttribute("contenteditable","false"),e.setAttribute("data-set-richType","chatTag"),t.className+=" chat-stat",e.appendChild(t),e}restCursorPos(t,e){e==null?e=t.textContent===this.VOID_KEY?1:0:e>t.textContent.length&&(e=t.textContent.length);const s=new Range;s.setStart(t,e),s.setEnd(t,e);const i=window.getSelection();i&&(this.vnode=t,this.cursorIndex=e,this.cursorLeft=e,i.removeAllRanges(),i.addRange(s))}setCursorPos(t,e){const s=window.getSelection();if(s.rangeCount<=0)return;const i=s.getRangeAt(0);i.setStart(t,e),i.collapse(!0),this.vnode=t,this.cursorIndex=e,this.cursorLeft=e}replaceRegContent(t,e=!1,s=!1,i=""){const r=this.vnode.textContent;let n;typeof e=="boolean"?n=r.slice(0,e?this.cursorIndex-1:this.cursorIndex):n=r.slice(0,e-1),n.length===0?(this.vnode.parentElement.setAttribute("data-set-empty",!0),this.vnode.textContent=this.VOID_KEY):this.vnode.textContent=n;let o=i||r.slice(this.cursorIndex);const a=this.vnode.parentNode.parentNode,c=a.nextSibling;c?a.parentNode.insertBefore(t,c):a.parentNode.appendChild(t);const h=t.previousSibling.childNodes[0],d=h.childNodes[1];d&&h.removeChild(d);const f=this.getGridElm(!0),l=f.childNodes[0];!s&&o&&o!==this.VOID_KEY&&(l.setAttribute("data-set-empty","false"),l.innerHTML=o);const m=l.childNodes[1];return s&&m&&l.removeChild(m),t.nextSibling?(m&&l.removeChild(m),a.parentNode.insertBefore(f,t.nextSibling)):a.parentNode.appendChild(f),this.restCursorPos(l.childNodes[0]),o}switchRange(t){var n,o;const{focusNode:e,focusOffset:s}=window.getSelection();let i,r;if(e.nodeType===Node.TEXT_NODE){const a=e.textContent.length,c=e.parentNode.parentNode;switch(t){case"ArrowLeft":if(s>0&&e.textContent!==this.VOID_KEY){r=s-1,i=e;break}const p=(n=c==null?void 0:c.previousSibling)==null?void 0:n.previousSibling;if(p)i=p.childNodes[0].childNodes[0],r=i.textContent.length;else{const d=c.parentNode.previousSibling;d&&(i=d.lastChild.childNodes[0].childNodes[0],r=i.textContent.length)}break;case"ArrowRight":if(s<a&&e.textContent!==this.VOID_KEY){r=s+1,i=e;break}const h=(o=c==null?void 0:c.nextSibling)==null?void 0:o.nextSibling;if(h)i=h.childNodes[0].childNodes[0],r=i.textContent===this.VOID_KEY?1:0;else{const d=c.parentNode.nextSibling;d&&(i=d.childNodes[0].childNodes[0].childNodes[0],r=i.textContent===this.VOID_KEY?1:0)}break}}(r||r===0)&&this.restCursorPos(i,r)}getGridElm(t=!1){const e=document.createElement("span");if(e.setAttribute("data-set-richType","richMark"),e.innerHTML=`<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="true">${this.VOID_KEY}<br></span>`,t)return e;const s=document.createElement("p");return s.className="chat-grid-wrap",s.setAttribute("data-set-richType","richBox"),s.appendChild(e),s}updateGrid(){const t=window.getSelection(),e=t.focusNode,s=e.parentNode,i=s.getAttribute("data-set-richType");let r,n,o,a;switch(i){case"richAllBox":if(r=e.childNodes[t.focusOffset],!r||r.getAttribute("data-set-richType")==="chatTag"){const l=this.getGridElm(!0),m=l.children[0];r?(m.removeChild(m.childNodes[1]),e.insertBefore(l,r)):e.appendChild(l),this.restCursorPos(m.childNodes[0]);break}if(r.tagName==="BR"){const l=this.getGridElm(!0),m=l.children[0];e.insertBefore(l,r),e.removeChild(r),this.restCursorPos(m.childNodes[0],m.childNodes[0].textContent.length)}break;case"richMark":const c=s.parentNode,p=Array.prototype.indexOf.call(c.childNodes,s);if(p===-1)break;if(p===0){const l=t.focusNode;l.setAttribute("data-set-empty","true"),l.innerHTML=`${this.VOID_KEY}<br>`,r=l.childNodes[0],this.restCursorPos(r,r.textContent.length);break}let h=s.previousSibling,d;h.getAttribute("data-set-richType")==="chatTag"?(d=h.previousSibling,c.removeChild(h),c.removeChild(s)):(d=s.previousSibling,c.removeChild(s)),r=d.childNodes[0].childNodes[0],r.textContent===this.VOID_KEY&&r.parentNode.appendChild(document.createElement("br")),this.restCursorPos(r,r.textContent.length);break;case"richInput":if(a=s.parentNode,o=a.parentNode,this.getNodeEmpty(s)){s.setAttribute("data-set-empty","true"),o.childNodes[o.childNodes.length-1]===a&&(s.innerHTML=`${this.VOID_KEY}<br>`),r=s.childNodes[0],this.restCursorPos(r,r.textContent.length);break}if(String(s.getAttribute("data-set-empty"))==="true"){s.setAttribute("data-set-empty","false");const l=[],m=[];Array.prototype.forEach.call(s.childNodes,E=>{E.nodeType===Node.TEXT_NODE&&E.textContent.indexOf(this.VOID_KEY)!==-1?m.push(E):E.tagName==="BR"&&l.push(E)}),l.forEach(E=>{s.removeChild(E)}),m.forEach(E=>{const C=E.textContent.indexOf(this.VOID_KEY),b=new Range;b.setStart(E,E.textContent.indexOf(this.VOID_KEY)),b.setEnd(E,C+1),b.deleteContents()}),r=s.childNodes[0],this.restCursorPos(r,r.textContent.length)}if(n=s.parentNode.nextSibling,n&&n.nodeType===Node.TEXT_NODE){let l=n.textContent,m=this.getGridElm(!0);m.childNodes[0].textContent=l,m.childNodes[0].setAttribute("data-set-empty","false"),n.parentNode.insertBefore(m,n),n.parentNode.removeChild(n),n=m}n&&n.getAttribute("data-set-richType")==="richMark"&&this.markMerge(s.parentNode,n);break}}getNodeEmpty(t){const e=new RegExp(`^(${this.ZERO_WIDTH_KEY}|<br>|${this.VOID_KEY})+$`);return!t.innerHTML||e.test(t.innerHTML)}setWrap(){const t=window.getSelection();let{focusNode:e,focusOffset:s}=t;if(e.nodeType!==Node.TEXT_NODE){if(!e.getAttribute||e.getAttribute("data-set-richType")!=="richInput")return;e=e.childNodes[0]}const i=e.textContent.slice(s),r=e.parentNode.parentNode,n=r.parentNode,o=Array.prototype.indexOf.call(n.childNodes,r),a=Array.prototype.slice.call(n.childNodes,o+1),c=this.getGridElm();let p=c.children[0].children[0].childNodes[0],h=1;(i||a.length>0)&&p.parentNode.removeChild(p.parentNode.childNodes[1]),i&&i!==this.VOID_KEY&&(e.textContent=e.textContent.slice(0,s),p.textContent=(p.textContent+i).replace(new RegExp(this.VOID_KEY,"g"),()=>(h--,"")),p.parentElement.setAttribute("data-set-empty","false")),a.forEach(l=>{n.removeChild(l),c.appendChild(l)});const d=n.lastChild.childNodes[0],f=c.lastChild.childNodes[0];if(d.childNodes.length<=1){const l=d.childNodes[0];(!l.textContent||l.textContent===this.VOID_KEY)&&(d.innerHTML=`${this.VOID_KEY}<br>`,d.setAttribute("data-set-empty","true"))}if(f.parentElement.getAttribute("data-set-richType")!=="richMark")c.appendChild(this.getGridElm(!0));else if(f.childNodes.length<=1){const l=f.childNodes[0];(!l.textContent||l.textContent===this.VOID_KEY)&&(f.innerHTML=`${this.VOID_KEY}<br>`,f.setAttribute("data-set-empty","true"),p=c.children[0].children[0].childNodes[0])}n.nextSibling?this.richText.insertBefore(c,n.nextSibling):this.richText.appendChild(c),this.restCursorPos(p,p.textContent===this.VOID_KEY?1:h),this.viewIntoPoint()}selectRegionMerge(){const t=window.getSelection();if(t.isCollapsed||t.rangeCount<=0)return;const e=t.getRangeAt(0);if(e.startContainer.nodeType===Node.TEXT_NODE&&e.startContainer===e.endContainer){const s=e.startContainer;if(s.length===e.endOffset-e.startOffset){const i=s.parentNode,r=i.parentNode===i.parentNode.parentNode.lastChild;i.setAttribute("data-set-empty","true"),i.innerHTML=`\uFEFF${r?"<br>":""}`,this.restCursorPos(i.childNodes[0])}else e.deleteContents()}else if(e.commonAncestorContainer&&e.commonAncestorContainer.getAttribute("data-set-richType")==="richBox"){const s=e.startContainer.nodeType===Node.TEXT_NODE?e.startContainer.parentNode.parentNode:e.startContainer,i=e.endContainer.nodeType===Node.TEXT_NODE?e.endContainer.parentNode.parentNode:e.endContainer;e.deleteContents(),s.getAttribute("data-set-richType")===i.getAttribute("data-set-richType")&&this.markMerge(s,i)}else if(e.commonAncestorContainer===e.startContainer&&e.startContainer===e.endContainer)this.textInnerHtmlInit(!0);else{const s=n=>{if(n.nodeType===Node.TEXT_NODE)return n.parentNode.parentNode.parentNode;switch(n.getAttribute("data-set-richType")){case"richInput":return n.parentNode.parentNode;case"richMark":return n.parentNode;case"richBox":return n;default:return null}},i=s(e.startContainer),r=s(e.endContainer);if(!i||!r)return;e.deleteContents(),this.gridMerge(i,r)}return!0}gridElmMerge(){const t=window.getSelection(),{focusNode:e,focusOffset:s,isCollapsed:i}=t;if(s>1||!i)return!1;const r=(a,c)=>a.parentNode!==this.richText&&a!==a.parentNode.childNodes[0]?!1:Array.prototype.indexOf.call(this.richText.childNodes,a)!==-1?a:c>=6?!1:r(a.parentNode,c+1),n=r(e,0);if(!n||n===this.richText.childNodes[0]||s===1&&n.children[0].children[0].getAttribute("data-set-empty")==="false")return!1;const o=n.previousSibling;return this.gridMerge(o,n),!0}delMarkRule(){const t=window.getSelection(),e=t.focusNode,s=e.textContent,i=e.parentNode,r=i.parentNode,n=r.parentNode;if(!t.isCollapsed||i.getAttribute("data-set-richType")!=="richInput")return!1;if(s&&s.length===1&&r!==n.childNodes[0]&&(t.focusOffset!==0||s===this.VOID_KEY)){if(s===this.VOID_KEY){const o=r.previousSibling.previousSibling;n.removeChild(r.previousSibling),n.removeChild(r);const a=o.childNodes[0],c=a.childNodes[0];c.textContent===this.VOID_KEY&&o===n.lastChild&&a.appendChild(document.createElement("br")),this.restCursorPos(c,c.textContent.length)}else{i.innerHTML=r===n.lastChild?`${this.VOID_KEY}<br>`:this.VOID_KEY,i.setAttribute("data-set-empty","true");const o=i.childNodes[0];this.restCursorPos(o,1)}return!0}else if(t.focusOffset===0){const o=i.parentNode,a=o==null?void 0:o.previousSibling;return!a||a.getAttribute("data-set-richType")!=="chatTag"?!1:(this.delTag(a),!0)}}setIMESelection(){const t=window.getSelection(),e=t.focusNode,i=e.parentNode.parentNode;((i==null?void 0:i.getAttribute("data-set-richType"))||"")==="richMark"&&(this.pointEndIME=t.focusOffset,e.textContent=e.textContent.slice(0,this.pointEndIME)+this.IME_KEY+e.textContent.slice(this.pointEndIME),this.restCursorPos(e,this.pointEndIME+this.IME_KEY.length))}delMarkRuleIME(){const t=window.getSelection(),e=t.focusNode,s=e.parentNode,i=s.parentNode;if(((i==null?void 0:i.getAttribute("data-set-richType"))||"")==="richMark"){this.pointEndIME=t.focusOffset;const n=new RegExp(this.IME_KEY.slice(0,-1),"g");if(e.textContent=e.textContent.replace(n,""),this.pointEndIME>this.IME_KEY.length-1&&e.textContent!==this.VOID_KEY){const o=this.pointEndIME-(this.IME_KEY.length-1);e.textContent=e.textContent.slice(0,o-1)+e.textContent.slice(o),this.setCursorPos(e,o-1)}else{if(s.getAttribute("data-set-empty")==="false"&&(e.textContent===""||e.textContent===this.VOID_KEY)){s.innerHTML=i===i.parentElement.lastChild?`${this.VOID_KEY}<br>`:this.VOID_KEY,s.setAttribute("data-set-empty","true");const h=s.childNodes[0];this.setCursorPos(h,1);return}const a=i.previousSibling;if(a&&a.getAttribute&&a.getAttribute("data-set-richType")==="chatTag"){this.delTag(a);return}const c=i.parentElement,p=c.previousElementSibling;p&&this.gridMerge(p,c)}}}wrapIME(){const e=window.getSelection().focusNode;if(e.getAttribute&&e.getAttribute("data-set-richType")==="richBox"){const a=e.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length);const c=e.children[0];c.tagName==="BR"&&e.removeChild(c);return}const i=e.parentNode.parentNode,r=(i==null?void 0:i.getAttribute("data-set-richType"))||"";if(r==="richMark"){const a=i.parentElement.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length)}else if(r==="richBox"){const a=i.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length)}}resetIME(t){t===" "&&(t=" "),t||(t="");const e=window.getSelection(),s=e.focusNode,r=s.parentNode.parentNode;((r==null?void 0:r.getAttribute("data-set-richType"))||"")==="richMark"&&(s.textContent=s.textContent.slice(0,e.focusOffset-this.IME_KEY.length-t.length)+t+s.textContent.slice(e.focusOffset),s.textContent=s.textContent.replace(new RegExp(this.ZERO_WIDTH_KEY,"g"),""),this.setCursorPos(s,this.pointEndIME+t.length))}delTag(t){const e=t.previousSibling,s=t.nextSibling;t.parentNode.removeChild(t),this.markMerge(e,s)}gridMerge(t,e,s=!1){t.lastChild.getAttribute("data-set-richType")!=="richMark"&&t.appendChild(this.getGridElm(!0)),e.childNodes[0].getAttribute("data-set-richType")!=="richMark"&&e.insertBefore(this.getGridElm(!0),e.childNodes[0]);const i=t.lastChild.childNodes[0],r=i.childNodes[0];let n=r.textContent.length;Array.prototype.forEach.call(e.childNodes,a=>{t.appendChild(a.cloneNode(!0))}),e.childNodes.length>1&&i.childNodes[1]&&i.removeChild(i.childNodes[1]);const o=i.parentNode.nextSibling;if(o){const c=o.children[0].childNodes[0];c&&c.textContent!==this.VOID_KEY&&(i.childNodes[1]&&i.removeChild(i.childNodes[1]),r.textContent=(r.textContent+c.textContent).replace(new RegExp(this.VOID_KEY,"g"),()=>(n--,"")),r.parentElement.setAttribute("data-set-empty","false")),t.removeChild(o)}if(r.textContent===""&&(r.textContent=this.VOID_KEY,r.parentNode.setAttribute("data-set-empty","true"),n=1),s){const c=t.childNodes[t.childNodes.length-1].childNodes[0].childNodes[0];this.restCursorPos(c,c.textContent.length)}else this.richText.removeChild(e),this.restCursorPos(r,n);this.viewIntoPoint()}markMerge(t,e){const i=t.children[0].childNodes[0];let r=i.textContent.length;if(e){const a=e.children[0].childNodes[0];a&&a.textContent!==this.VOID_KEY&&(i.textContent=(i.textContent+a.textContent).replace(new RegExp(this.VOID_KEY,"g"),()=>(r--,"")),i.parentElement.setAttribute("data-set-empty","false")),e.parentNode.removeChild(e)}i.textContent===""&&(i.textContent=this.VOID_KEY,i.parentNode.setAttribute("data-set-empty","true"),r=1);const n=t.parentNode;i.textContent===this.VOID_KEY&&t===n.lastChild&&(i.parentNode.appendChild(document.createElement("br")),i.parentNode.setAttribute("data-set-empty","true"),r=1),this.restCursorPos(i,r)}setCallSpace(t){this.needCallSpace=t}getWrapNode(t){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode.parentNode;switch(t.getAttribute("data-set-richType")){case"richInput":return t.parentNode.parentNode;case"richMark":return t.parentNode;case"richBox":return t}}getMarkNode(t){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode;switch(t.getAttribute("data-set-richType")){case"richInput":return t.parentNode;case"richMark":return t}}getRichTextNodeIndex(t){const e=this.getMarkNode(t),s=e.parentNode;return{gridIndex:Array.prototype.indexOf.call(this.richText.childNodes,s),markIndex:Array.prototype.indexOf.call(s.childNodes,e)}}setWrapNodeByMark(t){const e=document.createElement("p");return e.className="chat-grid-wrap",e.setAttribute("data-set-richType","richBox"),Array.prototype.forEach.call(t,s=>{e.appendChild(s)}),e}setRangeLastText(){const t=this.richText.childNodes[this.richText.childNodes.length-1],i=t.childNodes[t.childNodes.length-1].children[0].childNodes[0];this.restCursorPos(i,i.textContent===this.VOID_KEY?1:i.textContent.length),this.viewIntoPoint()}viewIntoPoint(){const t=window.getSelection();if(t.rangeCount>0){const s=t.getRangeAt(0).getBoundingClientRect(),i=this.richText.parentElement;i.scrollTop=s.top+i.scrollTop-i.clientHeight/2}}}const k=(g=50)=>new Promise(t=>{setTimeout(t,g)}),M=(g,t,e,s)=>{const i=Object.assign(Object.assign({},{precision:"first",continuous:!1,space:"ignore",lastPrecision:"start",insensitive:!0}),s||{});return i.insensitive&&(g=g.toLowerCase(),e=e.toLowerCase()),i.space==="ignore"&&(e=e.replace(/\s/g,"")),P(g,t,e,i)||[]},P=(g,t,e,s)=>{let i=[];for(let r=0;r<g.length;r++){if(s.space==="ignore"&&g[r]===" "){i.push(r);continue}if(g[r]===e[0]){e=e.slice(1),i.push(r);continue}const n=t.split(" ");let o=0;if(n.forEach(a=>{const c=R(a,e);c>o&&(o=c)}),o&&(e=e.slice(o),i.push(r)),!e)break}if(e)return null;if(s.continuous){const r=i;if(i.some((o,a)=>a>0&&o!==r[a-1]+1))return null}return s.space==="ignore"&&(i=i.filter(r=>g[r]!==" ")),i.length?i:null},R=(g,t)=>{let e=0;for(let s=0;s<g.length;s++)g[s]===t[e]&&e++;return e};function _(){const g=navigator.userAgent,t=/(?:Windows Phone)/.test(g),e=/(?:SymbianOS)/.test(g)||t,s=/(?:Android)/.test(g),i=/(?:Firefox)/.test(g),r=/(?:iPad|PlayBook)/.test(g)||s&&!/(?:Mobile)/.test(g)||i&&/(?:Tablet)/.test(g),n=/(?:iPhone)/.test(g)&&!r;return{isTablet:r,isPhone:n,isAndroid:s,isPc:!n&&!s&&!e}}const K=function(g,t,e){return g.forEach(s=>{if(e in s){const i=t.indexOf(String(s[e]));i!==-1&&(t[i]=s)}}),t.filter(s=>s[e])},S=function(g){return Object.prototype.toString.call(g).slice(8,-1)},L=function(g,t){const e=S(g).toLowerCase();switch(S(t)){case"String":return e===t.toLowerCase();case"Array":return t.some(i=>e===i.toLowerCase());default:return!0}};class U{constructor({elm:t,userList:e,placeholder:s,copyType:i,uploadImage:r,needCallEvery:n,callEveryLabel:o,userProps:a,needCallSpace:c,wrapKeyFun:p,sendKeyFun:h,needDialog:d,maxLength:f}){u(this,"richText");u(this,"needCallEvery",!0);u(this,"callEveryLabel","所有人");u(this,"maxLength");u(this,"textLength",0);u(this,"needDialog",!0);u(this,"placeholderElm");u(this,"userProps",{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"});u(this,"chat");u(this,"targetUserList",[]);u(this,"userList",[]);u(this,"copyType",["text"]);u(this,"itemShowList",[]);u(this,"checkboxRows",[]);u(this,"base64Images",{});u(this,"uploadImage");u(this,"deviceInfo",_());u(this,"isComposition",!1);u(this,"undoHistory",[]);u(this,"redoHistory",[]);u(this,"doOverHistory",!0);u(this,"isExternalCallPopup",!1);u(this,"isIMEModel",!1);u(this,"chatEventModule",{enterSend:[],operate:[],defaultAction:[]});u(this,"wrapKeyFun",t=>t.ctrlKey&&["Enter"].includes(t.key));u(this,"sendKeyFun",t=>!t.ctrlKey&&["Enter"].includes(t.key));u(this,"startOpenIndex",0);u(this,"toolUserList");u(this,"dialogElm");u(this,"dialogCheckElm");u(this,"dialogMainElm");u(this,"checkboxElm");u(this,"searchResultElm");u(this,"checkGroupElm");u(this,"searchElm");u(this,"tagsElm");u(this,"dialogActiveItemElm");u(this,"searchEmptyLabel","没有匹配到任何结果");u(this,"checkAllLabel","全选");u(this,"dialogH5Elm");u(this,"dialogH5MainElm");u(this,"dialogH5CheckElm");u(this,"dialogH5ShowElm");u(this,"dialogH5SearchElm");u(this,"winClick",()=>{this.getElmBlock(this.dialogElm)&&this.exitDialog(),this.searchResultElm&&this.domElmShow(this.searchResultElm)});u(this,"winKeydown",async t=>{if(t.ctrlKey&&t.code==="KeyZ"&&t.preventDefault(),!(!this.getElmBlock(this.dialogElm)||this.itemShowList.length===0||this.isComposition)){if(t.code==="ArrowDown"){this.moveActiveItem("down");return}if(t.code==="ArrowUp"){this.moveActiveItem("up");return}if((t.code==="Enter"||t.code==="NumpadEnter")&&this.dialogActiveItemElm){t.preventDefault();const e=this.dialogActiveItemElm.getAttribute("data-set-id")||"";await k(100),this.toolUserList&&this.toolUserList.length>0?await this.matchSetTag(this.userList.find(s=>s.id===e)):await this.onceSetTag(e==="isALL"?{[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}:this.userList.find(s=>s.id===e)),this.exitDialog()}}});if(!(t instanceof HTMLElement))throw new Error("参数值elm：参数类型错误, 参数类型应为HTMLElement！");["absolute","relative","fixed"].includes(t.style.position)||(t.style.position="relative"),t.className+=` chat-area-${this.deviceInfo.isPc?"pc":"h5"}`,this.richText=document.createElement("div"),this.richText.setAttribute("class","chat-rich-text"),this.richText.setAttribute("data-set-richType","richAllBox"),this.richText.setAttribute("contenteditable","true"),t.appendChild(this.richText),this.placeholderElm=document.createElement("div"),this.placeholderElm.className="chat-placeholder-wrap",this.domElmShow(this.placeholderElm,!0),t.appendChild(this.placeholderElm),this.chat=new H(this.richText),o&&(this.callEveryLabel=o),d!==void 0&&(this.needDialog=String(d)!=="false"),this.needDialog&&(this.deviceInfo.isPc?this.hasPc():this.hasH5()),this.registerEvent(),this.updateConfig({userList:e,placeholder:s,maxLength:f,copyType:i,uploadImage:r,needCallEvery:n,needCallSpace:c,userProps:a,wrapKeyFun:p,sendKeyFun:h});const l={html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex};this.undoHistory=[l]}registerEvent(){this.richText.addEventListener("keyup",t=>{if(!this.needDialog)return;if(t.stopPropagation(),this.deviceInfo.isPc){(t.keyCode===50||t.code==="Digit2"||t.key==="@")&&this.ruleChatEvent(this.ruleCanShowPointDialog,"defaultAction","KEYBOARD_PRESS_@"),["ArrowDown","ArrowUp","ArrowLeft","ArrowRight"].includes(t.code)&&!this.getElmBlock(this.dialogElm)&&this.ruleChatEvent(this.ruleCanShowPointDialog,"defaultAction","KEYBOARD_MOVE_@");return}const e=t.key==="Unidentified"?"android":"ios";let s=!1;switch(e){case"android":s=t.keyCode===229;break;case"ios":s=t.keyCode===50||t.code==="Digit2"||t.key==="@";break}s&&this.userList.length>0&&this.chat.showAt()&&(this.showH5Dialog(),this.isExternalCallPopup=!1)}),this.richText.addEventListener("keydown",async t=>{if(!this.deviceInfo.isPc&&t.key==="Unidentified"&&t.keyCode===229){t.preventDefault(),this.isIMEModel=!0,this.chat.setIMESelection();return}if(this.isIMEModel)return;if(this.getElmBlock(this.dialogElm)){["ArrowUp","ArrowDown","Enter","NumpadEnter"].includes(t.code)?t.preventDefault():["ArrowLeft","ArrowRight"].includes(t.code)&&this.exitDialog();return}t.code==="Backspace"||t.key==="Backspace"?(this.chat.selectRegionMerge()||this.chat.gridElmMerge()||this.chat.delMarkRule())&&(t.preventDefault(),await this.richTextInput()):this.wrapKeyFun(t)||!this.deviceInfo.isPc&&t.key==="Enter"?(t.preventDefault(),this.chat.setWrap(),await this.richTextInput()):this.sendKeyFun(t)?(t.preventDefault(),await k(100),this.enterSend()):["ArrowLeft","ArrowRight"].includes(t.code)?(t.preventDefault(),this.chat.switchRange(t.code)):t.ctrlKey&&t.code==="KeyA"?this.isEmpty()&&t.preventDefault():t.ctrlKey&&t.code==="KeyZ"?(t.preventDefault(),this.ruleChatEvent(this.undo,"defaultAction","UNDO")):t.ctrlKey&&t.code==="KeyY"&&(t.preventDefault(),this.ruleChatEvent(this.redo,"defaultAction","REDO")),["Backspace","Shift","Tab","CapsLock","Control","Meta","Alt","ContextMenu","Enter","NumpadEnter","Escape","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Home","End","PageUp","PageDown","Insert","Delete","NumLock"].indexOf(t.key)===-1&&!t.ctrlKey&&!t.altKey&&!t.metaKey&&this.chat.selectRegionMerge()}),this.richText.addEventListener("input",async t=>{if(this.isIMEModel){this.isIMEModel=!1,t.inputType==="deleteContentBackward"?(await k(50),this.chat.delMarkRuleIME()):t.inputType==="insertParagraph"?this.chat.wrapIME():this.chat.resetIME(t.data),this.chat.upDataNodeOrIndex(),this.chat.updateGrid(),this.maxLength!==void 0&&this.ruleMaxLength(),this.showPlaceholder(),this.triggerChatEvent("operate");return}if(await this.richTextInput(),this.getElmBlock(this.dialogElm)&&!this.isComposition){const e=this.chat.vnode.textContent,s=this.chat.cursorIndex,i=new RegExp(`^([${this.chat.ZERO_WIDTH_KEY}${this.chat.VOID_KEY}])+$`);if(!e||i.test(e)||s<this.startOpenIndex){this.exitDialog();return}const r=e.slice(this.startOpenIndex,s+1),n=String(r||"");if(/\s{2,}/ig.test(n)){this.exitDialog();return}if(!n){this.resizeUserTool(),this.showPCDialog();return}this.toolUserList||(this.toolUserList=this.userList);const o=this.searchUserList(n,this.toolUserList);o.length>0?(this.updateUserList(o,!0),this.showPCDialog()):this.exitDialog()}}),this.richText.addEventListener("copy",t=>{t.preventDefault(),this.ruleChatEvent(()=>{this.copyRange(t)},"defaultAction","COPY")}),this.richText.addEventListener("cut",t=>{t.preventDefault(),this.ruleChatEvent(()=>{this.copyRange(t),this.removeRange()},"defaultAction","CUT")}),this.richText.addEventListener("paste",t=>{t.preventDefault(),this.ruleChatEvent(()=>{const e=t.clipboardData.getData("text/plain");if(typeof e=="string"&&e!==""){if(this.copyType.indexOf("text")===-1)return;let s=document.createElement("div");s.innerHTML=t.clipboardData.getData("application/my-custom-format")||"",this.chat.selectRegionMerge(),s.children[0]&&s.children[0].getAttribute("data-set-richType")==="richBox"?this.insertInsideHtml(s.innerHTML):(s.innerHTML=e,this.insertText(s.innerText)),s=null}else{if(this.copyType.indexOf("image")===-1)return;const i=(t.clipboardData||t.originalEvent.clipboardData).items||[];Array.prototype.forEach.call(i,async r=>{if(r.type.indexOf("image")===-1)return;const n=r.getAsFile();if(this.uploadImage){const o=await this.uploadImage(n);this.insertHtml(`<img class="chat-img" src="${o}" alt="" />`)}else{const o=new FileReader;o.onload=a=>{this.insertHtml(`<img class="chat-img" src="${a.target.result}" alt="" />`)},o.readAsDataURL(n)}})}},"defaultAction","PASTE")}),this.richText.addEventListener("blur",t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("focus",t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("click",async()=>{this.chat.upDataNodeOrIndex(),await k(),this.ruleChatEvent(this.ruleCanShowPointDialog,"defaultAction","MOUSE_MOVE_@")}),this.richText.addEventListener("dragstart",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("dragover",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("drop",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("compositionstart",()=>{this.isComposition=!0}),this.richText.addEventListener("compositionend",()=>{this.isComposition=!1})}async richTextInput(t=!0){this.chat.upDataNodeOrIndex(),this.deviceInfo.isPc&&this.chat.selectRegionMerge(),await k(50),this.isComposition||this.chat.updateGrid();const s=(this.richText.children[0]||{childNodes:[]}).childNodes[0];if(!s||!s.getAttribute||s.getAttribute("data-set-richType")!=="richMark"){this.chat.textInnerHtmlInit(!0),this.showPlaceholder(),this.triggerChatEvent("operate");return}if(this.maxLength!==void 0&&this.ruleMaxLength(),this.showPlaceholder(),this.triggerChatEvent("operate"),t&&!this.isComposition){const{gridIndex:i,markIndex:r}=this.chat.getRichTextNodeIndex(this.chat.vnode),n={html:this.richText.innerHTML,gridIndex:i,markIndex:r,cursorIndex:this.chat.cursorIndex};this.undoHistory.push(n),this.undoHistory.length>50&&this.undoHistory.shift()}}copyRange(t){const e=window.getSelection();if(e.isCollapsed||e.rangeCount<=0){t.clipboardData.setData("application/my-custom-format",""),t.clipboardData.setData("text/plain","");return}const s=e.toString()||"";let i=document.createElement("div");i.innerHTML=s;const r=i.innerText.replace(/\n\n/g,`
`);i=null,t.clipboardData.setData("text/plain",r);const n=e.anchorNode,o=e.focusNode;if(n===o&&n.nodeType===Node.TEXT_NODE){const l=n.textContent.slice(e.anchorOffset,e.focusOffset);t.clipboardData.setData("application/my-custom-format",l);return}if(n===this.richText&&o===this.richText){t.clipboardData.setData("application/my-custom-format",this.richText.innerHTML);return}const a=this.chat.getWrapNode(n),c=this.chat.getWrapNode(o),p=this.chat.getMarkNode(n),h=this.chat.getMarkNode(o),d=Array.prototype.indexOf.call(a.childNodes,p),f=Array.prototype.indexOf.call(c.childNodes,h);if(a===c&&a.parentNode===this.richText){const l=d>f,m=Array.prototype.filter.call(a.childNodes,(v,N)=>l?N<d&&N>f:N>d&&N<f).map(v=>v.cloneNode(!0)),E=l?n.textContent.slice(0,e.anchorOffset):n.textContent.slice(e.anchorOffset),C=l?o.textContent.slice(e.focusOffset):o.textContent.slice(0,e.focusOffset),b=this.chat.getGridElm(!0),w=this.chat.getGridElm(!0);E&&(b.childNodes[0].innerHTML=E,b.childNodes[0].setAttribute("data-set-empty","false")),C&&(w.childNodes[0].innerHTML=C,w.childNodes[0].setAttribute("data-set-empty","false")),l?(m.unshift(w),m.push(b)):(m.unshift(b),m.push(w));let T=document.createElement("div");const A=this.chat.setWrapNodeByMark(m);T.appendChild(A),t.clipboardData.setData("application/my-custom-format",T.innerHTML),T=null;return}if(a.parentNode===this.richText&&c.parentNode===this.richText){const l=Array.prototype.indexOf.call(this.richText.childNodes,a),m=Array.prototype.indexOf.call(this.richText.childNodes,c),E=l>m,C=Array.prototype.filter.call(this.richText.childNodes,(x,y)=>E?y<l&&y>m:y>l&&y<m).map(x=>x.cloneNode(!0)),b=E?n.textContent.slice(0,e.anchorOffset):n.textContent.slice(e.anchorOffset),w=E?o.textContent.slice(e.focusOffset):o.textContent.slice(0,e.focusOffset),T=this.chat.getGridElm(!0),A=this.chat.getGridElm(!0);b&&(T.childNodes[0].innerHTML=b,T.childNodes[0].setAttribute("data-set-empty","false")),w&&(A.childNodes[0].innerHTML=w,A.childNodes[0].setAttribute("data-set-empty","false"));const v=Array.prototype.filter.call(a.childNodes,(x,y)=>E?y<d:y>d).map(x=>x.cloneNode(!0)),N=Array.prototype.filter.call(c.childNodes,(x,y)=>E?y>f:y<f).map(x=>x.cloneNode(!0));if(E){v.push(T),N.unshift(A);const x=this.chat.setWrapNodeByMark(v),y=this.chat.setWrapNodeByMark(N);C.push(x),C.unshift(y)}else{v.unshift(T),N.push(A);const x=this.chat.setWrapNodeByMark(v),y=this.chat.setWrapNodeByMark(N);C.unshift(x),C.push(y)}let I=document.createElement("div");Array.prototype.forEach.call(C,x=>{I.appendChild(x)}),t.clipboardData.setData("application/my-custom-format",I.innerHTML),I=null;return}}async removeRange(){window.getSelection().getRangeAt(0).deleteContents(),await k(50),this.chat.updateGrid(),this.showPlaceholder()}updateUserList(t=void 0,e){t&&(this.userList=this.getRuleUserList(t)),e||(this.base64Images={}),this.needDialog&&(this.deviceInfo.isPc?this.updatePCUser():this.updateH5User())}getRuleUserList(t){if(!L(t,"Array"))throw new Error("参数值userList：类型值应为Array！");this.targetUserList=JSON.parse(JSON.stringify(t||[]));const e=Object.create(null);return e[this.userProps.id]="isALL",e[this.userProps.name]=this.callEveryLabel,this.targetUserList.unshift(e),(t==null?void 0:t.map((s,i)=>{const r=s[this.userProps.id];if(!r&&r!==0)throw new Error(`参数值userList：下标第${i}项${this.userProps.id}值异常！`);return s.name=String(s[this.userProps.name]||""),s.pinyin=String(s[this.userProps.pinyin]||""),s.id=String(r),s.avatar=String(s[this.userProps.avatar]||""),s}))||[]}getElmBlock(t){return t&&t.style.display==="block"}domElmShow(t,e=!1){t&&(t.className=t.className.replace(/ chat-view-show| chat-view-hidden/g,""),e?(t.style.display="block",t.className+=" chat-view-show"):t.style.display="none")}getUserHtmlTemplate(t,e){const s=document.createElement("span");if(s.setAttribute("class",`call-user-dialog-item-sculpture ${e.avatar?"is-avatar":""}`),e.avatar){const r=new Image;r.alt="";const n=this.base64Images[e.id];n?r.src=n:(r.src=String(e.avatar),r.setAttribute("crossOrigin","Anonymous"),r.onload=()=>{const o=document.createElement("canvas");o.width=48,o.height=48;const a=o.getContext("2d");a&&(a.drawImage(r,0,0,o.width,o.height),this.base64Images[e.id]=o.toDataURL("image/png",1))}),s.appendChild(r)}else s.innerHTML=`<span style="transform: scale(0.75)">${e.name.slice(-2)}</span>`;t.appendChild(s);const i=document.createElement("span");i.setAttribute("class","call-user-dialog-item-name"),i.innerHTML=e.name,t.appendChild(i)}hasPc(){this.initCheckbox(),this.initCallUser(),window.addEventListener("click",this.winClick),window.addEventListener("keydown",this.winKeydown)}initCheckbox(){this.checkboxElm=document.createElement("div"),this.checkboxElm.setAttribute("class","checkbox-dialog"),this.domElmShow(this.checkboxElm),this.checkboxElm.innerHTML=`
      <div class="checkbox-dialog-container">
        <div class="checkbox-dialog-container-header">
            <span>选择要@的人</span>
            <span class="checkbox-dialog-container-header-close">⛌</span>
        </div>
        <div class="checkbox-dialog-container-body">
            <div class="checkbox-dialog-left-box">
                <div class="checkbox-dialog-search">
                    <input class="checkbox-dialog-search-input" placeholder="搜索人员名称" type="text">

                    <div data-set-remark="搜索下拉" class="checkbox-dialog-search-group"></div>
                </div>

                <div data-set-remark="反显选取的人员" class="checkbox-dialog-tags"></div>

                <div class="checkbox-dialog-option">
                    <button class="checkbox-dialog-option-btn btn-submit">确定</button>
                    <button class="checkbox-dialog-option-btn btn-close">取消</button>
                </div>
            </div>
            
            <div class="checkbox-dialog-right-box">
                <div class="checkbox-dialog-right-box-title">研讨成员列表</div>

                <div data-set-remark="多选人员列表" class="checkbox-dialog-check-group"></div>
            </div>
        </div>
      </div>
    `,document.body.appendChild(this.checkboxElm),this.checkGroupElm=this.checkboxElm.querySelector(".checkbox-dialog-check-group"),this.searchResultElm=this.checkboxElm.querySelector(".checkbox-dialog-search-group"),this.searchElm=this.checkboxElm.querySelector(".checkbox-dialog-search-input"),this.tagsElm=this.checkboxElm.querySelector(".checkbox-dialog-tags");const t=()=>{this.domElmShow(this.checkboxElm),this.isExternalCallPopup=!1},e=this.checkboxElm.querySelector(".checkbox-dialog-container-header-close"),s=this.checkboxElm.querySelector(".btn-close");e.onclick=t,s.onclick=t;const i=this.checkboxElm.querySelector(".btn-submit");i.onclick=async()=>{await this.batchSetTag(this.checkboxRows),t(),this.chat.viewIntoPoint()},this.domElmShow(this.searchResultElm),this.searchResultElm.onclick=r=>{r.stopPropagation()},this.searchElm.onclick=r=>{r.stopPropagation()},this.searchElm.oninput=r=>{this.searchResultElm.innerHTML="";const n=String(r.target.value||"").replace(/'/g,"");if(!n){this.domElmShow(this.searchResultElm);return}const o=this.searchUserList(n),a=document.createDocumentFragment();if(o.forEach(c=>{const p=document.createElement("div");p.setAttribute("class","checkbox-dialog-check-item"),p.setAttribute("data-set-value",c.id);const h=document.createElement("div");h.setAttribute("class","checkbox-dialog-check-item-label"),this.getUserHtmlTemplate(h,c),p.appendChild(h),p.onclick=()=>{this.domElmShow(this.searchResultElm);const d=p.getAttribute("data-set-value")||"";if(this.searchElm.value="",this.checkboxRows.some(l=>l.id===d))return;const f=this.userList.find(l=>l.id===d);f&&this.checkboxRows.push(f),Array.prototype.some.call(this.checkGroupElm.children,(l,m)=>{if(m===0&&this.checkboxRows.length===this.userList.length)return l.className+=" checkbox-dialog-check-item-check",!1;if(l.getAttribute("data-set-value")===d)return l.className+=" checkbox-dialog-check-item-check",!0}),this.updateTags()},a.appendChild(p)}),!o.length){const c=document.createElement("div");c.setAttribute("class","checkbox-dialog-search-empty"),c.innerText=this.searchEmptyLabel,a.appendChild(c)}this.searchResultElm.appendChild(a),this.domElmShow(this.searchResultElm,!0)}}searchUserList(t,e){return(e||this.userList).filter(s=>M(s.name,s.pinyin||"",t).length>0)}updateTags(){const t=this.checkboxRows.map(n=>n.id),e=[],s=[];Array.prototype.forEach.call(this.tagsElm.children,n=>{const o=n.getAttribute("data-set-value");t.indexOf(o)===-1?s.push(n):e.push(o)}),s.forEach(n=>{this.tagsElm.removeChild(n)});const i=this.checkboxRows.filter(n=>e.indexOf(n.id)===-1);if(!i.length)return;const r=document.createDocumentFragment();i.forEach(n=>{const o=document.createElement("div");o.setAttribute("class","checkbox-dialog-tag-item"),o.setAttribute("data-set-value",n.id),o.innerHTML=`
        <span>${n.name}</span>
      `;const a=document.createElement("span");a.setAttribute("class","checkbox-dialog-tag-item-close"),a.innerHTML="⛌",a.onclick=()=>{const c=o.getAttribute("data-set-value");this.checkboxRows=this.checkboxRows.filter(p=>p.id!==c),this.tagsElm.removeChild(o),Array.prototype.some.call(this.checkGroupElm.children,(p,h)=>{if(h===0)return p.className=p.className.replace(/ checkbox-dialog-check-item-check/g,""),!1;if(p.getAttribute("data-set-value")===c)return p.className=p.className.replace(/ checkbox-dialog-check-item-check/g,""),!0})},o.appendChild(a),r.appendChild(o)}),this.tagsElm.appendChild(r)}initCallUser(){this.dialogElm=document.createElement("div"),this.dialogElm.setAttribute("class","call-user-dialog"),this.domElmShow(this.dialogElm);const t=document.createElement("div");t.setAttribute("class","call-user-dialog-header"),t.innerHTML=`
        <span class="call-user-dialog-header-title">群成员</span>
    `,this.dialogCheckElm=document.createElement("span"),this.dialogCheckElm.setAttribute("class","call-user-dialog-header-check"),this.domElmShow(this.dialogCheckElm,this.userList.length>0),this.dialogCheckElm.innerText="多选",this.dialogCheckElm.onclick=()=>{this.showPCCheckDialog(),this.isExternalCallPopup=!1},t.appendChild(this.dialogCheckElm),this.dialogElm.appendChild(t),this.dialogMainElm=document.createElement("div"),this.dialogMainElm.setAttribute("class","call-user-dialog-main"),this.dialogElm.appendChild(this.dialogMainElm),this.updateUserList();const e=document.createElement("div");e.setAttribute("class","call-user-dialog-footer"),this.dialogElm.appendChild(e),document.body.appendChild(this.dialogElm)}resizeUserTool(){this.toolUserList&&(this.userList=this.toolUserList),this.toolUserList=void 0,this.updateUserList(this.userList,!0)}updatePCUser(){this.dialogMainElm.innerHTML="",this.dialogActiveItemElm=void 0;const t=this.userList&&this.userList.length>0,e=document.createDocumentFragment();if(this.domElmShow(this.dialogCheckElm),!this.toolUserList&&t&&(this.domElmShow(this.dialogCheckElm,!0),this.needCallEvery)){const i=document.createElement("div");i.setAttribute("class","call-user-dialog-item"),i.setAttribute("data-set-id","isALL"),this.userSelectStyleAndEvent(i,{[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}),i.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">${this.callEveryLabel}(${this.userList.length})</span>
      `,e.appendChild(i)}this.userList.forEach(i=>{const r=document.createElement("div");r.setAttribute("class","call-user-dialog-item"),r.setAttribute("data-set-id",i.id),this.userSelectStyleAndEvent(r,i),this.getUserHtmlTemplate(r,i),e.appendChild(r)}),this.dialogMainElm.appendChild(e),this.callUserDialogMap(),this.checkGroupElm.innerHTML=`
                    <div class="checkbox-dialog-check-item" data-set-value="ALL">
                        <input type="checkbox" value>
                        <span class="checkbox-dialog-check-item-inner"></span>
                        <div class="checkbox-dialog-check-item-label">${this.checkAllLabel}</div>
                    </div>`;const s=document.createDocumentFragment();this.userList.forEach(i=>{const r=document.createElement("div");r.setAttribute("class","checkbox-dialog-check-item"),r.setAttribute("data-set-value",i.id),r.innerHTML=`
          <input type="checkbox" value>
          <span class="checkbox-dialog-check-item-inner"></span>
      `,this.getUserHtmlTemplate(r,i),s.appendChild(r)}),this.checkGroupElm.appendChild(s),this.checkGroupElm&&this.checkGroupElm.children.length&&Array.prototype.forEach.call(this.checkGroupElm.children,i=>{i.onclick=()=>{const r=i.getAttribute("data-set-value")||"",n=this.userList.find(o=>o.id===r);i.className.indexOf("checkbox-dialog-check-item-check")!==-1?(i.className=i.className.replace(/ checkbox-dialog-check-item-check/g,""),r!=="ALL"&&(this.checkboxRows=this.checkboxRows.filter(o=>o.id!==r))):(i.className+=" checkbox-dialog-check-item-check",r!=="ALL"&&n&&this.checkboxRows.push(n)),r==="ALL"?(Array.prototype.forEach.call(this.checkGroupElm.children,o=>{o.className=i.className}),this.checkboxRows=i.className.indexOf("checkbox-dialog-check-item-check")!==-1?this.userList.map(o=>o):[]):this.checkboxRows.length===this.userList.length?this.checkGroupElm.children[0].className+=" checkbox-dialog-check-item-check":this.checkGroupElm.children[0].className=this.checkGroupElm.children[0].className.replace(/ checkbox-dialog-check-item-check/g,""),this.updateTags()}})}userSelectStyleAndEvent(t,e){t.addEventListener("click",async s=>{s.stopPropagation(),this.upDateActiveItem(t),this.toolUserList&&this.toolUserList.length>0?await this.matchSetTag(e):await this.onceSetTag(e),this.exitDialog()})}callUserDialogMap(){this.itemShowList=[],Array.prototype.forEach.call(this.dialogMainElm.children||[],(t,e)=>{this.itemShowList.push({index:e,elm:t})})}ruleCanShowPointDialog(){this.userList.length>0&&this.chat.showAt()&&(this.startOpenIndex=this.chat.cursorIndex,this.showPCDialog())}showPCDialog(){this.domElmShow(this.dialogElm,!0);let t="0",e="100%";this.upDateActiveItem(this.dialogMainElm.firstElementChild,!0);const s=this.chat.getRangeRect(),{clientWidth:i,clientHeight:r}=this.dialogElm;s.x>window.innerWidth-i&&(s.x=s.x-i-16,t="100%"),s.y<r&&(s.y=r+s.y,e="0"),this.dialogElm.style.transformOrigin=`${t} ${e}`,this.dialogElm.style.left=s.x+6+"px",this.dialogElm.style.bottom=`calc(100% - ${s.y}px)`,this.dialogElm.style.opacity="1"}showPCCheckDialog(){this.winClick(),this.checkboxRows=[],this.domElmShow(this.checkboxElm,!0),this.tagsElm.scrollTop=0,this.checkGroupElm.scrollTop=0,this.searchElm.value="",Array.prototype.forEach.call(this.checkGroupElm.children,t=>{t.className="checkbox-dialog-check-item"}),this.updateTags(),this.isExternalCallPopup=!0}async showPCPointDialog(){this.insertText("@"),this.startOpenIndex=this.chat.cursorIndex,window.removeEventListener("click",this.winClick),this.showPCDialog(),await k(50),window.addEventListener("click",this.winClick)}moveActiveItem(t){if(!this.dialogActiveItemElm||this.itemShowList.length===0)return;let e=0;const s=this.dialogActiveItemElm.getAttribute("data-set-id");this.itemShowList.some(r=>{const n=r.elm.getAttribute("data-set-id");return e=r.index,s===n});const i=this.itemShowList.map(r=>r.index);if(t==="down"&&e!==this.itemShowList[this.itemShowList.length-1].index){const r=this.itemShowList[i.indexOf(e)+1];r&&this.upDateActiveItem(r.elm,!0)}else if(t==="up"&&e!==this.itemShowList[0].index){const r=this.itemShowList[i.indexOf(e)-1];r&&this.upDateActiveItem(r.elm,!0)}}upDateActiveItem(t,e=!1){this.dialogActiveItemElm&&(this.dialogActiveItemElm.className=this.dialogActiveItemElm.className.replace(/ call-user-dialog-item-active/g,"")),this.dialogActiveItemElm=t,t&&(t.className+=" call-user-dialog-item-active",e&&t.scrollIntoView({block:"center"}))}exitDialog(){this.toolUserList&&this.resizeUserTool(),this.upDateActiveItem(),this.domElmShow(this.dialogElm)}hasH5(){this.dialogH5Elm=document.createElement("div"),this.dialogH5Elm.setAttribute("class","call-user-popup"),this.dialogH5Elm.innerHTML=`
      <div class="call-user-popup-main">
        <div class="call-user-popup-header">
            <span class="popup-show">收起</span>
            <span class="popup-title">选择提醒的人</span>
            <span class="popup-check">确定</span>
        </div>
        
        <div class="call-user-popup-search">
            <svg class="icon-search"
                 style="vertical-align: middle;fill: currentColor;overflow: hidden;"
                 viewBox="0 0 1024 1024" version="1.1"
                 xmlns="http://www.w3.org/2000/svg"
                 p-id="4209">
                <path d="M684.8 223.530667a326.272 326.272 0 0 1 24.96 433.621333c2.645333 2.133333 5.290667 4.48 7.850667 7.04L870.4 817.066667c24.789333 24.746667 32.896 56.832 18.133333 71.594666-14.762667 14.805333-46.848 6.656-71.637333-18.090666l-152.789333-152.832a106.282667 106.282667 0 0 1-7.210667-7.936 326.101333 326.101333 0 0 1-433.109333-25.173334c-127.445333-127.445333-127.573333-333.952-0.256-461.269333 127.36-127.36 333.866667-127.232 461.269333 0.213333zM275.328 275.114667a252.885333 252.885333 0 0 0 0.256 357.632 252.885333 252.885333 0 0 0 357.632 0.256 252.885333 252.885333 0 0 0-0.256-357.632 252.885333 252.885333 0 0 0-357.632-0.256z"
                      fill="#9B9B9B"
                      p-id="4210"></path>
            </svg>
            <input class="call-user-popup-search-input"
                   placeholder="搜索人员名称"
                   type="text">
        </div>
        
        <div class="call-user-popup-body">
        </div>
      </div>
    `;const t=async()=>{this.dialogH5Elm.className=this.dialogH5Elm.className.replace(/ chat-view-show/g," chat-view-hidden"),this.dialogH5SearchElm.value="",await k(260),this.domElmShow(this.dialogH5Elm),this.chat.restCursorPos(this.chat.vnode,this.chat.cursorIndex),this.isExternalCallPopup=!1,this.chat.viewIntoPoint()};this.dialogH5Elm.onclick=t,this.dialogH5Elm.querySelector(".call-user-popup-main").onclick=e=>{e.stopPropagation()},this.dialogH5ShowElm=this.dialogH5Elm.querySelector(".popup-show"),this.dialogH5ShowElm.onclick=t,this.dialogH5CheckElm=this.dialogH5Elm.querySelector(".popup-check"),this.dialogH5CheckElm.onclick=async()=>{const e=this.dialogH5Elm.querySelectorAll(".user-popup-check-item-check")||[];if(e.length===0){await t();return}if(Array.prototype.some.call(e,r=>r.getAttribute("data-set-id")==="isALL")){await this.onceSetTag({[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}),await t();return}const s=Array.prototype.map.call(e,r=>r.getAttribute("data-set-id")),i=this.userList.filter(r=>s.includes(r.id));await this.batchSetTag(i),await t()},this.dialogH5MainElm=this.dialogH5Elm.querySelector(".call-user-popup-body"),this.updateUserList(),this.dialogH5SearchElm=this.dialogH5Elm.querySelector(".call-user-popup-search-input"),this.dialogH5SearchElm.oninput=e=>{const s=String(e.target.value||"").replace(/'/g,"");Array.prototype.forEach.call(this.dialogH5MainElm.children,i=>{if(!s){i.style.display="";return}const r=i.getAttribute("data-set-name")||"",n=i.getAttribute("data-set-pinyin")||"";i.style.display=M(r,n,s).length>0?"":"none"})},this.domElmShow(this.dialogH5Elm),document.body.appendChild(this.dialogH5Elm)}updateH5User(){this.dialogH5MainElm.innerHTML="",this.domElmShow(this.dialogH5CheckElm,this.userList.length>0);const t=this.userList&&this.userList.length>0,e=document.createDocumentFragment(),s=document.createElement("span");if(s.innerHTML=`
        <input type="checkbox" value>
        <span class="user-popup-check-item-inner"></span>
    `,t){const i=document.createElement("div");this.needCallEvery&&(i.setAttribute("class","call-user-popup-item"),i.setAttribute("data-set-id","isALL"),i.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">${this.callEveryLabel}(${this.userList.length})</span>
      `,i.appendChild(s.cloneNode(!0)),i.onclick=()=>{const r=i.className.indexOf("user-popup-check-item-check")===-1;Array.prototype.forEach.call(this.dialogH5MainElm.children,n=>{r?n.className+=" user-popup-check-item-check":n.className=n.className.replace(/ user-popup-check-item-check/g,"")})},e.appendChild(i)),this.userList.forEach((r,n)=>{const o=document.createElement("div");o.setAttribute("class","call-user-popup-item"),o.setAttribute("data-set-id",r.id),o.setAttribute("data-set-name",r.name),o.setAttribute("data-set-pinyin",r.pinyin||""),this.getUserHtmlTemplate(o,r),o.appendChild(s.cloneNode(!0)),e.appendChild(o),o.onclick=a=>{o.className.indexOf("user-popup-check-item-check")===-1?(o.className+=" user-popup-check-item-check",i.className+=Array.prototype.every.call(this.dialogH5MainElm.children,p=>p.className.indexOf("user-popup-check-item-check")!==-1||p.getAttribute("data-set-id")==="isALL")?" user-popup-check-item-check":""):(o.className=o.className.replace(/ user-popup-check-item-check/g,""),i.className=i.className.replace(/ user-popup-check-item-check/g,""))}})}this.dialogH5MainElm.appendChild(e)}showH5Dialog(){this.richText&&this.richText.blur(),Array.prototype.forEach.call(this.dialogH5MainElm.children,t=>{t.style.display="",t.className=t.className.replace(/ user-popup-check-item-check/g,"")}),this.domElmShow(this.dialogH5Elm,!0),this.dialogH5MainElm.scrollTop=0,this.isExternalCallPopup=!0}updateConfig({copyType:t,userProps:e,userList:s,uploadImage:i,needCallEvery:r,placeholder:n,maxLength:o,needCallSpace:a,wrapKeyFun:c,sendKeyFun:p}={}){if(t){if(!L(t,"Array"))throw new Error("参数值copyType：类型值应为Array！");this.copyType=t.map(h=>{if(["text","image"].indexOf(h)===-1)throw new Error(`参数值copyType：无效的参数值"${h}"！`);return h})}if(e){if(!L(e,"Object"))throw new Error("参数值copyType：类型值应为Object！");this.userProps=Object.assign({},{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"},e)}if(i){if(typeof i!="function")throw new Error("参数值uploadImage：参数类型错误，参数类型应为Function！");this.uploadImage=i}if(n&&(this.placeholderElm.innerText=n),o!==void 0){if(!L(o,"Number"))throw new Error("参数值maxLength：类型值应为Number！");this.maxLength=o,this.ruleMaxLength()}if((r!==void 0||s)&&(this.needCallEvery=String(r)!=="false",this.updateUserList(s)),a!==void 0&&this.chat.setCallSpace(a),c){if(typeof c!="function")throw new Error("参数值wrapKeyFun：参数类型错误，参数类型应为Function！");this.wrapKeyFun=c}if(p){if(typeof p!="function")throw new Error("参数值sendKeyFun：参数类型错误，参数类型应为Function！");this.sendKeyFun=p}}enterSend(){this.triggerChatEvent("enterSend")}insertHtml(t){const e=document.createElement("span");e.innerHTML=t,e.className="chat-set-html";const s=this.chat.createNewDom(e);return this.chat.replaceRegContent(s),this.chat.viewIntoPoint(),this.richTextInput(),s}insertInsideHtml(t){let e=document.createElement("div");if(e.innerHTML=t,!e.children.length)return;const s=this.chat.vnode,i=this.chat.getWrapNode(s);if(e.children.length===1)this.chat.gridMerge(i,e.children[0],!0);else{this.chat.gridMerge(i,e.children[0],!0);const r=Array.prototype.slice.call(e.children,1);let n=i;Array.prototype.forEach.call(r,(o,a)=>{if(n.parentElement?this.richText.insertBefore(o,n.nextElementSibling):this.richText.appendChild(o),n=o,a===r.length-1){const p=o.childNodes[o.childNodes.length-1].childNodes[0].childNodes[0];this.chat.restCursorPos(p,p.textContent.length)}})}e=null,this.chat.viewIntoPoint(),this.richTextInput()}insertText(t){var p,h;if(!t)return;const e=new RegExp(`${this.chat.ZERO_WIDTH_KEY}${this.chat.VOID_KEY}`,"ig"),s=t.replace(e,"");if(!s)return;let i,r=0;const n=this.chat.vnode;n&&n.parentElement&&n.parentElement.getAttribute("data-set-richType")==="richInput"?(i=n.parentElement,r=n.textContent===this.chat.VOID_KEY?1:this.chat.cursorLeft):(i=(h=(p=this.richText)==null?void 0:p.lastChild)==null?void 0:h.lastChild,r=i.childNodes[0].textContent.length);const o=(d,f=!1)=>{const l=i.childNodes[0],m=l.textContent.split("");return m.splice(r,0,d),l.textContent=m.join("").replace(new RegExp(this.chat.VOID_KEY,"g"),()=>(r--,"")),i.setAttribute("data-set-empty","false"),i.childNodes[1]&&i.removeChild(i.childNodes[1]),this.chat.restCursorPos(l,r+d.length),f&&this.chat.viewIntoPoint(),i.parentElement.parentElement},a=(d,f=!1,l)=>{const m=this.chat.getGridElm(),E=m.childNodes[0].childNodes[0];let C=1;return d&&(E.innerHTML=d,E.setAttribute("data-set-empty","false"),C=d.length),l.nextSibling?this.richText.insertBefore(m,l.nextSibling):this.richText.appendChild(m),f&&(this.chat.restCursorPos(E.childNodes[0],C),this.chat.viewIntoPoint()),m},c=s.split(`
`);if(c.length>1){let d;c.forEach((f,l)=>{l===0?d=o(f):d=a(f,l===c.length-1,d)})}else o(s,!0);this.richTextInput()}getCallUserList(){const t=this.richText.querySelectorAll(".at-user");if(t&&t.length>0){const e=Array.prototype.map.call(t,s=>s.dataset.userId);return K(this.targetUserList,e,this.userProps.id)}else return[]}getCallUserTagList(){const t=this.richText.querySelectorAll(".at-user");return t&&t.length>0?Array.prototype.map.call(t,e=>({[this.userProps.id]:e.dataset.userId,[this.userProps.name]:e.innerText.slice(1)})):[]}clear(t){this.chat.textInnerHtmlInit(!0,t);const e={html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex};this.undoHistory=[e],this.redoHistory=[],this.richTextInput(!1)}isEmpty(t=!1){if((this.richText.querySelectorAll(".chat-tag")||[]).length>0)return!1;const s=new RegExp(`^(${this.chat.ZERO_WIDTH_KEY}|<br>|${this.chat.VOID_KEY})+$`),i=this.richText.querySelectorAll(".chat-grid-input")||[];return t?Array.prototype.every.call(i,r=>!r.innerHTML||!r.innerText||!r.innerText.trim()||s.test(r.innerHTML)):Array.prototype.every.call(i,r=>!r.innerHTML||!r.innerText||s.test(r.innerHTML))}showPlaceholder(){this.domElmShow(this.placeholderElm,this.isEmpty())}getReduceNode(t={}){const e=Object.assign({},{needUserId:!1,wrapClassName:void 0,rowClassName:void 0,imgToText:!1,identifyLink:!1},t),s=/(https?|http|ftp|file):\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]/g,r=this.richText.cloneNode(!0).querySelectorAll(".chat-grid-wrap")||[],n=document.createElement("div");return e.wrapClassName&&(n.className=e.wrapClassName),Array.prototype.forEach.call(r,(o,a)=>{const c=o.querySelectorAll(".chat-stat")||[],p=document.createElement("p");e.rowClassName&&(p.className=e.rowClassName),Array.prototype.forEach.call(c,h=>{this.chat.getNodeEmpty(h)||(h.removeAttribute("data-set-richType"),h.removeAttribute("contenteditable"),h.removeAttribute("data-set-empty"),e.needUserId||h.removeAttribute("data-user-id"),e.imgToText&&h.firstChild&&h.firstChild.tagName==="IMG"&&(h.className+=" img-to-text",h.innerHTML=`[${h.firstChild.getAttribute("data-img-text")||"元素data-img-text未定义"}]`),e.identifyLink&&h.className.indexOf("chat-grid-input")!==-1&&(h.innerHTML=h.innerHTML.replace(s,d=>`<a class="chat-grid-link" href="${d}" target="_blank">${d}</a>`)),p.appendChild(h))}),p.innerHTML||(p.innerHTML="<br>"),n.appendChild(p)}),n}getText(t={}){let e="";const s=this.getReduceNode(t);return Array.prototype.forEach.call(s.children,(i,r)=>{e=e+(r>0?`
`:"")+i.textContent}),e}getHtml(t={}){return this.getReduceNode(t).innerHTML}dispose(){const t=this.richText.parentElement;t&&(t.removeChild(this.richText),t.removeChild(this.placeholderElm)),this.needDialog&&(this.deviceInfo.isPc?(document.body.removeChild(this.dialogElm),document.body.removeChild(this.checkboxElm),window.removeEventListener("click",this.winClick),window.removeEventListener("keydown",this.winKeydown)):document.body.removeChild(this.dialogH5Elm));for(const e in this)delete this[e];Object.setPrototypeOf(this,Object)}setUserTag(t){const e=this.chat.createAtUserSpan({id:t[this.userProps.id],name:t[this.userProps.name]});this.chat.replaceRegContent(e,!1),this.chat.viewIntoPoint(),this.richTextInput()}async matchSetTag(t){await this.chat.searchCall(t,this.startOpenIndex),await this.richTextInput()}async onceSetTag(t){await this.chat.onceCall({id:t[this.userProps.id],name:t[this.userProps.name]}),await this.richTextInput()}async batchSetTag(t){if(t.length===1){this.isExternalCallPopup?await this.chat.onceExternalCall(t[0]):await this.onceSetTag(t[0]);return}let e="";for(let s=0;s<=t.length-1;){const i={id:t[s][this.userProps.id],name:t[s][this.userProps.name]};s===0?e=this.isExternalCallPopup?await this.chat.onceExternalCall(i):await this.chat.onceCall(i,!0):s===t.length-1?await this.chat.onceCall(i,!1,e):await this.chat.onceCall(i,!0),s++}await this.richTextInput()}disabled(){this.richText.setAttribute("contenteditable","false"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,"")+" chat-rich-text-disabled"}enable(){this.richText.setAttribute("contenteditable","true"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,""),this.chat.setRangeLastText()}undo(){if(!this.doOverHistory||!this.undoHistory||this.undoHistory.length<=1)return;const t=this.undoHistory[this.undoHistory.length-2],e=this.undoHistory[this.undoHistory.length-1];this.redoHistory.push(e),this.undoHistory.pop(),this.setChatHistory(t,!1)}redo(){if(!this.doOverHistory||!this.redoHistory||this.redoHistory.length<1)return;const t=this.redoHistory[this.redoHistory.length-1];this.redoHistory.pop(),this.setChatHistory(t,!0)}ruleMaxLength(){if(this.isEmpty()||this.maxLength===void 0){this.textLength=0;return}let t=0,e=0;const s=[];Array.prototype.some.call(this.richText.children,(r,n)=>{const{nodeInfos:o,nodeTextLength:a}=this.getGirdNodeTextInfo(r);if(t+=a,s.push(o),e=n,t>=this.maxLength)return!0});const i=[];Array.prototype.forEach.call(this.richText.children,(r,n)=>{n>e&&i.push(r)}),i.forEach(r=>this.richText.removeChild(r)),this.deepDelGirdText(s,t)}getGirdNodeTextInfo(t){const e=[];let s=0;if(t.children.length===1&&t!==t.parentElement.children[0]){const i=t.children[0],r=(i.textContent||"").replace(new RegExp(this.chat.VOID_KEY,"g"),"");s+=r.length||1,e[0]={node:i,textLength:r.length||1,type:"richMark"}}else Array.prototype.forEach.call(t.children,(i,r)=>{if(i.getAttribute("data-set-richType")==="richMark"){const o=(i.textContent||"").replace(new RegExp(this.chat.VOID_KEY,"g"),"");s+=o.length,e[r]={node:i,textLength:o.length,type:"richMark"}}else{const o=(i.textContent||"").replace(new RegExp(this.chat.VOID_KEY,"g"),"");s+=o.length||1,e[r]={node:i,textLength:o.length||1,type:"chatTag"}}});return{nodeInfos:e,nodeTextLength:s}}deepDelGirdText(t,e){if(e>this.maxLength){const s=t[t.length-1];t.pop(),this.deepDelNode(s,t,e)}else this.textLength=e}deepDelNode(t,e,s){const i=t[0].node.parentElement;if(s>this.maxLength){let r=s-this.maxLength,n=t[t.length-1];if(n.type==="richMark")if(n.textLength===0||r>=n.textLength)i.removeChild(n.node),t.pop(),r=r-n.textLength,n=t[t.length-1],i.removeChild(n.node),t.pop(),r=r-n.textLength;else{const o=n.node.childNodes[0];o.textContent=o.textContent.slice(0,n.textLength-r),o.textContent===0&&(o.setAttribute("data-set-empty","true"),o.innerHTML=`${this.chat.VOID_KEY}<br>`),r=0}else i.removeChild(n.node),t.pop(),r=r-n.textLength;r>0?t.length>0?this.deepDelNode(t,e,r+this.maxLength):(this.richText.appendChild(i),this.deepDelGirdText(e,r+this.maxLength)):(this.textLength=this.maxLength+r,this.enable())}}setChatHistory(t,e){this.doOverHistory=!1;const{html:s,gridIndex:i,markIndex:r,cursorIndex:n}=t;this.richText.innerHTML=s;const o=this.richText.childNodes[i].childNodes[r].childNodes[0].childNodes[0];this.chat.restCursorPos(o,n),this.chat.viewIntoPoint(),this.richTextInput(e).then(()=>{this.doOverHistory=!0})}revisePCPointDialogLabel(t={}){const e=Object.assign({},{title:"群成员",checkLabel:"多选"},t);this.dialogElm.querySelector(".call-user-dialog-header-title").innerText=e.title,this.dialogCheckElm.innerText=e.checkLabel}revisePCCheckDialogLabel(t={}){const e=Object.assign({},{title:"选择要@的人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",userTagTitle:"研讨成员列表",checkAllLabel:"全选",confirmLabel:"确定",cancelLabel:"取消"},t);this.checkboxElm.querySelector(".checkbox-dialog-container-header").children[0].innerText=e.title,this.searchElm.setAttribute("placeholder",e.searchPlaceholder||""),this.searchEmptyLabel=e.searchEmptyLabel||"",this.checkboxElm.querySelector(".checkbox-dialog-right-box-title").innerText=e.userTagTitle,this.checkAllLabel=e.checkAllLabel||"",this.checkGroupElm.children[0].children[2].innerText=this.checkAllLabel,this.checkboxElm.querySelector(".btn-submit").innerText=e.confirmLabel,this.checkboxElm.querySelector(".btn-close").innerText=e.cancelLabel}reviseH5DialogLabel(t){const e=Object.assign({},{title:"选择提醒的人",searchPlaceholder:"搜素人员名称",confirmLabel:"确定",cancelLabel:"收起"},t);this.dialogH5Elm.querySelector(".popup-title").innerText=e.title,this.dialogH5SearchElm.setAttribute("placeholder",e.searchPlaceholder||""),this.dialogH5CheckElm.innerText=e.confirmLabel,this.dialogH5ShowElm.innerText=e.cancelLabel}reverseAnalysis(t,e){const s=document.createElement("div");s.innerHTML=t;const i=s.children;Array.prototype.forEach.call(i,r=>{r.className="chat-grid-wrap",r.setAttribute("data-set-richType","richBox");const n=r.children,o={},a=[];Array.prototype.forEach.call(n,(h,d)=>{if(h.className.indexOf("chat-grid-input")!==-1){const m=h.innerText;h.className="",h.setAttribute("data-set-richType","richMark"),h.innerHTML=`<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="false">${m}</span>`;return}if(h.tagName==="BR"){const m=this.chat.getGridElm(!0);r.removeChild(h),r.appendChild(m);return}const f=h.cloneNode(!0);f.setAttribute("contenteditable","false");const l=document.createElement("span");l.className="chat-tag",l.setAttribute("contenteditable","false"),l.setAttribute("data-set-richType","chatTag"),l.appendChild(f),o[d]=l,d!==n.length-1?n[d+1].className.indexOf("chat-grid-input")===-1&&a.push(d):a.push(d),d===0&&a.push(-1)});for(const h in o){const d=Number(h);d===n.length-1?(r.removeChild(n[d]),r.appendChild(o[h])):(r.insertBefore(o[h],n[d+1]),r.removeChild(n[d]))}const c=[],p=r.children;a.forEach(h=>{h===p.length-1?c.push("isEnd"):c.push(p[h+1])}),c.forEach(h=>{const d=this.chat.getGridElm(!0);if(h==="isEnd")r.appendChild(d);else{const f=d.children[0];f.removeChild(f.childNodes[1]),r.insertBefore(d,h)}})}),e?(this.enable(),this.insertInsideHtml(s.innerHTML)):(this.richText.innerHTML=s.innerHTML,this.enable(),this.chat.viewIntoPoint(),this.richTextInput())}addEventListener(t,e){this.chatEventModule[t].push(e)}removeEventListener(t,e){const s=this.chatEventModule[t],i=s.indexOf(e);i!==-1&&s.splice(i,1)}triggerChatEvent(t,...e){let s;return this.chatEventModule[t].forEach(i=>{i&&(s?i(...e):s=i(...e))}),s}ruleChatEvent(t,e,...s){(this.triggerChatEvent(e,...s)+"").toUpperCase()!=="PREVENT"&&(t&&t.bind(this)(),t=null)}}if(!window)throw new Error("非web环境！");window.console&&window.console.log&&console.log(" %c ".concat("ChatArea"," %c v4.6.3 "),"background: #269AFF; color: #FFFFFF; padding: 4px 0; border-radius: 4px 0px 0px 4px; font-style: italic;","background: #FFFFFF; color: #269AFF; padding: 2px 0; border-radius: 0px 4px 4px 0px; font-style: italic; border: 2px solid #269AFF;");window.ChatArea=U;
