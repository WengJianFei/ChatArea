var F=Object.defineProperty;var P=(m,t,e)=>t in m?F(m,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[t]=e;var u=(m,t,e)=>(P(m,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class H{constructor(t){u(this,"richText");u(this,"vnode");u(this,"cursorIndex");u(this,"cursorLeft");u(this,"needCallSpace",!1);u(this,"pointEndIME");u(this,"IME_KEY","​_");this.richText=t,this.textInnerHtmlInit(),this.richText.focus()}textInnerHtmlInit(t=!1,e){if(t||this.getNodeEmpty(this.richText)){this.richText.innerHTML="";const s=this.getGridElm();this.richText.appendChild(s);const i=s.children[0].children[0];e&&(i.innerHTML=e,i.setAttribute("data-set-empty","false"));const r=i.childNodes[0];this.restCursorPos(r,r.textContent==="\uFEFF"?1:r.textContent.length)}}onceCall(t,e=!1,s=""){return new Promise(i=>{const r=this.createAtUserSpan(t),n=this.replaceRegContent(r,!0,e,s)||"";i(n)})}searchCall(t,e){return new Promise(s=>{const i=this.createAtUserSpan(t);this.replaceRegContent(i,e),s()})}onceExternalCall(t){return new Promise(e=>{const s=this.createAtUserSpan(t),i=this.replaceRegContent(s,!1,!0)||"";e(i)})}upDataNodeOrIndex(){var n,o,a;const{focusNode:t,focusOffset:e,anchorOffset:s}=window.getSelection(),i=(t==null?void 0:t.parentNode)||void 0;!i||!i.getAttribute||i.getAttribute("data-set-richType")!=="richInput"||((a=(o=(n=t==null?void 0:t.parentNode)==null?void 0:n.parentNode)==null?void 0:o.parentNode)==null?void 0:a.parentNode)!==this.richText||(this.vnode=t,this.cursorIndex=e,this.cursorLeft=s<e?s:e)}showAt(){if(this.upDataNodeOrIndex(),!this.vnode||this.vnode.nodeType!==Node.TEXT_NODE)return!1;const t=this.vnode.textContent||"",e=/@([^@\s]*)$/,s=t.slice(0,this.cursorIndex),i=e.exec(s);return i&&i.length===2&&s[s.length-1]==="@"}getRangeRect(){let t=0,e=0;const s=window.getSelection().getRangeAt(0).getClientRects()[0];return s&&(t=s.x,e=s.y),{x:t,y:e}}createAtUserSpan(t){const e=document.createElement("span");return e.dataset.userId=String(t.id),e.className="at-user",e.contentEditable="false",e.textContent=`@${t.name}${this.needCallSpace?" ":""}`,this.createNewDom(e)}createNewDom(t){const e=document.createElement("span");return e.className="chat-tag",e.setAttribute("contenteditable","false"),e.setAttribute("data-set-richType","chatTag"),t.className+=" chat-stat",e.appendChild(t),e}restCursorPos(t,e){e==null?e=t.textContent==="\uFEFF"?1:0:e>t.textContent.length&&(e=t.textContent.length);const s=new Range;s.setStart(t,e),s.setEnd(t,e);const i=window.getSelection();i&&(this.vnode=t,this.cursorIndex=e,this.cursorLeft=e,i.removeAllRanges(),i.addRange(s))}setCursorPos(t,e){const s=window.getSelection();if(s.rangeCount<=0)return;const i=s.getRangeAt(0);i.setStart(t,e),i.collapse(!0),this.vnode=t,this.cursorIndex=e,this.cursorLeft=e}replaceRegContent(t,e=!1,s=!1,i=""){const r=this.vnode.textContent;let n;typeof e=="boolean"?n=r.slice(0,e?this.cursorIndex-1:this.cursorIndex):n=r.slice(0,e-1),n.length===0?(this.vnode.parentElement.setAttribute("data-set-empty",!0),this.vnode.textContent="\uFEFF"):this.vnode.textContent=n;let o=i||r.slice(this.cursorIndex);const a=this.vnode.parentNode.parentNode,c=a.nextSibling;c?a.parentNode.insertBefore(t,c):a.parentNode.appendChild(t);const d=t.previousSibling.childNodes[0],p=d.childNodes[1];p&&d.removeChild(p);const g=this.getGridElm(!0),l=g.childNodes[0];return!s&&o&&o!=="\uFEFF"&&(l.setAttribute("data-set-empty","false"),l.innerHTML=o),s&&l.childNodes[1]&&l.removeChild(l.childNodes[1]),t.nextSibling?(l.childNodes[1]&&l.removeChild(l.childNodes[1]),a.parentNode.insertBefore(g,t.nextSibling)):a.parentNode.appendChild(g),this.restCursorPos(l.childNodes[0]),o}switchRange(t){var n,o;const{focusNode:e,focusOffset:s}=window.getSelection();let i,r;if(e.nodeType===Node.TEXT_NODE){const a=e.textContent.length,c=e.parentNode.parentNode;switch(t){case"ArrowLeft":if(s>0&&e.textContent!=="\uFEFF"){r=s-1,i=e;break}const h=(n=c==null?void 0:c.previousSibling)==null?void 0:n.previousSibling;if(h)i=h.childNodes[0].childNodes[0],r=i.textContent.length;else{const p=c.parentNode.previousSibling;p&&(i=p.lastChild.childNodes[0].childNodes[0],r=i.textContent.length)}break;case"ArrowRight":if(s<a&&e.textContent!=="\uFEFF"){r=s+1,i=e;break}const d=(o=c==null?void 0:c.nextSibling)==null?void 0:o.nextSibling;if(d)i=d.childNodes[0].childNodes[0],r=i.textContent==="\uFEFF"?1:0;else{const p=c.parentNode.nextSibling;p&&(i=p.childNodes[0].childNodes[0].childNodes[0],r=i.textContent==="\uFEFF"?1:0)}break}}(r||r===0)&&this.restCursorPos(i,r)}getGridElm(t=!1){const e=document.createElement("span");if(e.setAttribute("data-set-richType","richMark"),e.innerHTML='<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="true">\uFEFF<br></span>',t)return e;const s=document.createElement("p");return s.className="chat-grid-wrap",s.setAttribute("data-set-richType","richBox"),s.appendChild(e),s}updateGrid(){const t=window.getSelection(),e=t.focusNode,s=e.parentNode,i=s.getAttribute("data-set-richType");let r,n,o,a;switch(i){case"richAllBox":if(r=e.childNodes[t.focusOffset],!r||r.getAttribute("data-set-richType")==="chatTag"){const l=this.getGridElm(!0),f=l.children[0];r?(f.removeChild(f.childNodes[1]),e.insertBefore(l,r)):e.appendChild(l),this.restCursorPos(f.childNodes[0]);break}if(r.tagName==="BR"){const l=this.getGridElm(!0),f=l.children[0];e.insertBefore(l,r),e.removeChild(r),this.restCursorPos(f.childNodes[0],f.childNodes[0].textContent.length)}break;case"richMark":const c=s.parentNode,h=Array.prototype.indexOf.call(c.childNodes,s);if(h===-1)break;if(h===0){const l=t.focusNode;l.setAttribute("data-set-empty","true"),l.innerHTML="\uFEFF<br>",r=l.childNodes[0],this.restCursorPos(r,r.textContent.length);break}let d=s.previousSibling,p;d.getAttribute("data-set-richType")==="chatTag"?(p=d.previousSibling,c.removeChild(d),c.removeChild(s)):(p=s.previousSibling,c.removeChild(s)),r=p.childNodes[0].childNodes[0],r.textContent==="\uFEFF"&&r.parentNode.appendChild(document.createElement("br")),this.restCursorPos(r,r.textContent.length);break;case"richInput":if(a=s.parentNode,o=a.parentNode,this.getNodeEmpty(s)){s.setAttribute("data-set-empty","true"),o.childNodes[o.childNodes.length-1]===a&&(s.innerHTML="\uFEFF<br>"),r=s.childNodes[0],this.restCursorPos(r,r.textContent.length);break}if(String(s.getAttribute("data-set-empty"))==="true"){s.setAttribute("data-set-empty","false");const l=[],f=[];Array.prototype.forEach.call(s.childNodes,E=>{E.nodeType===Node.TEXT_NODE&&E.textContent.indexOf("\uFEFF")!==-1?f.push(E):E.tagName==="BR"&&l.push(E)}),l.forEach(E=>{s.removeChild(E)}),f.forEach(E=>{const y=E.textContent.indexOf("\uFEFF"),N=new Range;N.setStart(E,E.textContent.indexOf("\uFEFF")),N.setEnd(E,y+1),N.deleteContents()}),r=s.childNodes[0],this.restCursorPos(r,r.textContent.length)}if(n=s.parentNode.nextSibling,n&&n.nodeType===Node.TEXT_NODE){let l=n.textContent,f=this.getGridElm(!0);f.childNodes[0].textContent=l,f.childNodes[0].setAttribute("data-set-empty","false"),n.parentNode.insertBefore(f,n),n.parentNode.removeChild(n),n=f}n&&n.getAttribute("data-set-richType")==="richMark"&&this.markMerge(s.parentNode,n);break}}getNodeEmpty(t){const e=new RegExp("^(​|<br>|\uFEFF)+$");return!t.innerHTML||e.test(t.innerHTML)}setWrap(){const t=window.getSelection();let{focusNode:e,focusOffset:s}=t;if(e.nodeType!==Node.TEXT_NODE){if(!e.getAttribute||e.getAttribute("data-set-richType")!=="richInput")return;e=e.childNodes[0]}const i=e.textContent.slice(s),r=e.parentNode.parentNode,n=r.parentNode,o=Array.prototype.indexOf.call(n.childNodes,r),a=Array.prototype.slice.call(n.childNodes,o+1),c=this.getGridElm();let h=c.children[0].children[0].childNodes[0],d=1;(i||a.length>0)&&h.parentNode.removeChild(h.parentNode.childNodes[1]),i&&i!=="\uFEFF"&&(e.textContent=e.textContent.slice(0,s),h.textContent=(h.textContent+i).replace(/\ufeff/i,()=>(d--,"")),h.parentElement.setAttribute("data-set-empty","false")),a.forEach(l=>{n.removeChild(l),c.appendChild(l)});const p=n.lastChild.childNodes[0],g=c.lastChild.childNodes[0];if(p.childNodes.length<=1){const l=p.childNodes[0];(!l.textContent||l.textContent==="\uFEFF")&&(p.innerHTML="\uFEFF<br>",p.setAttribute("data-set-empty","true"))}if(g.parentElement.getAttribute("data-set-richType")!=="richMark")c.appendChild(this.getGridElm(!0));else if(g.childNodes.length<=1){const l=g.childNodes[0];(!l.textContent||l.textContent==="\uFEFF")&&(g.innerHTML="\uFEFF<br>",g.setAttribute("data-set-empty","true"),h=c.children[0].children[0].childNodes[0])}n.nextSibling?this.richText.insertBefore(c,n.nextSibling):this.richText.appendChild(c),this.restCursorPos(h,h.textContent==="\uFEFF"?1:d),this.viewIntoPoint()}selectRegionMerge(){const t=window.getSelection();if(t.isCollapsed||t.rangeCount<=0)return;const e=t.getRangeAt(0);if(e.startContainer.nodeType===Node.TEXT_NODE&&e.startContainer===e.endContainer){const s=e.startContainer;if(s.length===e.endOffset-e.startOffset){const i=s.parentNode,r=i.parentNode===i.parentNode.parentNode.lastChild;i.setAttribute("data-set-empty","true"),i.innerHTML=`\uFEFF${r?"<br>":""}`,this.restCursorPos(i.childNodes[0])}else e.deleteContents()}else if(e.commonAncestorContainer&&e.commonAncestorContainer.getAttribute("data-set-richType")==="richBox"){const s=e.startContainer.nodeType===Node.TEXT_NODE?e.startContainer.parentNode.parentNode:e.startContainer,i=e.endContainer.nodeType===Node.TEXT_NODE?e.endContainer.parentNode.parentNode:e.endContainer;e.deleteContents(),s.getAttribute("data-set-richType")===i.getAttribute("data-set-richType")&&this.markMerge(s,i)}else if(e.commonAncestorContainer===e.startContainer&&e.startContainer===e.endContainer)this.textInnerHtmlInit(!0);else{const s=n=>{if(n.nodeType===Node.TEXT_NODE)return n.parentNode.parentNode.parentNode;switch(n.getAttribute("data-set-richType")){case"richInput":return n.parentNode.parentNode;case"richMark":return n.parentNode;case"richBox":return n;default:return null}},i=s(e.startContainer),r=s(e.endContainer);if(!i||!r)return;e.deleteContents(),this.gridMerge(i,r)}return!0}gridElmMerge(){const t=window.getSelection(),{focusNode:e,focusOffset:s,isCollapsed:i}=t;if(s>1||!i)return!1;const r=(a,c)=>a.parentNode!==this.richText&&a!==a.parentNode.childNodes[0]?!1:Array.prototype.indexOf.call(this.richText.childNodes,a)!==-1?a:c>=6?!1:r(a.parentNode,c+1),n=r(e,0);if(!n||n===this.richText.childNodes[0]||s===1&&n.children[0].children[0].getAttribute("data-set-empty")==="false")return!1;const o=n.previousSibling;return this.gridMerge(o,n),!0}delMarkRule(){const t=window.getSelection(),e=t.focusNode,s=e.textContent,i=e.parentNode,r=i.parentNode,n=r.parentNode;if(!t.isCollapsed||i.getAttribute("data-set-richType")!=="richInput")return!1;if(s&&s.length===1&&r!==n.childNodes[0]&&(t.focusOffset!==0||s==="\uFEFF")){if(s==="\uFEFF"){const o=r.previousSibling.previousSibling;n.removeChild(r.previousSibling),n.removeChild(r);const a=o.childNodes[0],c=a.childNodes[0];c.textContent==="\uFEFF"&&o===n.lastChild&&a.appendChild(document.createElement("br")),this.restCursorPos(c,c.textContent.length)}else{i.innerHTML=r===n.lastChild?"\uFEFF<br>":"\uFEFF",i.setAttribute("data-set-empty","true");const o=i.childNodes[0];this.restCursorPos(o,1)}return!0}else if(t.focusOffset===0){const o=i.parentNode,a=o==null?void 0:o.previousSibling;return!a||a.getAttribute("data-set-richType")!=="chatTag"?!1:(this.delTag(a),!0)}}setIMESelection(){const t=window.getSelection(),e=t.focusNode,i=e.parentNode.parentNode;((i==null?void 0:i.getAttribute("data-set-richType"))||"")==="richMark"&&(this.pointEndIME=t.focusOffset,e.textContent=e.textContent.slice(0,this.pointEndIME)+this.IME_KEY+e.textContent.slice(this.pointEndIME),this.restCursorPos(e,this.pointEndIME+this.IME_KEY.length))}delMarkRuleIME(){const t=window.getSelection(),e=t.focusNode,s=e.parentNode,i=s.parentNode;if(((i==null?void 0:i.getAttribute("data-set-richType"))||"")==="richMark"){this.pointEndIME=t.focusOffset;const n=new RegExp(this.IME_KEY.slice(0,-1),"g");if(e.textContent=e.textContent.replace(n,""),this.pointEndIME>this.IME_KEY.length-1&&e.textContent!=="\uFEFF"){const o=this.pointEndIME-(this.IME_KEY.length-1);e.textContent=e.textContent.slice(0,o-1)+e.textContent.slice(o),this.setCursorPos(e,o-1)}else{if(s.getAttribute("data-set-empty")==="false"&&(e.textContent===""||e.textContent==="\uFEFF")){s.innerHTML=i===i.parentElement.lastChild?"\uFEFF<br>":"\uFEFF",s.setAttribute("data-set-empty","true");const d=s.childNodes[0];this.setCursorPos(d,1);return}const a=i.previousSibling;if(a&&a.getAttribute&&a.getAttribute("data-set-richType")==="chatTag"){this.delTag(a);return}const c=i.parentElement,h=c.previousElementSibling;h&&this.gridMerge(h,c)}}}wrapIME(){const e=window.getSelection().focusNode;if(e.getAttribute&&e.getAttribute("data-set-richType")==="richBox"){const a=e.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length);const c=e.children[0];c.tagName==="BR"&&e.removeChild(c);return}const i=e.parentNode.parentNode,r=(i==null?void 0:i.getAttribute("data-set-richType"))||"";if(r==="richMark"){const a=i.parentElement.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length)}else if(r==="richBox"){const a=i.previousSibling.lastChild.children[0].childNodes[0];a.textContent=a.textContent.slice(0,-this.IME_KEY.length)}}resetIME(t){t===" "&&(t=" "),t||(t="");const e=window.getSelection(),s=e.focusNode,r=s.parentNode.parentNode;((r==null?void 0:r.getAttribute("data-set-richType"))||"")==="richMark"&&(s.textContent=s.textContent.slice(0,e.focusOffset-this.IME_KEY.length-t.length)+t+s.textContent.slice(e.focusOffset),s.textContent=s.textContent.replace(/\u200b/g,""),this.setCursorPos(s,this.pointEndIME+t.length))}delTag(t){const e=t.previousSibling,s=t.nextSibling;t.parentNode.removeChild(t),this.markMerge(e,s)}gridMerge(t,e,s=!1){t.lastChild.getAttribute("data-set-richType")!=="richMark"&&t.appendChild(this.getGridElm(!0)),e.childNodes[0].getAttribute("data-set-richType")!=="richMark"&&e.insertBefore(this.getGridElm(!0),e.childNodes[0]);const i=t.lastChild.childNodes[0],r=i.childNodes[0];let n=r.textContent.length;Array.prototype.forEach.call(e.childNodes,a=>{t.appendChild(a.cloneNode(!0))}),e.childNodes.length>1&&i.childNodes[1]&&i.removeChild(i.childNodes[1]);const o=i.parentNode.nextSibling;if(o){const c=o.children[0].childNodes[0];c&&c.textContent!=="\uFEFF"&&(i.childNodes[1]&&i.removeChild(i.childNodes[1]),r.textContent=(r.textContent+c.textContent).replace(/\ufeff/i,()=>(n--,"")),r.parentElement.setAttribute("data-set-empty","false")),t.removeChild(o)}if(r.textContent===""&&(r.textContent="\uFEFF",r.parentNode.setAttribute("data-set-empty","true"),n=1),s){const c=t.childNodes[t.childNodes.length-1].childNodes[0].childNodes[0];this.restCursorPos(c,c.textContent.length)}else this.richText.removeChild(e),this.restCursorPos(r,n);this.viewIntoPoint()}markMerge(t,e){const i=t.children[0].childNodes[0];let r=i.textContent.length;if(e){const a=e.children[0].childNodes[0];a&&a.textContent!=="\uFEFF"&&(i.textContent=(i.textContent+a.textContent).replace(/\ufeff/i,()=>(r--,"")),i.parentElement.setAttribute("data-set-empty","false")),e.parentNode.removeChild(e)}i.textContent===""&&(i.textContent="\uFEFF",i.parentNode.setAttribute("data-set-empty","true"),r=1);const n=t.parentNode;i.textContent==="\uFEFF"&&t===n.lastChild&&(i.parentNode.appendChild(document.createElement("br")),i.parentNode.setAttribute("data-set-empty","true"),r=1),this.restCursorPos(i,r)}setCallSpace(t){this.needCallSpace=t}getWrapNode(t){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode.parentNode;switch(t.getAttribute("data-set-richType")){case"richInput":return t.parentNode.parentNode;case"richMark":return t.parentNode;case"richBox":return t}}getMarkNode(t){if(t.nodeType===Node.TEXT_NODE)return t.parentNode.parentNode;switch(t.getAttribute("data-set-richType")){case"richInput":return t.parentNode;case"richMark":return t}}getRichTextNodeIndex(t){const e=this.getMarkNode(t),s=e.parentNode;return{gridIndex:Array.prototype.indexOf.call(this.richText.childNodes,s),markIndex:Array.prototype.indexOf.call(s.childNodes,e)}}setWrapNodeByMark(t){const e=document.createElement("p");return e.className="chat-grid-wrap",e.setAttribute("data-set-richType","richBox"),Array.prototype.forEach.call(t,s=>{e.appendChild(s)}),e}setRangeLastText(){const t=this.richText.childNodes[this.richText.childNodes.length-1],i=t.childNodes[t.childNodes.length-1].children[0].childNodes[0];this.restCursorPos(i,i.textContent==="\uFEFF"?1:i.textContent.length),this.viewIntoPoint()}viewIntoPoint(){const t=window.getSelection();if(t.rangeCount>0){const s=t.getRangeAt(0).getBoundingClientRect(),i=this.richText.parentElement;i.scrollTop=s.top+i.scrollTop-i.clientHeight/2}}}const v=(m=50)=>new Promise(t=>{setTimeout(t,m)}),M=(m,t,e,s)=>{const i=Object.assign(Object.assign({},{precision:"first",continuous:!1,space:"ignore",lastPrecision:"start",insensitive:!0}),s||{});return i.insensitive&&(m=m.toLowerCase(),e=e.toLowerCase()),i.space==="ignore"&&(e=e.replace(/\s/g,"")),O(m,t,e,i)||[]},O=(m,t,e,s)=>{let i=[];for(let r=0;r<m.length;r++){if(s.space==="ignore"&&m[r]===" "){i.push(r);continue}if(m[r]===e[0]){e=e.slice(1),i.push(r);continue}const n=t.split(" ");let o=0;if(n.forEach(a=>{const c=D(a,e);c>o&&(o=c)}),o&&(e=e.slice(o),i.push(r)),!e)break}if(e)return null;if(s.continuous){const r=i;if(i.some((o,a)=>a>0&&o!==r[a-1]+1))return null}return s.space==="ignore"&&(i=i.filter(r=>m[r]!==" ")),i.length?i:null},D=(m,t)=>{let e=0;for(let s=0;s<m.length;s++)m[s]===t[e]&&e++;return e};function R(){const m=navigator.userAgent,t=/(?:Windows Phone)/.test(m),e=/(?:SymbianOS)/.test(m)||t,s=/(?:Android)/.test(m),i=/(?:Firefox)/.test(m),r=/(?:iPad|PlayBook)/.test(m)||s&&!/(?:Mobile)/.test(m)||i&&/(?:Tablet)/.test(m),n=/(?:iPhone)/.test(m)&&!r;return{isTablet:r,isPhone:n,isAndroid:s,isPc:!n&&!s&&!e}}const U=function(m,t,e){return m.forEach(s=>{if(e in s){const i=t.indexOf(String(s[e]));i!==-1&&(t[i]=s)}}),t.filter(s=>s[e])},S=function(m){return Object.prototype.toString.call(m).slice(8,-1)},I=function(m,t){const e=S(m).toLowerCase();switch(S(t)){case"String":return e===t.toLowerCase();case"Array":return t.some(i=>e===i.toLowerCase());default:return!0}};class B{constructor({elm:t,userList:e,placeholder:s,copyType:i,uploadImage:r,needCallEvery:n,callEveryLabel:o,userProps:a,needCallSpace:c,wrapKeyFun:h,sendKeyFun:d,needDialog:p}){u(this,"richText");u(this,"needCallEvery",!0);u(this,"callEveryLabel","所有人");u(this,"needDialog",!0);u(this,"placeholderElm");u(this,"userProps",{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"});u(this,"chat");u(this,"targetUserList",[]);u(this,"userList",[]);u(this,"copyType",["text"]);u(this,"itemShowList",[]);u(this,"checkboxRows",[]);u(this,"base64Images",{});u(this,"uploadImage");u(this,"deviceInfo",R());u(this,"isComposition",!1);u(this,"historyOptionList",[]);u(this,"isExternalCallPopup",!1);u(this,"isIMEModel",!1);u(this,"wrapKeyFun",t=>t.ctrlKey&&["Enter"].includes(t.key));u(this,"sendKeyFun",t=>!t.ctrlKey&&["Enter"].includes(t.key));u(this,"startOpenIndex",0);u(this,"toolUserList");u(this,"dialogElm");u(this,"dialogCheckElm");u(this,"dialogMainElm");u(this,"checkboxElm");u(this,"searchResultElm");u(this,"checkGroupElm");u(this,"searchElm");u(this,"tagsElm");u(this,"dialogActiveItemElm");u(this,"searchEmptyLabel","没有匹配到任何结果");u(this,"checkAllLabel","全选");u(this,"dialogH5Elm");u(this,"dialogH5MainElm");u(this,"dialogH5CheckElm");u(this,"dialogH5ShowElm");u(this,"dialogH5SearchElm");u(this,"winClick",()=>{this.getElmBlock(this.dialogElm)&&this.exitDialog(),this.searchResultElm&&this.domElmShow(this.searchResultElm)});u(this,"winKeydown",async t=>{if(t.ctrlKey&&t.code==="KeyZ"&&t.preventDefault(),!(!this.getElmBlock(this.dialogElm)||this.itemShowList.length===0||this.isComposition)){if(t.code==="ArrowDown"){this.moveActiveItem("down");return}if(t.code==="ArrowUp"){this.moveActiveItem("up");return}if((t.code==="Enter"||t.code==="NumpadEnter")&&this.dialogActiveItemElm){t.preventDefault();const e=this.dialogActiveItemElm.getAttribute("data-set-id")||"";await v(100),this.toolUserList&&this.toolUserList.length>0?await this.chat.searchCall(this.userList.find(s=>s.id===e),this.startOpenIndex):await this.onceSetTag(e==="isALL"?{[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}:this.userList.find(s=>s.id===e)),this.exitDialog()}}});if(!(t instanceof HTMLElement))throw new Error("参数值elm：参数类型错误, 参数类型应为HTMLElement！");["absolute","relative","fixed"].includes(t.style.position)||(t.style.position="relative"),t.className+=` chat-area-${this.deviceInfo.isPc?"pc":"h5"}`,this.richText=document.createElement("div"),this.richText.setAttribute("class","chat-rich-text"),this.richText.setAttribute("data-set-richType","richAllBox"),this.richText.setAttribute("contenteditable","true"),t.appendChild(this.richText),this.placeholderElm=document.createElement("div"),this.placeholderElm.className="chat-placeholder-wrap",this.domElmShow(this.placeholderElm,!0),t.appendChild(this.placeholderElm),this.chat=new H(this.richText),o&&(this.callEveryLabel=o),p!==void 0&&(this.needDialog=String(p)!=="false"),this.needDialog&&(this.deviceInfo.isPc?this.hasPc():this.hasH5()),this.registerEvent(),this.updateConfig({userList:e,placeholder:s,copyType:i,uploadImage:r,needCallEvery:n,needCallSpace:c,userProps:a,wrapKeyFun:h,sendKeyFun:d}),this.historyOptionList=[{html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex}]}registerEvent(){this.richText.addEventListener("click",t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("keyup",t=>{if(!this.needDialog)return;if(t.stopPropagation(),this.deviceInfo.isPc){(t.keyCode===50||t.code==="Digit2"||t.key==="@")&&this.userList.length>0&&this.chat.showAt()&&(this.startOpenIndex=this.chat.cursorIndex,this.showPCDialog());return}const e=t.key==="Unidentified"?"android":"ios";let s=!1;switch(e){case"android":s=t.keyCode===229;break;case"ios":s=t.keyCode===50||t.code==="Digit2"||t.key==="@";break}s&&this.userList.length>0&&this.chat.showAt()&&(this.showH5Dialog(),this.isExternalCallPopup=!1)}),this.richText.addEventListener("keydown",async t=>{if(!this.deviceInfo.isPc&&t.key==="Unidentified"&&t.keyCode===229){t.preventDefault(),this.isIMEModel=!0,this.chat.setIMESelection();return}if(this.isIMEModel)return;if(this.getElmBlock(this.dialogElm)){["ArrowUp","ArrowDown","Enter","NumpadEnter"].includes(t.code)?t.preventDefault():["ArrowLeft","ArrowRight"].includes(t.code)&&this.exitDialog();return}t.code==="Backspace"||t.key==="Backspace"?(this.chat.selectRegionMerge()||this.chat.gridElmMerge()||this.chat.delMarkRule())&&(t.preventDefault(),await this.richTextInput()):this.wrapKeyFun(t)||!this.deviceInfo.isPc&&t.key==="Enter"?(t.preventDefault(),this.chat.setWrap(),await this.richTextInput()):this.sendKeyFun(t)?(t.preventDefault(),await v(100),this.enterSend()):["ArrowLeft","ArrowRight"].includes(t.code)?(t.preventDefault(),this.chat.switchRange(t.code)):t.ctrlKey&&t.code==="KeyA"?this.isEmpty()&&t.preventDefault():t.ctrlKey&&t.code==="KeyZ"&&(t.preventDefault(),this.undo()),["Backspace","Shift","Tab","CapsLock","Control","Meta","Alt","ContextMenu","Enter","NumpadEnter","Escape","ArrowLeft","ArrowUp","ArrowRight","ArrowDown","Home","End","PageUp","PageDown","Insert","Delete","NumLock"].indexOf(t.key)===-1&&!t.ctrlKey&&!t.altKey&&!t.metaKey&&this.chat.selectRegionMerge()}),this.richText.addEventListener("input",async t=>{if(this.isIMEModel){this.isIMEModel=!1,t.inputType==="deleteContentBackward"?(await v(50),this.chat.delMarkRuleIME()):t.inputType==="insertParagraph"?this.chat.wrapIME():this.chat.resetIME(t.data),this.chat.upDataNodeOrIndex(),this.chat.updateGrid(),this.showPlaceholder();return}if(await this.richTextInput(),this.getElmBlock(this.dialogElm)&&!this.isComposition){const e=this.chat.vnode.textContent,s=this.chat.cursorIndex;if(!e||/^([\u200b\ufeff])+$/.test(e)||s<this.startOpenIndex){this.exitDialog();return}const i=e.slice(this.startOpenIndex,s+1),r=String(i||"").replace(/'/g,"");if(!r){this.resizeUserTool(),this.showPCDialog();return}this.toolUserList||(this.toolUserList=this.userList);const n=this.searchUserList(r,this.toolUserList);n.length>0?(this.updateUserList(n,!0),this.showPCDialog()):this.exitDialog()}}),this.richText.addEventListener("copy",t=>{t.preventDefault(),this.copyRange(t)}),this.richText.addEventListener("cut",t=>{t.preventDefault(),this.copyRange(t),this.removeRange()}),this.richText.addEventListener("paste",t=>{t.preventDefault();const e=t.clipboardData.getData("text/plain");if(typeof e=="string"&&e!==""){if(this.copyType.indexOf("text")===-1)return;let s=document.createElement("div");s.innerHTML=t.clipboardData.getData("application/my-custom-format")||"",this.chat.selectRegionMerge(),s.children[0]&&s.children[0].getAttribute("data-set-richType")==="richBox"?this.insertInsideHtml(s.innerHTML):(s.innerHTML=e,this.insertText(s.innerText)),s=null}else{if(this.copyType.indexOf("image")===-1)return;const i=(t.clipboardData||t.originalEvent.clipboardData).items||[];Array.prototype.forEach.call(i,async r=>{if(r.type.indexOf("image")===-1)return;const n=r.getAsFile();if(this.uploadImage){const o=await this.uploadImage(n);this.insertHtml(`<img class="chat-img" src="${o}" alt="" />`)}else{const o=new FileReader;o.onload=a=>{this.insertHtml(`<img class="chat-img" src="${a.target.result}" alt="" />`)},o.readAsDataURL(n)}})}}),this.richText.addEventListener("blur",async t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("focus",t=>{this.chat.upDataNodeOrIndex()}),this.richText.addEventListener("dragstart",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("dragover",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("drop",t=>{t.stopPropagation(),t.preventDefault()}),this.richText.addEventListener("compositionstart",()=>{this.isComposition=!0}),this.richText.addEventListener("compositionend",()=>{this.isComposition=!1})}async richTextInput(t=!0){this.chat.upDataNodeOrIndex(),this.deviceInfo.isPc&&this.chat.selectRegionMerge(),await v(50),this.isComposition||this.chat.updateGrid();const s=(this.richText.children[0]||{childNodes:[]}).childNodes[0];if(!s||!s.getAttribute||s.getAttribute("data-set-richType")!=="richMark"){this.chat.textInnerHtmlInit(!0),this.showPlaceholder();return}if(this.showPlaceholder(),t&&!this.isComposition){const{gridIndex:i,markIndex:r}=this.chat.getRichTextNodeIndex(this.chat.vnode);this.historyOptionList.push({html:this.richText.innerHTML,gridIndex:i,markIndex:r,cursorIndex:this.chat.cursorIndex}),this.historyOptionList.length>50&&this.historyOptionList.shift()}}copyRange(t){const e=window.getSelection();if(e.isCollapsed||e.rangeCount<=0){t.clipboardData.setData("application/my-custom-format",""),t.clipboardData.setData("text/plain","");return}const s=e.toString()||"";let i=document.createElement("div");i.innerHTML=s;const r=i.innerText.replace(/\n\n/g,`
`);i=null,t.clipboardData.setData("text/plain",r);const n=e.anchorNode,o=e.focusNode;if(n===o&&n.nodeType===Node.TEXT_NODE){const l=n.textContent.slice(e.anchorOffset,e.focusOffset);t.clipboardData.setData("application/my-custom-format",l);return}if(n===this.richText&&o===this.richText){t.clipboardData.setData("application/my-custom-format",this.richText.innerHTML);return}const a=this.chat.getWrapNode(n),c=this.chat.getWrapNode(o),h=this.chat.getMarkNode(n),d=this.chat.getMarkNode(o),p=Array.prototype.indexOf.call(a.childNodes,h),g=Array.prototype.indexOf.call(c.childNodes,d);if(a===c&&a.parentNode===this.richText){const l=p>g,f=Array.prototype.filter.call(a.childNodes,(w,C)=>l?C<p&&C>g:C>p&&C<g).map(w=>w.cloneNode(!0)),E=l?n.textContent.slice(0,e.anchorOffset):n.textContent.slice(e.anchorOffset),y=l?o.textContent.slice(e.focusOffset):o.textContent.slice(0,e.focusOffset),N=this.chat.getGridElm(!0),k=this.chat.getGridElm(!0);E&&(N.childNodes[0].innerHTML=E,N.childNodes[0].setAttribute("data-set-empty","false")),y&&(k.childNodes[0].innerHTML=y,k.childNodes[0].setAttribute("data-set-empty","false")),l?(f.unshift(k),f.push(N)):(f.unshift(N),f.push(k));let T=document.createElement("div");const A=this.chat.setWrapNodeByMark(f);T.appendChild(A),t.clipboardData.setData("application/my-custom-format",T.innerHTML),T=null;return}if(a.parentNode===this.richText&&c.parentNode===this.richText){const l=Array.prototype.indexOf.call(this.richText.childNodes,a),f=Array.prototype.indexOf.call(this.richText.childNodes,c),E=l>f,y=Array.prototype.filter.call(this.richText.childNodes,(x,b)=>E?b<l&&b>f:b>l&&b<f).map(x=>x.cloneNode(!0)),N=E?n.textContent.slice(0,e.anchorOffset):n.textContent.slice(e.anchorOffset),k=E?o.textContent.slice(e.focusOffset):o.textContent.slice(0,e.focusOffset),T=this.chat.getGridElm(!0),A=this.chat.getGridElm(!0);N&&(T.childNodes[0].innerHTML=N,T.childNodes[0].setAttribute("data-set-empty","false")),k&&(A.childNodes[0].innerHTML=k,A.childNodes[0].setAttribute("data-set-empty","false"));const w=Array.prototype.filter.call(a.childNodes,(x,b)=>E?b<p:b>p).map(x=>x.cloneNode(!0)),C=Array.prototype.filter.call(c.childNodes,(x,b)=>E?b>g:b<g).map(x=>x.cloneNode(!0));if(E){w.push(T),C.unshift(A);const x=this.chat.setWrapNodeByMark(w),b=this.chat.setWrapNodeByMark(C);y.push(x),y.unshift(b)}else{w.unshift(T),C.push(A);const x=this.chat.setWrapNodeByMark(w),b=this.chat.setWrapNodeByMark(C);y.unshift(x),y.push(b)}let L=document.createElement("div");Array.prototype.forEach.call(y,x=>{L.appendChild(x)}),t.clipboardData.setData("application/my-custom-format",L.innerHTML),L=null;return}}async removeRange(){window.getSelection().getRangeAt(0).deleteContents(),await v(50),this.chat.updateGrid(),this.showPlaceholder()}updateUserList(t=void 0,e){t&&(this.userList=this.getRuleUserList(t)),e||(this.base64Images={}),this.needDialog&&(this.deviceInfo.isPc?this.updatePCUser():this.updateH5User())}getRuleUserList(t){if(!I(t,"Array"))throw new Error("参数值userList：类型值应为Array！");this.targetUserList=JSON.parse(JSON.stringify(t||[]));const e=Object.create(null);return e[this.userProps.id]="isALL",e[this.userProps.name]=this.callEveryLabel,this.targetUserList.unshift(e),(t==null?void 0:t.map((s,i)=>{const r=s[this.userProps.id];if(!r&&r!==0)throw new Error(`参数值userList：下标第${i}项${this.userProps.id}值异常！`);return s.name=String(s[this.userProps.name]||""),s.pinyin=String(s[this.userProps.pinyin]||""),s.id=String(r),s.avatar=String(s[this.userProps.avatar]||""),s}))||[]}getElmBlock(t){return t&&t.style.display==="block"}domElmShow(t,e=!1){t&&(t.className=t.className.replace(/ chat-view-show| chat-view-hidden/g,""),e?(t.style.display="block",t.className+=" chat-view-show"):t.style.display="none")}getUserHtmlTemplate(t,e){const s=document.createElement("span");if(s.setAttribute("class",`call-user-dialog-item-sculpture ${e.avatar?"is-avatar":""}`),e.avatar){const r=new Image;r.alt="";const n=this.base64Images[e.id];n?r.src=n:(r.src=String(e.avatar),r.setAttribute("crossOrigin","Anonymous"),r.onload=()=>{const o=document.createElement("canvas");o.width=48,o.height=48;const a=o.getContext("2d");a&&(a.drawImage(r,0,0,o.width,o.height),this.base64Images[e.id]=o.toDataURL("image/png",1))}),s.appendChild(r)}else s.innerHTML=`<span style="transform: scale(0.75)">${e.name.slice(-2)}</span>`;t.appendChild(s);const i=document.createElement("span");i.setAttribute("class","call-user-dialog-item-name"),i.innerHTML=e.name,t.appendChild(i)}hasPc(){this.initCheckbox(),this.initCallUser(),window.addEventListener("click",this.winClick),window.addEventListener("keydown",this.winKeydown)}initCheckbox(){this.checkboxElm=document.createElement("div"),this.checkboxElm.setAttribute("class","checkbox-dialog"),this.domElmShow(this.checkboxElm),this.checkboxElm.innerHTML=`
      <div class="checkbox-dialog-container">
        <div class="checkbox-dialog-container-header">
            <span>选择要@的人</span>
            <span class="checkbox-dialog-container-header-close">⛌</span>
        </div>
        <div class="checkbox-dialog-container-body">
            <div class="checkbox-dialog-left-box">
                <div class="checkbox-dialog-search">
                    <input class="checkbox-dialog-search-input" placeholder="搜索人员名称" type="text">

                    <div data-set-remark="搜索下拉" class="checkbox-dialog-search-group"></div>
                </div>

                <div data-set-remark="反显选取的人员" class="checkbox-dialog-tags"></div>

                <div class="checkbox-dialog-option">
                    <button class="checkbox-dialog-option-btn btn-submit">确定</button>
                    <button class="checkbox-dialog-option-btn btn-close">取消</button>
                </div>
            </div>
            
            <div class="checkbox-dialog-right-box">
                <div class="checkbox-dialog-right-box-title">研讨成员列表</div>

                <div data-set-remark="多选人员列表" class="checkbox-dialog-check-group"></div>
            </div>
        </div>
      </div>
    `,document.body.appendChild(this.checkboxElm),this.checkGroupElm=this.checkboxElm.querySelector(".checkbox-dialog-check-group"),this.searchResultElm=this.checkboxElm.querySelector(".checkbox-dialog-search-group"),this.searchElm=this.checkboxElm.querySelector(".checkbox-dialog-search-input"),this.tagsElm=this.checkboxElm.querySelector(".checkbox-dialog-tags");const t=()=>{this.domElmShow(this.checkboxElm),this.isExternalCallPopup=!1},e=this.checkboxElm.querySelector(".checkbox-dialog-container-header-close"),s=this.checkboxElm.querySelector(".btn-close");e.onclick=t,s.onclick=t;const i=this.checkboxElm.querySelector(".btn-submit");i.onclick=async()=>{await this.batchSetTag(this.checkboxRows),t(),this.chat.viewIntoPoint(),await this.richTextInput()},this.domElmShow(this.searchResultElm),this.searchResultElm.onclick=r=>{r.stopPropagation()},this.searchElm.onclick=r=>{r.stopPropagation()},this.searchElm.oninput=r=>{this.searchResultElm.innerHTML="";const n=String(r.target.value||"").replace(/'/g,"");if(!n){this.domElmShow(this.searchResultElm);return}const o=this.searchUserList(n),a=document.createDocumentFragment();if(o.forEach(c=>{const h=document.createElement("div");h.setAttribute("class","checkbox-dialog-check-item"),h.setAttribute("data-set-value",c.id);const d=document.createElement("div");d.setAttribute("class","checkbox-dialog-check-item-label"),this.getUserHtmlTemplate(d,c),h.appendChild(d),h.onclick=()=>{this.domElmShow(this.searchResultElm);const p=h.getAttribute("data-set-value")||"";if(this.searchElm.value="",this.checkboxRows.some(l=>l.id===p))return;const g=this.userList.find(l=>l.id===p);g&&this.checkboxRows.push(g),Array.prototype.some.call(this.checkGroupElm.children,(l,f)=>{if(f===0&&this.checkboxRows.length===this.userList.length)return l.className+=" checkbox-dialog-check-item-check",!1;if(l.getAttribute("data-set-value")===p)return l.className+=" checkbox-dialog-check-item-check",!0}),this.updateTags()},a.appendChild(h)}),!o.length){const c=document.createElement("div");c.setAttribute("class","checkbox-dialog-search-empty"),c.innerText=this.searchEmptyLabel,a.appendChild(c)}this.searchResultElm.appendChild(a),this.domElmShow(this.searchResultElm,!0)}}searchUserList(t,e){return(e||this.userList).filter(s=>M(s.name,s.pinyin||"",t).length>0)}updateTags(){const t=this.checkboxRows.map(n=>n.id),e=[],s=[];Array.prototype.forEach.call(this.tagsElm.children,n=>{const o=n.getAttribute("data-set-value");t.indexOf(o)===-1?s.push(n):e.push(o)}),s.forEach(n=>{this.tagsElm.removeChild(n)});const i=this.checkboxRows.filter(n=>e.indexOf(n.id)===-1);if(!i.length)return;const r=document.createDocumentFragment();i.forEach(n=>{const o=document.createElement("div");o.setAttribute("class","checkbox-dialog-tag-item"),o.setAttribute("data-set-value",n.id),o.innerHTML=`
        <span>${n.name}</span>
      `;const a=document.createElement("span");a.setAttribute("class","checkbox-dialog-tag-item-close"),a.innerHTML="⛌",a.onclick=()=>{const c=o.getAttribute("data-set-value");this.checkboxRows=this.checkboxRows.filter(h=>h.id!==c),this.tagsElm.removeChild(o),Array.prototype.some.call(this.checkGroupElm.children,(h,d)=>{if(d===0)return h.className=h.className.replace(/ checkbox-dialog-check-item-check/g,""),!1;if(h.getAttribute("data-set-value")===c)return h.className=h.className.replace(/ checkbox-dialog-check-item-check/g,""),!0})},o.appendChild(a),r.appendChild(o)}),this.tagsElm.appendChild(r)}initCallUser(){this.dialogElm=document.createElement("div"),this.dialogElm.setAttribute("class","call-user-dialog"),this.domElmShow(this.dialogElm);const t=document.createElement("div");t.setAttribute("class","call-user-dialog-header"),t.innerHTML=`
        <span class="call-user-dialog-header-title">群成员</span>
    `,this.dialogCheckElm=document.createElement("span"),this.dialogCheckElm.setAttribute("class","call-user-dialog-header-check"),this.domElmShow(this.dialogCheckElm,this.userList.length>0),this.dialogCheckElm.innerText="多选",this.dialogCheckElm.onclick=()=>{this.showPCCheckDialog(),this.isExternalCallPopup=!1},t.appendChild(this.dialogCheckElm),this.dialogElm.appendChild(t),this.dialogMainElm=document.createElement("div"),this.dialogMainElm.setAttribute("class","call-user-dialog-main"),this.dialogElm.appendChild(this.dialogMainElm),this.updateUserList();const e=document.createElement("div");e.setAttribute("class","call-user-dialog-footer"),this.dialogElm.appendChild(e),document.body.appendChild(this.dialogElm)}resizeUserTool(){this.toolUserList&&(this.userList=this.toolUserList),this.toolUserList=void 0,this.updateUserList(this.userList,!0)}updatePCUser(){this.dialogMainElm.innerHTML="",this.dialogActiveItemElm=void 0;const t=this.userList&&this.userList.length>0,e=document.createDocumentFragment();if(this.domElmShow(this.dialogCheckElm),!this.toolUserList&&t&&(this.domElmShow(this.dialogCheckElm,!0),this.needCallEvery)){const i=document.createElement("div");i.setAttribute("class","call-user-dialog-item"),i.setAttribute("data-set-id","isALL"),this.userSelectStyleAndEvent(i,{[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}),i.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">${this.callEveryLabel}(${this.userList.length})</span>
      `,e.appendChild(i)}this.userList.forEach(i=>{const r=document.createElement("div");r.setAttribute("class","call-user-dialog-item"),r.setAttribute("data-set-id",i.id),this.userSelectStyleAndEvent(r,i),this.getUserHtmlTemplate(r,i),e.appendChild(r)}),this.dialogMainElm.appendChild(e),this.callUserDialogMap(),this.checkGroupElm.innerHTML=`
                    <div class="checkbox-dialog-check-item" data-set-value="ALL">
                        <input type="checkbox" value>
                        <span class="checkbox-dialog-check-item-inner"></span>
                        <div class="checkbox-dialog-check-item-label">${this.checkAllLabel}</div>
                    </div>`;const s=document.createDocumentFragment();this.userList.forEach(i=>{const r=document.createElement("div");r.setAttribute("class","checkbox-dialog-check-item"),r.setAttribute("data-set-value",i.id),r.innerHTML=`
          <input type="checkbox" value>
          <span class="checkbox-dialog-check-item-inner"></span>
      `,this.getUserHtmlTemplate(r,i),s.appendChild(r)}),this.checkGroupElm.appendChild(s),this.checkGroupElm&&this.checkGroupElm.children.length&&Array.prototype.forEach.call(this.checkGroupElm.children,i=>{i.onclick=()=>{const r=i.getAttribute("data-set-value")||"",n=this.userList.find(o=>o.id===r);i.className.indexOf("checkbox-dialog-check-item-check")!==-1?(i.className=i.className.replace(/ checkbox-dialog-check-item-check/g,""),r!=="ALL"&&(this.checkboxRows=this.checkboxRows.filter(o=>o.id!==r))):(i.className+=" checkbox-dialog-check-item-check",r!=="ALL"&&n&&this.checkboxRows.push(n)),r==="ALL"?(Array.prototype.forEach.call(this.checkGroupElm.children,o=>{o.className=i.className}),this.checkboxRows=i.className.indexOf("checkbox-dialog-check-item-check")!==-1?this.userList.map(o=>o):[]):this.checkboxRows.length===this.userList.length?this.checkGroupElm.children[0].className+=" checkbox-dialog-check-item-check":this.checkGroupElm.children[0].className=this.checkGroupElm.children[0].className.replace(/ checkbox-dialog-check-item-check/g,""),this.updateTags()}})}userSelectStyleAndEvent(t,e){t.addEventListener("click",async s=>{s.stopPropagation(),this.upDateActiveItem(t),this.toolUserList&&this.toolUserList.length>0?await this.chat.searchCall(e,this.startOpenIndex):await this.onceSetTag(e),await this.richTextInput(),this.exitDialog()})}callUserDialogMap(){this.itemShowList=[],Array.prototype.forEach.call(this.dialogMainElm.children||[],(t,e)=>{this.itemShowList.push({index:e,elm:t})})}showPCDialog(){this.domElmShow(this.dialogElm,!0);let t="0",e="100%";this.upDateActiveItem(this.dialogMainElm.firstElementChild,!0);const s=this.chat.getRangeRect(),{clientWidth:i,clientHeight:r}=this.dialogElm;s.x>window.innerWidth-i&&(s.x=s.x-i-16,t="100%"),s.y<r&&(s.y=r+s.y,e="0"),this.dialogElm.style.transformOrigin=`${t} ${e}`,this.dialogElm.style.left=s.x+6+"px",this.dialogElm.style.bottom=`calc(100% - ${s.y}px)`,this.dialogElm.style.opacity="1"}showPCCheckDialog(){this.winClick(),this.checkboxRows=[],this.domElmShow(this.checkboxElm,!0),this.tagsElm.scrollTop=0,this.checkGroupElm.scrollTop=0,this.searchElm.value="",Array.prototype.forEach.call(this.checkGroupElm.children,t=>{t.className="checkbox-dialog-check-item"}),this.updateTags(),this.isExternalCallPopup=!0}async showPCPointDialog(){this.insertText("@"),this.startOpenIndex=this.chat.cursorIndex,window.removeEventListener("click",this.winClick),this.showPCDialog(),await v(50),window.addEventListener("click",this.winClick)}moveActiveItem(t){if(!this.dialogActiveItemElm||this.itemShowList.length===0)return;let e=0;const s=this.dialogActiveItemElm.getAttribute("data-set-id");this.itemShowList.some(r=>{const n=r.elm.getAttribute("data-set-id");return e=r.index,s===n});const i=this.itemShowList.map(r=>r.index);if(t==="down"&&e!==this.itemShowList[this.itemShowList.length-1].index){const r=this.itemShowList[i.indexOf(e)+1];r&&this.upDateActiveItem(r.elm,!0)}else if(t==="up"&&e!==this.itemShowList[0].index){const r=this.itemShowList[i.indexOf(e)-1];r&&this.upDateActiveItem(r.elm,!0)}}upDateActiveItem(t,e=!1){this.dialogActiveItemElm&&(this.dialogActiveItemElm.className=this.dialogActiveItemElm.className.replace(/ call-user-dialog-item-active/g,"")),this.dialogActiveItemElm=t,t&&(t.className+=" call-user-dialog-item-active",e&&t.scrollIntoView({block:"center"}))}exitDialog(){this.toolUserList&&this.resizeUserTool(),this.upDateActiveItem(),this.domElmShow(this.dialogElm)}hasH5(){this.dialogH5Elm=document.createElement("div"),this.dialogH5Elm.setAttribute("class","call-user-popup"),this.dialogH5Elm.innerHTML=`
      <div class="call-user-popup-main">
        <div class="call-user-popup-header">
            <span class="popup-show">收起</span>
            <span class="popup-title">选择提醒的人</span>
            <span class="popup-check">确定</span>
        </div>
        
        <div class="call-user-popup-search">
            <svg class="icon-search"
                 style="vertical-align: middle;fill: currentColor;overflow: hidden;"
                 viewBox="0 0 1024 1024" version="1.1"
                 xmlns="http://www.w3.org/2000/svg"
                 p-id="4209">
                <path d="M684.8 223.530667a326.272 326.272 0 0 1 24.96 433.621333c2.645333 2.133333 5.290667 4.48 7.850667 7.04L870.4 817.066667c24.789333 24.746667 32.896 56.832 18.133333 71.594666-14.762667 14.805333-46.848 6.656-71.637333-18.090666l-152.789333-152.832a106.282667 106.282667 0 0 1-7.210667-7.936 326.101333 326.101333 0 0 1-433.109333-25.173334c-127.445333-127.445333-127.573333-333.952-0.256-461.269333 127.36-127.36 333.866667-127.232 461.269333 0.213333zM275.328 275.114667a252.885333 252.885333 0 0 0 0.256 357.632 252.885333 252.885333 0 0 0 357.632 0.256 252.885333 252.885333 0 0 0-0.256-357.632 252.885333 252.885333 0 0 0-357.632-0.256z"
                      fill="#9B9B9B"
                      p-id="4210"></path>
            </svg>
            <input class="call-user-popup-search-input"
                   placeholder="搜索人员名称"
                   type="text">
        </div>
        
        <div class="call-user-popup-body">
        </div>
      </div>
    `;const t=async()=>{this.dialogH5Elm.className=this.dialogH5Elm.className.replace(/ chat-view-show/g," chat-view-hidden"),this.dialogH5SearchElm.value="",await v(260),this.domElmShow(this.dialogH5Elm),this.chat.restCursorPos(this.chat.vnode,this.chat.cursorIndex),this.isExternalCallPopup=!1,this.chat.viewIntoPoint()};this.dialogH5Elm.onclick=t,this.dialogH5Elm.querySelector(".call-user-popup-main").onclick=e=>{e.stopPropagation()},this.dialogH5ShowElm=this.dialogH5Elm.querySelector(".popup-show"),this.dialogH5ShowElm.onclick=t,this.dialogH5CheckElm=this.dialogH5Elm.querySelector(".popup-check"),this.dialogH5CheckElm.onclick=async()=>{const e=this.dialogH5Elm.querySelectorAll(".user-popup-check-item-check")||[];if(e.length===0){await t();return}if(Array.prototype.some.call(e,r=>r.getAttribute("data-set-id")==="isALL")){await this.onceSetTag({[this.userProps.id]:"isALL",[this.userProps.name]:this.callEveryLabel}),await t();return}const s=Array.prototype.map.call(e,r=>r.getAttribute("data-set-id")),i=this.userList.filter(r=>s.includes(r.id));await this.batchSetTag(i),await t(),await this.richTextInput()},this.dialogH5MainElm=this.dialogH5Elm.querySelector(".call-user-popup-body"),this.updateUserList(),this.dialogH5SearchElm=this.dialogH5Elm.querySelector(".call-user-popup-search-input"),this.dialogH5SearchElm.oninput=e=>{const s=String(e.target.value||"").replace(/'/g,"");Array.prototype.forEach.call(this.dialogH5MainElm.children,i=>{if(!s){i.style.display="";return}const r=i.getAttribute("data-set-name")||"",n=i.getAttribute("data-set-pinyin")||"";i.style.display=M(r,n,s).length>0?"":"none"})},this.domElmShow(this.dialogH5Elm),document.body.appendChild(this.dialogH5Elm)}updateH5User(){this.dialogH5MainElm.innerHTML="",this.domElmShow(this.dialogH5CheckElm,this.userList.length>0);const t=this.userList&&this.userList.length>0,e=document.createDocumentFragment(),s=document.createElement("span");if(s.innerHTML=`
        <input type="checkbox" value>
        <span class="user-popup-check-item-inner"></span>
    `,t){const i=document.createElement("div");this.needCallEvery&&(i.setAttribute("class","call-user-popup-item"),i.setAttribute("data-set-id","isALL"),i.innerHTML=`
          <span class="call-user-dialog-item-sculpture">
            <span style="transform: scale(0.75)">@</span>
          </span>
          <span class="call-user-dialog-item-name">${this.callEveryLabel}(${this.userList.length})</span>
      `,i.appendChild(s.cloneNode(!0)),i.onclick=()=>{const r=i.className.indexOf("user-popup-check-item-check")===-1;Array.prototype.forEach.call(this.dialogH5MainElm.children,n=>{r?n.className+=" user-popup-check-item-check":n.className=n.className.replace(/ user-popup-check-item-check/g,"")})},e.appendChild(i)),this.userList.forEach((r,n)=>{const o=document.createElement("div");o.setAttribute("class","call-user-popup-item"),o.setAttribute("data-set-id",r.id),o.setAttribute("data-set-name",r.name),o.setAttribute("data-set-pinyin",r.pinyin||""),this.getUserHtmlTemplate(o,r),o.appendChild(s.cloneNode(!0)),e.appendChild(o),o.onclick=a=>{o.className.indexOf("user-popup-check-item-check")===-1?(o.className+=" user-popup-check-item-check",i.className+=Array.prototype.every.call(this.dialogH5MainElm.children,h=>h.className.indexOf("user-popup-check-item-check")!==-1||h.getAttribute("data-set-id")==="isALL")?" user-popup-check-item-check":""):(o.className=o.className.replace(/ user-popup-check-item-check/g,""),i.className=i.className.replace(/ user-popup-check-item-check/g,""))}})}this.dialogH5MainElm.appendChild(e)}showH5Dialog(){this.richText&&this.richText.blur(),Array.prototype.forEach.call(this.dialogH5MainElm.children,t=>{t.style.display="",t.className=t.className.replace(/ user-popup-check-item-check/g,"")}),this.domElmShow(this.dialogH5Elm,!0),this.dialogH5MainElm.scrollTop=0,this.isExternalCallPopup=!0}updateConfig({copyType:t,userProps:e,userList:s,uploadImage:i,needCallEvery:r,placeholder:n,needCallSpace:o,wrapKeyFun:a,sendKeyFun:c}={}){if(t){if(!I(t,"Array"))throw new Error("参数值copyType：类型值应为Array！");this.copyType=t.map(h=>{if(["text","image"].indexOf(h)===-1)throw new Error(`参数值copyType：无效的参数值"${h}"！`);return h})}if(e){if(!I(e,"Object"))throw new Error("参数值copyType：类型值应为Object！");this.userProps=Object.assign({},{id:"id",name:"name",avatar:"avatar",pinyin:"pinyin"},e)}if(i){if(typeof i!="function")throw new Error("参数值uploadImage：参数类型错误，参数类型应为Function！");this.uploadImage=i}if(n&&(this.placeholderElm.innerText=n),(r!==void 0||s)&&(this.needCallEvery=String(r)!=="false",this.updateUserList(s)),o!==void 0&&this.chat.setCallSpace(o),a){if(typeof a!="function")throw new Error("参数值wrapKeyFun：参数类型错误，参数类型应为Function！");this.wrapKeyFun=a}if(c){if(typeof c!="function")throw new Error("参数值sendKeyFun：参数类型错误，参数类型应为Function！");this.sendKeyFun=c}}enterSend(){}insertHtml(t){const e=document.createElement("span");e.innerHTML=t,e.className="chat-set-html";const s=this.chat.createNewDom(e);return this.chat.replaceRegContent(s),this.chat.viewIntoPoint(),this.richTextInput(),s}insertInsideHtml(t){let e=document.createElement("div");if(e.innerHTML=t,!e.children.length)return;const s=this.chat.vnode,i=this.chat.getWrapNode(s);if(e.children.length===1)this.chat.gridMerge(i,e.children[0],!0);else{this.chat.gridMerge(i,e.children[0],!0);const r=Array.prototype.slice.call(e.children,1);let n=i;Array.prototype.forEach.call(r,(o,a)=>{if(n.parentElement?this.richText.insertBefore(o,n.nextElementSibling):this.richText.appendChild(o),n=o,a===r.length-1){const h=o.childNodes[o.childNodes.length-1].childNodes[0].childNodes[0];this.chat.restCursorPos(h,h.textContent.length)}})}e=null,this.chat.viewIntoPoint(),this.richTextInput()}insertText(t){var c,h;if(!t)return;const e=t.replace(/[\u200b\ufeff]/ig,"");if(!e)return;let s,i=0;const r=this.chat.vnode;r&&r.parentElement&&r.parentElement.getAttribute("data-set-richType")==="richInput"?(s=r.parentElement,i=r.textContent==="\uFEFF"?1:this.chat.cursorLeft):(s=(h=(c=this.richText)==null?void 0:c.lastChild)==null?void 0:h.lastChild,i=s.childNodes[0].textContent.length);const n=(d,p=!1)=>{const g=s.childNodes[0],l=g.textContent.split("");return l.splice(i,0,d),g.textContent=l.join("").replace(/\ufeff/i,()=>(i--,"")),s.setAttribute("data-set-empty","false"),s.childNodes[1]&&s.removeChild(s.childNodes[1]),this.chat.restCursorPos(g,i+d.length),p&&this.chat.viewIntoPoint(),s.parentElement.parentElement},o=(d,p=!1,g)=>{const l=this.chat.getGridElm(),f=l.childNodes[0].childNodes[0];let E=1;return d&&(f.innerHTML=d,f.setAttribute("data-set-empty","false"),E=d.length),g.nextSibling?this.richText.insertBefore(l,g.nextSibling):this.richText.appendChild(l),p&&(this.chat.restCursorPos(f.childNodes[0],E),this.chat.viewIntoPoint()),l},a=e.split(`
`);if(a.length>1){let d;a.forEach((p,g)=>{g===0?d=n(p):d=o(p,g===a.length-1,d)})}else n(e,!0);this.richTextInput()}getCallUserList(){const t=this.richText.querySelectorAll(".at-user");if(t&&t.length>0){const e=Array.prototype.map.call(t,s=>s.dataset.userId);return U(this.targetUserList,e,this.userProps.id)}else return[]}getCallUserTagList(){const t=this.richText.querySelectorAll(".at-user");return t&&t.length>0?Array.prototype.map.call(t,e=>({[this.userProps.id]:e.dataset.userId,[this.userProps.name]:e.innerText.slice(1)})):[]}clear(t){this.chat.textInnerHtmlInit(!0,t),this.historyOptionList=[{html:this.richText.innerHTML,gridIndex:0,markIndex:0,cursorIndex:this.chat.cursorIndex}],this.richTextInput(!1)}isEmpty(t=!1){if((this.richText.querySelectorAll(".chat-tag")||[]).length>0)return!1;const s=new RegExp("^(​|<br>|\uFEFF)+$"),i=this.richText.querySelectorAll(".chat-grid-input")||[];return t?Array.prototype.every.call(i,r=>!r.innerHTML||!r.innerText||!r.innerText.trim()||s.test(r.innerHTML)):Array.prototype.every.call(i,r=>!r.innerHTML||!r.innerText||s.test(r.innerHTML))}showPlaceholder(){this.domElmShow(this.placeholderElm,this.isEmpty())}getReduceNode(t={}){const e=Object.assign({},{needUserId:!1,wrapClassName:void 0,rowClassName:void 0,imgToText:!1},t),i=this.richText.cloneNode(!0).querySelectorAll(".chat-grid-wrap")||[],r=document.createElement("div");return e.wrapClassName&&(r.className=e.wrapClassName),Array.prototype.forEach.call(i,(n,o)=>{const a=n.querySelectorAll(".chat-stat")||[],c=document.createElement("p");e.rowClassName&&(c.className=e.rowClassName),Array.prototype.forEach.call(a,h=>{this.chat.getNodeEmpty(h)||(e.needUserId||h.removeAttribute("data-user-id"),h.removeAttribute("data-set-richType"),h.removeAttribute("contenteditable"),h.removeAttribute("data-set-empty"),e.imgToText&&h.firstChild&&h.firstChild.tagName==="IMG"&&(h.className+=" img-to-text",h.innerHTML=`[${h.firstChild.getAttribute("data-img-text")||"元素data-img-text未定义"}]`),c.appendChild(h))}),c.innerHTML||(c.innerHTML="<br>"),r.appendChild(c)}),r}getText(t={}){return this.getReduceNode(t).innerText}getHtml(t={}){return this.getReduceNode(t).innerHTML}dispose(){const t=this.richText.parentElement;t&&(t.removeChild(this.richText),t.removeChild(this.placeholderElm)),this.needDialog&&(this.deviceInfo.isPc?(document.body.removeChild(this.dialogElm),document.body.removeChild(this.checkboxElm),window.removeEventListener("click",this.winClick),window.removeEventListener("keydown",this.winKeydown)):document.body.removeChild(this.dialogH5Elm));for(const e in this)delete this[e];Object.setPrototypeOf(this,Object)}setUserTag(t){const e=this.chat.createAtUserSpan({id:t[this.userProps.id],name:t[this.userProps.name]});this.chat.replaceRegContent(e,!1),this.chat.viewIntoPoint(),this.richTextInput()}async onceSetTag(t){await this.chat.onceCall({id:t[this.userProps.id],name:t[this.userProps.name]})}async batchSetTag(t){if(t.length===1){this.isExternalCallPopup?await this.chat.onceExternalCall(t[0]):await this.onceSetTag(t[0]);return}let e="";for(let s=0;s<=t.length-1;){const i={id:t[s][this.userProps.id],name:t[s][this.userProps.name]};s===0?e=this.isExternalCallPopup?await this.chat.onceExternalCall(i):await this.chat.onceCall(i,!0):s===t.length-1?await this.chat.onceCall(i,!1,e):await this.chat.onceCall(i,!0),s++}}disabled(){this.richText.setAttribute("contenteditable","false"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,"")+" chat-rich-text-disabled"}enable(){this.richText.setAttribute("contenteditable","true"),this.richText.className=this.richText.className.replace(/ chat-rich-text-disabled/g,""),this.chat.setRangeLastText()}undo(){if(!this.historyOptionList||this.historyOptionList.length<=1)return;const{html:t,gridIndex:e,markIndex:s,cursorIndex:i}=this.historyOptionList[this.historyOptionList.length-2];this.richText.innerHTML=t,this.historyOptionList.pop(),this.richTextInput(!1);const r=this.richText.childNodes[e].childNodes[s].childNodes[0].childNodes[0];this.chat.restCursorPos(r,i),this.chat.viewIntoPoint()}revisePCPointDialogLabel(t={}){const e=Object.assign({},{title:"群成员",checkLabel:"多选"},t);this.dialogElm.querySelector(".call-user-dialog-header-title").innerText=e.title,this.dialogCheckElm.innerText=e.checkLabel}revisePCCheckDialogLabel(t={}){const e=Object.assign({},{title:"选择要@的人",searchPlaceholder:"搜素人员名称",searchEmptyLabel:"没有匹配到任何结果",userTagTitle:"研讨成员列表",checkAllLabel:"全选",confirmLabel:"确定",cancelLabel:"取消"},t);this.checkboxElm.querySelector(".checkbox-dialog-container-header").children[0].innerText=e.title,this.searchElm.setAttribute("placeholder",e.searchPlaceholder||""),this.searchEmptyLabel=e.searchEmptyLabel||"",this.checkboxElm.querySelector(".checkbox-dialog-right-box-title").innerText=e.userTagTitle,this.checkAllLabel=e.checkAllLabel||"",this.checkGroupElm.children[0].children[2].innerText=this.checkAllLabel,this.checkboxElm.querySelector(".btn-submit").innerText=e.confirmLabel,this.checkboxElm.querySelector(".btn-close").innerText=e.cancelLabel}reviseH5DialogLabel(t){const e=Object.assign({},{title:"选择提醒的人",searchPlaceholder:"搜素人员名称",confirmLabel:"确定",cancelLabel:"收起"},t);this.dialogH5Elm.querySelector(".popup-title").innerText=e.title,this.dialogH5SearchElm.setAttribute("placeholder",e.searchPlaceholder||""),this.dialogH5CheckElm.innerText=e.confirmLabel,this.dialogH5ShowElm.innerText=e.cancelLabel}reverseAnalysis(t,e){const s=document.createElement("div");s.innerHTML=t;const i=s.children;Array.prototype.forEach.call(i,r=>{r.className="chat-grid-wrap",r.setAttribute("data-set-richType","richBox");const n=r.children,o={},a=[];Array.prototype.forEach.call(n,(d,p)=>{if(d.className.indexOf("chat-grid-input")!==-1){const f=d.innerText;d.className="",d.setAttribute("data-set-richType","richMark"),d.innerHTML=`<span class="chat-grid-input chat-stat" data-set-richType="richInput" data-set-empty="false">${f}</span>`;return}if(d.tagName==="BR"){const f=this.chat.getGridElm(!0);r.removeChild(d),r.appendChild(f);return}const g=d.cloneNode(!0);g.setAttribute("contenteditable","false");const l=document.createElement("span");l.className="chat-tag",l.setAttribute("contenteditable","false"),l.setAttribute("data-set-richType","chatTag"),l.appendChild(g),o[p]=l,p!==n.length-1?n[p+1].className.indexOf("chat-grid-input")===-1&&a.push(p):a.push(p),p===0&&a.push(-1)});for(const d in o){const p=Number(d);p===n.length-1?(r.removeChild(n[p]),r.appendChild(o[d])):(r.insertBefore(o[d],n[p+1]),r.removeChild(n[p]))}const c=[],h=r.children;a.forEach(d=>{d===h.length-1?c.push("isEnd"):c.push(h[d+1])}),c.forEach(d=>{const p=this.chat.getGridElm(!0);if(d==="isEnd")r.appendChild(p);else{const g=p.children[0];g.removeChild(g.childNodes[1]),r.insertBefore(p,d)}})}),e?(this.enable(),this.insertInsideHtml(s.innerHTML)):(this.richText.innerHTML=s.innerHTML,this.enable(),this.chat.viewIntoPoint(),this.richTextInput())}}if(!window)throw new Error("非web环境！");window.console&&window.console.log&&console.log(" %c ".concat("ChatArea"," %c v4.4.8 "),"background: #269AFF; color: #FFFFFF; padding: 4px 0; border-radius: 4px 0px 0px 4px; font-style: italic;","background: #FFFFFF; color: #269AFF; padding: 2px 0; border-radius: 0px 4px 4px 0px; font-style: italic; border: 2px solid #269AFF;");window.ChatArea=B;
